<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ë—è–∫–æ–•–æ–¥ ‚Äî –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
        }
        body {
            margin: 0;
            padding: 0;
            font-family: Calibri, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100vh;
            cursor: default;
            touch-action: pan-x pan-y;
        }
        #menu-button {
            position: absolute;
            top: calc(10px + var(--safe-area-inset-top));
            left: calc(10px + var(--safe-area-inset-left));
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }
        #menu-button span {
            display: block;
            width: 4px;
            height: 4px;
            background: #333;
            border-radius: 50%;
            margin: 1px 0;
        }
        #left-controls {
            position: absolute;
            top: calc(12px + var(--safe-area-inset-top));
            left: calc(60px + var(--safe-area-inset-left));
            display: flex;
            gap: 4px;
            z-index: 1000;
            align-items: center;
        }
        .control-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            font-size: 20px;
            color: #333;
            padding: 0;
            margin: 0;
            font-weight: bold;
            line-height: 1;
        }
        #search-points-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            font-size: 20px;
            color: #333;
            padding: 0;
            margin: 0;
            font-weight: bold;
            line-height: 1;
        }
        #zoom-level-display {
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            color: #007bff;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                1px 1px 0 white;
            pointer-events: none;
        }
        #dropdown-menu {
            display: none;
            position: absolute;
            top: 55px;
            left: 10px;
            background: #e8e8e8;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 0 12px rgba(0,0,0,0.5);
            z-index: 1000;
            width: fit-content;
            font-size: 13px;
            max-height: 80vh;
            overflow-y: auto;
        }
        #dropdown-menu.active {
            display: block;
        }
        .menu-section {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .menu-label {
            display: block;
            font-weight: bold;
            color: #222;
            margin-bottom: 6px;
        }
        .menu-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            font-size: 14px;
            background: #dcdcdc;
            border: 1px solid #aaa;
            border-radius: 4px;
            cursor: pointer;
            padding: 10px 12px;
            white-space: nowrap;
            width: 100%;
        }
        .menu-btn:hover {
            background: #ccc;
        }
        #status {
            position: absolute;
            bottom: calc(12px + var(--safe-area-inset-bottom));
            left: calc(12px + var(--safe-area-inset-left));
            background: #e8e8e8;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            color: #222;
            z-index: 1000;
            max-width: calc(300px - var(--safe-area-inset-left));
            line-height: 1.4;
            box-shadow: 0 1px 4px rgba(0,0,0,0.25);
        }
        .route-distance {
            color: red;
            font-weight: bold;
        }
        #clear-route-btn {
            position: absolute;
            bottom: calc(70px + var(--safe-area-inset-bottom));
            left: calc(12px + var(--safe-area-inset-left));
            padding: 8px 12px;
            font-size: 14px;
            background: #dcdcdc;
            border: 1px solid #aaa;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 1px 4px rgba(0,0,0,0.25);
            font-weight: bold;
            display: none;
        }
        .map-controls {
            position: absolute;
            top: calc(12px + var(--safe-area-inset-top));
            z-index: 1003;
            align-items: center;
        }
        .right-controls {
            right: calc(12px + var(--safe-area-inset-right));
            display: flex;
            gap: 8px;
        }
        .left-controls {
            left: calc(60px + var(--safe-area-inset-left));
            display: flex;
            gap: 8px;
        }
        .map-controls button {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            font-size: 20px;
            color: #333;
            padding: 0;
            margin: 0;
            font-weight: bold;
            line-height: 1;
        }
        #kp-layer-btn, #kp-layer-btn-google, #danger-layer-btn, #danger-layer-btn-google {
            font-size: 13px !important;
            font-weight: bold !important;
        }
        #all-edges-btn {
            font-size: 16px !important;
        }
        .layer-active {
            background-color: #4CAF50 !important;
            border-color: #388E3C !important;
            color: white !important;
        }
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        #loading-modal {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }
        .custom-dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .custom-dialog {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            font-family: Calibri, Arial, sans-serif;
            max-width: 90%;
            width: 400px;
            z-index: 10001;
        }
        .custom-dialog-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
            color: #222;
        }
        .custom-dialog-message {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
            text-align: center;
        }
        .custom-dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .custom-dialog-button {
            padding: 8px 20px;
            font-size: 14px;
            border: 1px solid #aaa;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            min-width: 80px;
        }
        .custom-dialog-button-ok {
            background: #dcdcdc;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤ –Ω–∏–∂–µ —É–∫–∞–∑–∞—Ç–µ–ª—è */
        .leaflet-popup-tip {
            display: none !important;
        }
        .leaflet-popup-content-wrapper {
            margin-top: 15px !important;
        }
        .leaflet-popup {
            bottom: 0 !important;
            margin-bottom: 15px !important;
        }
        .route-io-section {
            border: 2px solid #007BFF;
            border-radius: 6px;
            padding: 10px;
            background-color: #f0f8ff;
            margin-bottom: 12px;
        }
        .route-save-row,
        .route-load-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }
        .menu-label.inline {
            margin: 0;
            font-weight: bold;
            font-size: 12px;
            white-space: nowrap;
        }
        #route-name,
        #bookmark-name {
            flex: 1;
            min-width: 60px;
            padding: 8px 10px;
            font-size: 12px;
            border: 2px solid #007BFF;
            border-radius: 8px;
            box-sizing: border-box;
            background-color: #fff;
        }
        .menu-btn.icon-only {
            width: 28px;
            height: 28px;
            padding: 0;
            display: flex;
            justify-content: center; 
            align-items: center;     
            font-size: 14px;
            background: #dcdcdc;
            border: 1px solid #aaa;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
        }
        #route-points-popup {
            position: fixed;
            bottom: calc(140px + var(--safe-area-inset-bottom));
            right: calc(12px + var(--safe-area-inset-right));
            background: white;
            padding: 12px;
            border: 2px solid #aaffaa;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            max-height: 30vh;
            overflow-y: auto;
            font-family: Calibri, Arial, sans-serif;
            font-size: 13px;
            z-index: 2000;
            max-width: 200px;
            display: none;
        }
        .route-point-item {
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            margin: 3px 0;
            background-color: #e6f7ff;
            border-left: 3px solid #b3e0ff;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .route-point-item:hover {
            background-color: #d0ebff;
        }
        .direction-indicator {
            font-size: 16px;
            margin-left: 8px;
            width: 20px;
            text-align: center;
        }
        #show-route-points-btn {
            position: absolute;
            bottom: calc(100px + var(--safe-area-inset-bottom));
            right: calc(12px + var(--safe-area-inset-right));
            padding: 8px 12px;
            background: #dcdcdc;
            border: 1px solid #aaa;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            z-index: 1000;
            display: none;
            box-shadow: 0 1px 4px rgba(0,0,0,0.25);
        }
        #add-point-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.8);
            z-index: 10000;
            width: 300px;
            max-width: 90%;
            font-family: Calibri, Arial, sans-serif;
            border: 3px solid #8B008B;
        }
        #add-point-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
        }
        #add-point-popup h3 {
            margin: 0 0 15px;
            text-align: center;
            font-size: 18px;
            color: #8B008B;
            font-weight: bold;
        }
        #add-point-popup label {
            display: block;
            margin-top: 12px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        #add-point-popup input,
        #add-point-popup textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 2px solid #ccc;
            border-radius: 6px;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
            box-sizing: border-box;
        }
        #add-point-popup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        #add-point-popup-buttons button {
            flex: 1;
            padding: 10px;
            font-weight: bold;
            border: 2px solid #aaa;
            border-radius: 6px;
            cursor: pointer;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
        }
        .menu-copyright {
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #aaa;
            width: 100%;
        }
        .menu-copyright a {
            text-decoration: none;
            color: #0066cc;
            font-weight: bold;
            font-size: 12px;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            transition: all 0.2s;
            text-shadow: 
                0 0 2px white,
                0 0 4px white;
            font-weight: 900;
            letter-spacing: 0.5px;
        }
        .menu-copyright a:hover {
            background-color: #dcdcdc;
            color: #004499;
            text-decoration: underline;
        }
        .kp-label-tech, .kp-label-point, .point-label-from-json, .user-point-label, .route-point-label, .danger-point-label {
            font-family: Calibri, Arial, sans-serif !important;
            font-weight: bold !important;
            background: transparent !important;
            border: none !important;
            white-space: nowrap !important;
        }
        .kp-label-tech {
            font-size: 10px !important;
            color: #ff0000 !important;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                1px 1px 0 white !important;
        }
        .kp-label-point {
            font-size: 10px !important;
            color: #004524 !important;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                1px 1px 0 white !important;
        }
        .point-label-from-json {
            font-size: 10px !important;
            color: #5D4037 !important;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                1px 1px 0 white !important;
        }
        .user-point-label {
            font-size: 12px !important;
            color: #8B008B !important;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                2px 2px 0 white !important;
        }
        .danger-point-label {
            font-size: 10px !important;
            color: #d32f2f !important;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                1px 1px 0 white !important;
        }
        .route-point-label-old {
            font-family: Calibri, Arial, sans-serif !important;
            font-size: 11px !important;
            font-weight: bold !important;
            color: #01579b !important;
            background: #e3f2fd !important;
            border: 1px solid #90caf9 !important;
            border-radius: 3px !important;
            padding: 1px 3px !important;
            white-space: nowrap !important;
            z-index: 100 !important;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                1px 1px 0 white !important;
        }
        .route-point-marker {
            stroke: white !important;
            stroke-width: 2px !important;
        }
        .label-hidden {
            display: none !important;
        }
        #points-controls-container {
            position: absolute;
            top: calc(60px + var(--safe-area-inset-top));
            right: calc(12px + var(--safe-area-inset-right));
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            z-index: 1002;
        }
        #points-controls-main {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #points-controls-expanded {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
            margin-right: 8px;
            transition: all 0.3s ease;
            align-items: flex-end;
        }
        #points-controls-expanded.active {
            display: flex;
            animation: slideInDown 0.3s ease;
        }
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .points-control-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            font-size: 20px;
            color: #333;
            padding: 0;
            margin: 0;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s;
        }
        #points-layer-btn.active {
            background-color: #8B008B !important;
            border-color: #6A006A !important;
            color: white !important;
        }
        #add-point-btn {
            background-color: white !important;
            border-color: #ccc !important;
            color: #333 !important;
            display: none;
        }
        #edit-points-btn {
            background-color: white !important;
            border-color: #ccc !important;
            color: #333 !important;
            display: none;
        }
        #cancel-edit-btn {
            background-color: white !important;
            border-color: #ccc !important;
            color: #333 !important;
            display: none;
        }
        #delete-point-btn {
            background-color: white !important;
            border-color: #ccc !important;
            color: #333 !important;
            display: none;
        }
        .user-point-marker.editing {
            animation: pulse 1.5s infinite;
            cursor: pointer;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 152, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
            }
        }
        .user-point-marker.selected {
            animation: selected-pulse 1s infinite;
            box-shadow: 0 0 0 5px rgba(255, 152, 0, 0.7) !important;
        }
        @keyframes selected-pulse {
            0% {
                box-shadow: 0 0 0 5px rgba(255, 152, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(255, 152, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 5px rgba(255, 152, 0, 0.7);
            }
        }
        #edit-point-popup .custom-dialog {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 3px solid #ff9800;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            width: 320px;
            max-width: 90vw;
        }
        #edit-point-popup .custom-dialog-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        #edit-point-popup .custom-dialog-message {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #edit-point-popup label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }
        #edit-point-popup input,
        #edit-point-popup textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        #edit-point-popup input:focus,
        #edit-point-popup textarea:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.2);
        }
        #edit-point-popup input {
            height: 40px;
        }
        #edit-point-popup textarea {
            min-height: 80px;
            resize: vertical;
        }
        #edit-point-popup .custom-dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 20px;
        }
        #edit-point-popup .custom-dialog-button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #edit-point-cancel {
            background: #e0e0e0;
            color: #333;
        }
        #edit-point-delete {
            background: #f44336;
            color: white;
        }
        #edit-point-save {
            background: #4CAF50;
            color: white;
        }
        #search-panel {
            position: absolute;
            top: calc(58px + var(--safe-area-inset-top));
            left: calc(60px + var(--safe-area-inset-left));
            width: 220px;
            display: none;
            z-index: 1003;
            transition: all 0.3s ease;
        }
        #search-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #aaa;
            border-radius: 4px;
            font-size: 14px;
            font-family: Calibri, Arial, sans-serif;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }
        #search-results-panel {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 2px solid #aaa;
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: none;
        }
        .search-result-item-panel {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
            font-family: Calibri, Arial, sans-serif;
            border-bottom: 1px solid #eee;
            -webkit-tap-highlight-color: transparent;
        }
        .search-result-item-panel:hover {
            background-color: #f0f8ff;
        }
        .search-highlight-marker {
            z-index: 10000 !important;
        }
        .search-highlight-marker .leaflet-marker-icon {
            filter: drop-shadow(0 0 8px rgba(0, 102, 204, 0.8));
        }
        .search-halo {
            animation: halo-pulse 2s infinite;
            z-index: 500 !important;
        }
        @keyframes halo-pulse {
            0% {
                opacity: 0.7;
                transform: scale(1);
            }
            50% {
                opacity: 0.9;
                transform: scale(1.1);
            }
            100% {
                opacity: 0.7;
                transform: scale(1);
            }
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç—ã */
        .smooth-pan {
            transition: transform 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∏–Ω–∏—Ö —Ü–∏—Ñ—Ä –≤ –æ–∫–Ω–µ –Ω–∏—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ */
        .route-point-item strong {
            color: #0066cc !important;
            font-weight: bold !important;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–µ–≥–µ–Ω–¥—ã */
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
            font-size: 12px;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 2px;
            border: 1px solid #aaa;
        }
        .tunnel-legend {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 12px;
        }
        .tunnel-legend-title {
            font-weight: bold;
            margin-bottom: 6px;
            color: #333;
            text-align: center;
        }
        /* –°–∫—Ä—ã—Ç–∏–µ –∞—Ç—Ç—Ä–∏–±—É—Ü–∏–∏ Leaflet */
        .leaflet-control-attribution {
            display: none !important;
        }
        
        /* –ò–ó–ú–ï–ù–ï–ù–ò–Ø –î–õ–Ø –ö–ù–û–ü–û–ö –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ú–ê–†–®–†–£–¢–û–ú - –ü–ï–†–ï–ú–ï–©–ï–ù–´ –í–ü–†–ê–í–û */
        
        /* –ë–∞–∑–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–¥–ª—è –∫–∞—Ä—Ç byaki.png –∏ map2.png) */
        #basic-map-controls {
            position: absolute;
            top: calc(12px + var(--safe-area-inset-top));
            right: calc(12px + var(--safe-area-inset-right));
            display: none;
            flex-direction: row;
            gap: 8px;
            z-index: 1003;
            align-items: center;
        }

        #basic-map-controls-2 {
            position: absolute;
            top: calc(70px + var(--safe-area-inset-top));
            right: calc(12px + var(--safe-area-inset-right));
            display: none;
            flex-direction: row;
            gap: 8px;
            z-index: 1003;
            align-items: center;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è Google –∫–∞—Ä—Ç */
        #google-map-controls {
            position: absolute;
            top: calc(12px + var(--safe-area-inset-top));
            right: calc(12px + var(--safe-area-inset-right));
            display: none;
            flex-direction: row;
            gap: 8px;
            z-index: 1003;
            align-items: center;
        }

        #google-map-controls-2 {
            position: absolute;
            top: calc(70px + var(--safe-area-inset-top));
            right: calc(12px + var(--safe-area-inset-right));
            display: none;
            flex-direction: row;
            gap: 8px;
            z-index: 1003;
            align-items: center;
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        #basic-map-controls button,
        #basic-map-controls-2 button,
        #google-map-controls button,
        #google-map-controls-2 button {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            font-size: 20px;
            color: #333;
            padding: 0;
            margin: 0;
            font-weight: bold;
            line-height: 1;
        }

        #kp-layer-btn, #kp-layer-btn-google, #danger-layer-btn, #danger-layer-btn-google {
            font-size: 13px !important;
            font-weight: bold !important;
        }

        #all-edges-btn {
            font-size: 16px !important;
        }
    </style>
</head>
<body>
    <div id="menu-button" title="–ú–µ–Ω—é">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div id="left-controls">
        <button class="control-btn" id="zoom-in" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
        <button class="control-btn" id="zoom-out" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
        <div id="zoom-level-display">0</div>
        <button id="search-points-btn" title="–ü–æ–∏—Å–∫ —Ç–æ—á–µ–∫">üîç</button>
    </div>
    
    <div id="search-panel">
        <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ—á–µ–∫...">
        <div id="search-results-panel"></div>
    </div>
    
    <!-- –ë–∞–∑–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–¥–ª—è –∫–∞—Ä—Ç byaki.png –∏ map2.png) - –ü–ï–†–ï–ú–ï–©–ï–ù–´ –í–ü–†–ê–í–û -->
    <div id="basic-map-controls" style="display: none;">
        <button id="lock-btn" title="–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞">üîì</button>
        <button id="kp-layer-btn" title="–ö–ü —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π 2025 –≥.">–ö–ü 2025</button>
        <button id="danger-layer-btn" title="–û–ø–∞—Å–Ω—ã–µ –º–µ—Å—Ç–∞">üö∑</button>
    </div>

    <div id="basic-map-controls-2" style="display: none;">
        <button id="undo-btn" style="display: none;" title="–®–∞–≥ –Ω–∞–∑–∞–¥">‚Ü©Ô∏è</button>
    </div>

    <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è Google –∫–∞—Ä—Ç - –ü–ï–†–ï–ú–ï–©–ï–ù–´ –í–ü–†–ê–í–û -->
    <div id="google-map-controls" style="display: none;">
        <button id="lock-btn-google" title="–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞">üîì</button>
        <button id="kp-layer-btn-google" title="–ö–ü —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π 2025 –≥.">–ö–ü 2025</button>
        <button id="danger-layer-btn-google" title="–û–ø–∞—Å–Ω—ã–µ –º–µ—Å—Ç–∞">üö∑</button>
        <button id="all-edges-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏ –∏ —Ä–µ–±—Ä–∞">üìç</button>
    </div>

    <div id="google-map-controls-2" style="display: none;">
        <button id="undo-btn-google" style="display: none;" title="–®–∞–≥ –Ω–∞–∑–∞–¥">‚Ü©Ô∏è</button>
    </div>
    
    <div id="points-controls-container">
        <div id="points-controls-main">
            <button id="points-layer-btn" class="points-control-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –º–µ—Ç–∫–∏">üìå</button>
        </div>
        <div id="points-controls-expanded">
            <button id="add-point-btn" class="points-control-btn" title="–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É">‚ûï</button>
            <button id="edit-points-btn" class="points-control-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∫–∏">‚úèÔ∏è</button>
            <button id="cancel-edit-btn" class="points-control-btn" title="–í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">‚ùå</button>
            <button id="delete-point-btn" class="points-control-btn" title="–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–µ—Ç–∫—É">üóëÔ∏è</button>
        </div>
    </div>
    
    <div id="dropdown-menu">
        <div class="menu-section">
            <span class="menu-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É:</span>
            <select id="background-select">
                <option value="byaki.png">–ë–∞–∑–æ–≤–∞—è –∫–∞—Ä—Ç–∞</option>
                <option value="map2.png">–ö–∞—Ä—Ç–∞ —Å –∑–∞–ª–∏–≤–∫–æ–π</option>
                <option value="google-satellite">Google Satellite</option>
            </select>
        </div>
        
        <div class="menu-section route-io-section">
            <div style="text-align: center; font-weight: bold; margin-bottom: 8px; font-size: 13px;">–ú–∞—Ä—à—Ä—É—Ç</div>
            <div class="route-save-row">
                <span class="menu-label inline">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å:</span>
                <input type="text" id="route-name" placeholder="–ò–º—è –º–∞—Ä—à—Ä—É—Ç–∞">
                <button class="menu-btn icon-only" id="save-route" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –≤ —Ñ–∞–π–ª">üíæ</button>
            </div>
            <div class="route-load-row">
                <span class="menu-label inline">–ó–∞–≥—Ä—É–∑–∏—Ç—å:</span>
                <button class="menu-btn icon-only" id="load-route" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –∏–∑ —Ñ–∞–π–ª–∞">üìÅ</button>
                <input type="file" id="route-file-input" accept=".json" style="display: none;">
            </div>
        </div>
        
        <div class="menu-section route-io-section">
            <div style="text-align: center; font-weight: bold; margin-bottom: 8px; font-size: 13px;">–ú–µ—Ç–∫–∏</div>
            <div class="route-save-row">
                <span class="menu-label inline">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å:</span>
                <input type="text" id="bookmark-name" placeholder="–ò–º—è –º–µ—Ç–æ–∫">
                <button class="menu-btn icon-only" id="save-bookmark" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∫–∏ –≤ —Ñ–∞–π–ª">üíæ</button>
            </div>
            <div class="route-load-row">
                <span class="menu-label inline">–ó–∞–≥—Ä—É–∑–∏—Ç—å:</span>
                <button class="menu-btn icon-only" id="load-bookmark" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ç–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞">üìÅ</button>
                <input type="file" id="bookmark-file-input" accept=".geojson" style="display: none;">
            </div>
        </div>
        
        <!-- –î–û–ë–ê–í–õ–ï–ù –ë–õ–û–ö –°–¢–ê–¢–ò–°–¢–ò–ö–ò -->
        <div class="menu-section route-io-section">
            <div style="text-align: center; font-weight: bold; margin-bottom: 8px; font-size: 13px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            <div style="
                font-size: 12px;
                padding: 8px;
                background: white;
                border-radius: 4px;
                border: 1px solid #ddd;
                text-align: center;
                line-height: 1.4;
                margin: 6px 0;
            ">
                –ü–æ—Å—á–∏—Ç–∞–Ω–Ω–∞—è –ø—Ä–æ—Ç—è–∂–µ–Ω–Ω–æ—Å—Ç—å –≤—Å–µ—Ö —à—Ç—Ä–µ–∫–æ–≤:<br>
                <span id="total-tunnel-length" style="
                    font-weight: bold;
                    color: #007bff;
                    font-size: 13px;
                ">–∑–∞–≥—Ä—É–∑–∫–∞...</span> –º–µ—Ç—Ä–æ–≤
            </div>
        </div>
        
        <div class="menu-section">
            <button class="menu-btn" id="show-disclaimer">‚ÑπÔ∏è –û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</button>
        </div>
        <div class="menu-copyright">
            <a href="https://t.me/Aleks_Donor" target="_blank" rel="noopener noreferrer">
                ¬© by Alex Donor
            </a>
        </div>
    </div>
    
    <button id="clear-route-btn" title="–£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –º–∞—Ä—à—Ä—É—Ç">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
    <button id="show-route-points-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –Ω–∏—Ç–∫—É –º–∞—Ä—à—Ä—É—Ç–∞">üìç</button>
    
    <div id="route-points-popup">
        <div style="font-weight: bold; margin-bottom: 8px; text-align: center;">
            <div style="font-size: 13px;">–ù–∏—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞</div>
            <div style="font-size: 11px; font-weight: normal; margin-top: -2px;">
                (—Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–∫–∞–∑–∞–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–µ–≤–µ—Ä–∞)
            </div>
        </div>
        <div id="route-points-list"></div>
    </div>
    
    <div id="map"></div>
    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    
    <div id="loading-overlay">
        <div id="loading-modal">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ‚Ä¶<br>–ú–∞—Ä—à—Ä—É—Ç —Å—Ç—Ä–æ–∏—Ç—Å—è</div>
    </div>
    
    <div id="add-point-overlay"></div>
    <div id="add-point-popup">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –º–µ—Ç–∫—É</h3>
        <label for="point-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" id="point-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
        <label for="point-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea id="point-comment" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" rows="3"></textarea>
        <div id="add-point-popup-buttons">
            <button id="add-point-cancel">–û—Ç–º–µ–Ω–∞</button>
            <button id="add-point-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div id="edit-point-overlay" class="custom-dialog-overlay">
        <div id="edit-point-popup" class="custom-dialog" style="width: 300px;">
            <div class="custom-dialog-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∫—É</div>
            <div class="custom-dialog-message">
                <label for="edit-point-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" id="edit-point-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                <label for="edit-point-comment" style="margin-top: 10px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="edit-point-comment" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" rows="3"></textarea>
            </div>
            <div class="custom-dialog-buttons">
                <button id="edit-point-cancel" class="custom-dialog-button">–û—Ç–º–µ–Ω–∞</button>
                <button id="edit-point-delete" class="custom-dialog-button" style="background: #f44336; color: white;">–£–¥–∞–ª–∏—Ç—å</button>
                <button id="edit-point-save" class="custom-dialog-button" style="background: #4CAF50; color: white;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div id="custom-alert-overlay" class="custom-dialog-overlay">
        <div class="custom-dialog">
            <div class="custom-dialog-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div class="custom-dialog-message" id="custom-alert-message"></div>
            <div class="custom-dialog-buttons">
                <button id="custom-alert-ok" class="custom-dialog-button custom-dialog-button-ok">OK</button>
            </div>
        </div>
    </div>
    
    <div id="disclaimer-overlay" class="custom-dialog-overlay">
        <div style="
            background: white;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        ">
            <h3 style="margin-top: 0; margin-bottom: 15px; color: #222; text-align: center;">–û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</h3>
            <div style="text-align: justify;">
                <p style="margin-top: 0; margin-bottom: 12px;">–ù–∞—Å—Ç–æ—è—â–µ–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ (–¥–∞–ª–µ–µ ‚Äî –ü—Ä–æ–¥—É–∫—Ç) —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –∏ —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö –∏ –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–∞–∫–æ–π-–ª–∏–±–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏–ª–∏ –Ω–µ–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å –ø—Ä–µ–±—ã–≤–∞–Ω–∏–µ–º –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Ä–∞–±–æ—Ç –ø–æ–¥ –∑–µ–º–ª—ë–π, –≤–∫–ª—é—á–∞—è, –Ω–æ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—è—Å—å: —Å–ø–µ–ª–µ–æ–ª–æ–≥–∏–µ–π, –ø–æ–¥–∑–µ–º–Ω—ã–º —Ç—É—Ä–∏–∑–º–æ–º, –≥–æ—Ä–Ω—ã–º–∏, —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–º–∏, –∞–≤–∞—Ä–∏–π–Ω–æ-—Å–ø–∞—Å–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∏ –∏–Ω—ã–º–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º–∏ –≤–∏–¥–∞–º–∏ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.</p>
                <p style="margin-top: 0; margin-bottom: 12px;">–ê–≤—Ç–æ—Ä –ü—Ä–æ–¥—É–∫—Ç–∞ –Ω–µ –¥–∞—ë—Ç –Ω–∏–∫–∞–∫–∏—Ö –≥–∞—Ä–∞–Ω—Ç–∏–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–æ—á–Ω–æ—Å—Ç–∏, –ø–æ–ª–Ω–æ—Ç—ã, –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –∏–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤, –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∏–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–æ—Å—è—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏.</p>
                <p style="margin-top: 0; margin-bottom: 12px;">–ê–≤—Ç–æ—Ä –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ª—é–±–æ–π —É—â–µ—Ä–±, —É–±—ã—Ç–∫–∏, —Ç—Ä–∞–≤–º—ã –∏–ª–∏ –∏–Ω—ã–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è, –≤–æ–∑–Ω–∏–∫—à–∏–µ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ü—Ä–æ–¥—É–∫—Ç–∞, –≤ —Ç–æ–º —á–∏—Å–ª–µ –ø—Ä–∏ –µ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –≤ —É—Å–ª–æ–≤–∏—è—Ö, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —Ä–∏—Å–∫–æ–º –¥–ª—è –∂–∏–∑–Ω–∏ –∏ –∑–¥–æ—Ä–æ–≤—å—è.</p>
                <p style="margin-top: 0; margin-bottom: 12px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ü—Ä–æ–¥—É–∫—Ç –Ω–∞ —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ –∏ –æ—Å–æ–∑–Ω–∞—ë—Ç, —á—Ç–æ –æ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∏–ª–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏–ª–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∑–µ–º–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤.</p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="close-disclaimer" style="
                    padding: 8px 20px;
                    font-size: 14px;
                    background: #dcdcdc;
                    border: 1px solid #aaa;
                    border-radius: 5px;
                    cursor: pointer;
                    font-weight: bold;
                    min-width: 100px;
                ">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 4,
            zoomControl: false,
            tap: false,
            touchZoom: true,
            scrollWheelZoom: true,
            dragging: true,
            wheelPxPerZoomLevel: 60,
            attributionControl: false // –û—Ç–∫–ª—é—á–∞–µ–º –∞—Ç—Ç—Ä–∏–±—É—Ü–∏—é
        });
        
        const SCALE_CORRECTION = 84 / 145.9;
        const ENTRANCE_COORDS_EPSG3857 = [4252305.4, 7245838.4];
        const REQUIRED_FILES = [
            'tunnels_json.geojson',
            'kp_2025.geojson', 
            'points_json.geojson',
            'danger_points.geojson',
            'byaki.png',
            'map2.png'
        ];
        
        let currentImageOverlay = null, googleSatelliteLayer = null;
        let currentMapType = 'byaki.png', entranceMarker = null, routeLocked = false;
        let menuOpen = false, isUserPointsMode = false, isEditMode = false;
        let pendingPointCoords = null, selectedPointIndex = null;
        let kpLayer = null, kpLayerVisible = false;
        let userPointsLayer = null, userPointsLayerVisible = false;
        let jsonPointsLayer = null, jsonPointsLayerVisible = false;
        let dangerLayer = null, dangerLayerVisible = false;
        let allEdgesLayer = null, allEdgesLayerVisible = false; // –ù–æ–≤—ã–π —Å–ª–æ–π –¥–ª—è –≤—Å–µ—Ö —Ä–µ–±–µ—Ä
        let segments = [], graph = {}, segmentWeights = {};
        let selectedPoints = [], pointMarkers = [], routeLayer = null;
        let routePointMarkers = [], routeLabelMarkers = [];
        let mapBounds = null, fullRoutePath = [], allPointsGeoJson = null;
        let userPointsData = { type: "FeatureCollection", features: [] };
        let userPointMarkers = [], userPointLabels = [];
        let searchPanelVisible = false, searchHighlightMarker = null, searchHaloMarker = null;
        let lastSearchQuery = '';

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function updateZoomDisplay() {
            document.getElementById('zoom-level-display').textContent = Math.round(map.getZoom());
        }
        
        function showCustomAlert(message) {
            const overlay = document.getElementById('custom-alert-overlay');
            document.getElementById('custom-alert-message').textContent = message;
            overlay.style.display = 'flex';
            document.getElementById('custom-alert-ok').onclick = () => overlay.style.display = 'none';
            overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
        }
        
        function hideLoadingOverlay() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        function showLoadingOverlay(message = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ‚Ä¶<br>–ú–∞—Ä—à—Ä—É—Ç —Å—Ç—Ä–æ–∏—Ç—Å—è") {
            document.getElementById('loading-modal').innerHTML = message;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        
        function wgs84ToEpsg3857(lat, lng) {
            const R = 6378137;
            const x = (lng * Math.PI / 180) * R;
            const y = Math.log(Math.tan((90 + lat) * Math.PI / 360)) * R;
            return [x, y];
        }
        
        function epsg3857ToWgs84(x, y) {
            const R = 6378137;
            const lng = (x / R) * (180 / Math.PI);
            const lat = (Math.PI / 2 - 2 * Math.atan(Math.exp(-y / R))) * (180 / Math.PI);
            return [lat, lng];
        }
        
        function addEntranceMarker() {
            if (entranceMarker) map.removeLayer(entranceMarker);
            
            let latlng;
            if (currentMapType === 'google-satellite') {
                const [x, y] = ENTRANCE_COORDS_EPSG3857;
                latlng = epsg3857ToWgs84(x, y);
            } else {
                latlng = [ENTRANCE_COORDS_EPSG3857[1], ENTRANCE_COORDS_EPSG3857[0]];
            }
            
            entranceMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'entrance-marker-large',
                    html: '<span style="font-size: 30px">‚õî</span>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map).bindPopup("–í—Ö–æ–¥ –≤ –ì—É—Ä—å–µ–≤—Å–∫–∏–µ –∫–∞–º–µ–Ω–æ–ª–æ–º–Ω–∏");
        }
        
        function updateControlsVisibility() {
            const isGoogle = currentMapType === 'google-satellite';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –±–ª–æ–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if (isGoogle) {
                document.getElementById('google-map-controls').style.display = 'flex';
                document.getElementById('google-map-controls-2').style.display = 'flex';
                document.getElementById('basic-map-controls').style.display = 'none';
                document.getElementById('basic-map-controls-2').style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                document.getElementById('kp-layer-btn-google').classList.toggle('layer-active', kpLayerVisible);
                document.getElementById('danger-layer-btn-google').classList.toggle('layer-active', dangerLayerVisible);
                document.getElementById('all-edges-btn').classList.toggle('layer-active', allEdgesLayerVisible);
                document.getElementById('lock-btn-google').textContent = routeLocked ? 'üîí' : 'üîì';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ undo
                document.getElementById('undo-btn-google').style.display = selectedPoints.length > 0 ? 'flex' : 'none';
            } else {
                document.getElementById('basic-map-controls').style.display = 'flex';
                document.getElementById('basic-map-controls-2').style.display = 'flex';
                document.getElementById('google-map-controls').style.display = 'none';
                document.getElementById('google-map-controls-2').style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                document.getElementById('kp-layer-btn').classList.toggle('layer-active', kpLayerVisible);
                document.getElementById('danger-layer-btn').classList.toggle('layer-active', dangerLayerVisible);
                document.getElementById('lock-btn').textContent = routeLocked ? 'üîí' : 'üîì';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ undo
                document.getElementById('undo-btn').style.display = selectedPoints.length > 0 ? 'flex' : 'none';
            }
        }
        
        function updateMarkersVisibilityForCurrentMap() {
            const zoom = map.getZoom();
            const isGoogle = currentMapType === 'google-satellite';
            const showLabels = isGoogle ? zoom >= 17 : true;
            
            [kpLayer, jsonPointsLayer, userPointsLayer, dangerLayer, allEdgesLayer].forEach((layer, idx) => {
                if (layer) {
                    layer.eachLayer(l => {
                        const element = l.getElement ? l.getElement() : null;
                        if (element && element.classList.contains('leaflet-marker-icon')) {
                            element.style.display = showLabels ? '' : 'none';
                        }
                    });
                }
            });
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ====================
        async function loadGeoJsonFile(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${filename}:`, error);
                return { type: "FeatureCollection", features: [] };
            }
        }
        
        // ==================== –†–ê–°–ß–ï–¢ –û–ë–©–ï–ô –î–õ–ò–ù–´ –®–¢–†–ï–ö–û–í ====================
        async function calculateTotalTunnelLength() {
            try {
                const data = await loadGeoJsonFile('tunnels_json.geojson');
                if (!data || data.type !== "FeatureCollection" || !Array.isArray(data.features)) {
                    document.getElementById('total-tunnel-length').textContent = '–æ—à–∏–±–∫–∞';
                    return;
                }
                
                let totalLength = 0;
                
                data.features.forEach(f => {
                    if (!f.geometry) return;
                    
                    let lines = [];
                    if (f.geometry.type === 'LineString') {
                        lines = [f.geometry.coordinates];
                    } else if (f.geometry.type === 'MultiLineString') {
                        lines = f.geometry.coordinates;
                    } else {
                        return;
                    }
                    
                    lines.forEach(coords => {
                        if (!Array.isArray(coords) || coords.length < 2) return;
                        
                        for (let i = 0; i < coords.length - 1; i++) {
                            const a = coords[i];
                            const b = coords[i + 1];
                            
                            if (!Array.isArray(a) || !Array.isArray(b) || a.length < 2 || b.length < 2) continue;
                            
                            const dx = a[0] - b[0];
                            const dy = a[1] - b[1];
                            const segmentLength = Math.sqrt(dx * dx + dy * dy);
                            totalLength += segmentLength;
                        }
                    });
                });
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–ø—Ä–∞–≤–æ—á–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∞
                const correctedLength = totalLength * SCALE_CORRECTION;
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á
                const formattedLength = Math.round(correctedLength).toLocaleString('ru-RU');
                document.getElementById('total-tunnel-length').textContent = formattedLength;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –¥–ª–∏–Ω—ã —à—Ç—Ä–µ–∫–æ–≤:', error);
                document.getElementById('total-tunnel-length').textContent = '–æ—à–∏–±–∫–∞';
            }
        }
        
        // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–°–ß–ï–¢–ê –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ô ====================
        function calculateSegmentDirection(start, end) {
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö (0-360)
            const dx = end[0] - start[0];
            const dy = end[1] - start[1];
            let angle = Math.atan2(dy, dx) * (180 / Math.PI);
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É–≥–æ–ª –æ—Ç 0 –¥–æ 360
            if (angle < 0) angle += 360;
            
            return angle;
        }
        
        function getDirectionArrow(angle) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–≥–ª–∞ (0¬∞ = –≤–æ—Å—Ç–æ–∫, 90¬∞ = —Å–µ–≤–µ—Ä, 180¬∞ = –∑–∞–ø–∞–¥, 270¬∞ = —é–≥)
            if (angle >= 337.5 || angle < 22.5) return '‚Üí'; // –í–ø—Ä–∞–≤–æ (–≤–æ—Å—Ç–æ–∫)
            if (angle >= 22.5 && angle < 67.5) return '‚Üó'; // –í–ø—Ä–∞–≤–æ-–≤–≤–µ—Ä—Ö (—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫)
            if (angle >= 67.5 && angle < 112.5) return '‚Üë'; // –í–≤–µ—Ä—Ö (—Å–µ–≤–µ—Ä)
            if (angle >= 112.5 && angle < 157.5) return '‚Üñ'; // –í–ª–µ–≤–æ-–≤–≤–µ—Ä—Ö (—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥)
            if (angle >= 157.5 && angle < 202.5) return '‚Üê'; // –í–ª–µ–≤–æ (–∑–∞–ø–∞–¥)
            if (angle >= 202.5 && angle < 247.5) return '‚Üô'; // –í–ª–µ–≤–æ‚Äì–≤–Ω–∏–∑ (—é–≥–æ-–∑–∞–ø–∞–¥)
            if (angle >= 247.5 && angle < 292.5) return '‚Üì'; // –í–Ω–∏–∑ (—é–≥)
            if (angle >= 292.5 && angle < 337.5) return '‚Üò'; // –í–ø—Ä–∞–≤–æ-–≤–Ω–∏–∑ (—é–≥–æ-–≤–æ—Å—Ç–æ–∫)
            return '‚Üí';
        }
        
        // ==================== –ù–ê–•–û–ñ–î–ï–ù–ò–ï –¢–û–ß–ï–ö –í–ë–õ–ò–ó–ò –ú–ê–†–®–†–£–¢–ê (–° –ü–†–û–í–ï–†–ö–û–ô –î–£–ë–õ–ï–ô) ====================
        function findPointsNearRoute(routeCoords, pointsGeoJson, maxDistance = 2.5) {
            if (!pointsGeoJson || !pointsGeoJson.features) return [];
            
            const nearbyPoints = [];
            const visitedPointKeys = new Set();
            
            function getPointKey(coords) {
                return `${coords[0].toFixed(3)},${coords[1].toFixed(3)}`;
            }
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å–µ–≥–º–µ–Ω—Ç–∞–º –º–∞—Ä—à—Ä—É—Ç–∞ –∏ –Ω–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫–∏ –≤ –ø–æ—Ä—è–¥–∫–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
            for (let segmentIndex = 0; segmentIndex < routeCoords.length - 1; segmentIndex++) {
                const a = routeCoords[segmentIndex];
                const b = routeCoords[segmentIndex + 1];
                
                // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Ç–æ—á–∫–∏
                pointsGeoJson.features.forEach(feature => {
                    if (feature.geometry.type !== "Point") return;
                    
                    const pt = feature.geometry.coordinates;
                    const name = feature.properties?.Name;
                    
                    if (name == null || !Array.isArray(pt) || pt.length < 2) return;
                    
                    const pointKey = getPointKey(pt);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ –¥–æ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
                    const distanceToSegment = pointToSegmentDistance(pt, a, b);
                    
                    if (distanceToSegment <= maxDistance) {
                        // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ–µ–∫—Ü–∏—é —Ç–æ—á–∫–∏ –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç
                        const t = getProjectionFactor(pt, a, b);
                        
                        // –ü–æ–∑–∏—Ü–∏—è —Ç–æ—á–∫–∏ –≤–¥–æ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞
                        const positionAlongRoute = segmentIndex + Math.max(0, Math.min(1, t));
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —ç—Ç–∞ —Ç–æ—á–∫–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ —ç—Ç–æ–º —É—á–∞—Å—Ç–∫–µ –º–∞—Ä—à—Ä—É—Ç–∞
                        // –ï—Å–ª–∏ —Ç–æ—á–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä—è–¥–æ–º —Å –∫–æ–Ω—Ü–æ–º —Å–µ–≥–º–µ–Ω—Ç–∞, –æ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ —Å–ª–µ–¥—É—é—â–∏–º —Å–µ–≥–º–µ–Ω—Ç–æ–º
                        if (t < 0.9 || segmentIndex === routeCoords.length - 2) {
                            // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á —Å —É—á–µ—Ç–æ–º –ø–æ–∑–∏—Ü–∏–∏ –≤–¥–æ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞
                            const routeKey = `${pointKey}_${positionAlongRoute.toFixed(2)}`;
                            
                            if (!visitedPointKeys.has(routeKey)) {
                                // –ù–∞—Ö–æ–¥–∏–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ
                                let directionSegment = getDirectionSegmentForPoint(pt, routeCoords, segmentIndex);
                                
                                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å–µ–≥–º–µ–Ω—Ç –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π
                                if (!directionSegment) {
                                    directionSegment = {
                                        start: a,
                                        end: b,
                                        direction: calculateSegmentDirection(a, b)
                                    };
                                }
                                
                                nearbyPoints.push({
                                    name,
                                    coords: pt,
                                    directionAngle: directionSegment.direction,
                                    segmentIndex: segmentIndex,
                                    t: t,
                                    positionAlongRoute: positionAlongRoute,
                                    distanceToSegment: distanceToSegment,
                                    pointKey: pointKey
                                });
                                
                                visitedPointKeys.add(routeKey);
                            }
                        }
                    }
                });
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ —Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
            nearbyPoints.sort((a, b) => {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É —Å–µ–≥–º–µ–Ω—Ç–∞
                if (a.segmentIndex !== b.segmentIndex) {
                    return a.segmentIndex - b.segmentIndex;
                }
                // –ï—Å–ª–∏ –Ω–∞ –æ–¥–Ω–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ - –ø–æ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç–µ
                return a.t - b.t;
            });
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Ç–æ—á–∫–∏ (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–¥—Ä—è–¥)
            const filteredPoints = [];
            
            for (let i = 0; i < nearbyPoints.length; i++) {
                const currentPoint = nearbyPoints[i];
                
                // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –µ–µ
                if (i === 0) {
                    filteredPoints.push(currentPoint);
                    continue;
                }
                
                const previousPoint = nearbyPoints[i - 1];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∞—è —Ç–æ—á–∫–∞ –¥—É–±–ª–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–π
                if (!isSamePoint(currentPoint.coords, previousPoint.coords, 0.001)) {
                    filteredPoints.push(currentPoint);
                }
                // –ï—Å–ª–∏ —Ç–æ—á–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ–∫—É—â—É—é (–Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º)
            }
            
            return filteredPoints.map(p => ({
                name: p.name,
                coords: p.coords,
                directionAngle: p.directionAngle
            }));
        }

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function isSamePoint(coords1, coords2, tolerance = 0.001) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–≤–ø–∞–¥–∞—é—Ç –ª–∏ –¥–≤–µ —Ç–æ—á–∫–∏ —Å –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
            if (!coords1 || !coords2) return false;
            
            const dx = Math.abs(coords1[0] - coords2[0]);
            const dy = Math.abs(coords1[1] - coords2[1]);
            
            return dx < tolerance && dy < tolerance;
        }

        function pointToSegmentDistance(p, a, b) {
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ p –¥–æ –æ—Ç—Ä–µ–∑–∫–∞ ab
            const dx = b[0] - a[0];
            const dy = b[1] - a[1];
            const l2 = dx * dx + dy * dy;
            
            if (l2 === 0) {
                // –ï—Å–ª–∏ a –∏ b —Å–æ–≤–ø–∞–¥–∞—é—Ç
                return Math.hypot(p[0] - a[0], p[1] - a[1]);
            }
            
            const t = Math.max(0, Math.min(1, ((p[0] - a[0]) * dx + (p[1] - a[1]) * dy) / l2));
            const projX = a[0] + t * dx;
            const projY = a[1] + t * dy;
            
            return Math.hypot(p[0] - projX, p[1] - projY);
        }

        function getProjectionFactor(p, a, b) {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä t ‚àà [0,1] –ø—Ä–æ–µ–∫—Ü–∏–∏ —Ç–æ—á–∫–∏ p –Ω–∞ –æ—Ç—Ä–µ–∑–æ–∫ ab
            const dx = b[0] - a[0];
            const dy = b[1] - a[1];
            const l2 = dx * dx + dy * dy;
            
            if (l2 === 0) return 0;
            
            return ((p[0] - a[0]) * dx + (p[1] - a[1]) * dy) / l2;
        }

        function getDirectionSegmentForPoint(pointCoords, routeCoords, currentSegmentIndex) {
            // –ù–∞—Ö–æ–¥–∏—Ç —Å–µ–≥–º–µ–Ω—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è –≤ —Ç–æ—á–∫–µ
            // –ò—â–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∑–Ω–∞—á–∏–º—ã–π —Å–µ–≥–º–µ–Ω—Ç (–Ω–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π)
            const maxLookAhead = Math.min(3, routeCoords.length - currentSegmentIndex - 2);
            
            for (let i = 0; i <= maxLookAhead; i++) {
                const idx = currentSegmentIndex + i;
                if (idx >= routeCoords.length - 1) break;
                
                const start = routeCoords[idx];
                const end = routeCoords[idx + 1];
                const length = Math.hypot(end[0] - start[0], end[1] - start[1]);
                
                if (length > 0.1) { // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã
                    return {
                        start: start,
                        end: end,
                        direction: calculateSegmentDirection(start, end)
                    };
                }
            }
            
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∑–Ω–∞—á–∏–º—ã–π —Å–µ–≥–º–µ–Ω—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π
            if (currentSegmentIndex < routeCoords.length - 1) {
                const start = routeCoords[currentSegmentIndex];
                const end = routeCoords[currentSegmentIndex + 1];
                return {
                    start: start,
                    end: end,
                    direction: calculateSegmentDirection(start, end)
                };
            }
            
            return null;
        }
        
        async function loadTunnelsData() {
            const data = await loadGeoJsonFile('tunnels_json.geojson');
            if (!data || data.type !== "FeatureCollection" || !Array.isArray(data.features)) return;
            
            const allCoords = [];
            segments = [];
            graph = {};
            segmentWeights = {};
            
            data.features.forEach(f => {
                if (!f.geometry) return;
                let lines = [];
                if (f.geometry.type === 'LineString') lines = [f.geometry.coordinates];
                else if (f.geometry.type === 'MultiLineString') lines = f.geometry.coordinates;
                else return;
                
                let weight = f.properties?.weight || 5;
                lines.forEach(coords => {
                    if (!Array.isArray(coords) || coords.length < 2) return;
                    coords.forEach(pt => Array.isArray(pt) && pt.length >= 2 && allCoords.push(pt));
                    
                    for (let i = 0; i < coords.length - 1; i++) {
                        const a = coords[i], b = coords[i + 1];
                        if (!Array.isArray(a) || !Array.isArray(b) || a.length < 2 || b.length < 2) continue;
                        
                        segments.push([a, b]);
                        const keyA = a.join(','), keyB = b.join(',');
                        const baseLength = Math.hypot(a[0] - b[0], a[1] - b[1]);
                        let cost;
                        if (weight === 1) cost = baseLength * 1000;
                        else if (weight === 2) cost = baseLength * 4;
                        else if (weight === 3) cost = baseLength * 1.5;
                        else if (weight === 4) cost = baseLength * 5;
                        else cost = baseLength;
                        
                        if (!graph[keyA]) graph[keyA] = {};
                        if (!graph[keyB]) graph[keyB] = {};
                        if (!graph[keyA][keyB] || cost < graph[keyA][keyB]) {
                            graph[keyA][keyB] = graph[keyB][keyA] = cost;
                            const segmentKey = `${keyA}-${keyB}`;
                            segmentWeights[segmentKey] = segmentWeights[`${keyB}-${keyA}`] = weight;
                        }
                    }
                });
            });
            
            if (allCoords.length > 0) {
                const xs = allCoords.map(c => c[0]), ys = allCoords.map(c => c[1]);
                const minX = Math.min(...xs), minY = Math.min(...ys);
                const maxX = Math.max(...xs), maxY = Math.max(...ys);
                mapBounds = [[minY, minX], [maxY, maxX]];
            } else {
                mapBounds = [[0, 0], [1000, 1000]];
            }
        }
        
        // ==================== –ê–õ–ì–û–†–ò–¢–ú A* ====================
        class PriorityQueue {
            constructor() {
                this.heap = [];
                this.nodeMap = new Map();
            }
        
            push(node, priority) {
                const item = { node, priority };
                this.heap.push(item);
                this.nodeMap.set(node, this.heap.length - 1);
                this._siftUp(this.heap.length - 1);
            }
        
            pop() {
                if (this.heap.length === 0) return null;
                if (this.heap.length === 1) {
                    const item = this.heap.pop();
                    this.nodeMap.delete(item.node);
                    return item.node;
                }
        
                const top = this.heap[0];
                const last = this.heap.pop();
                this.heap[0] = last;
                this.nodeMap.set(last.node, 0);
                this.nodeMap.delete(top.node);
                this._siftDown(0);
                return top.node;
            }
        
            isEmpty() {
                return this.heap.length === 0;
            }
        
            _siftUp(index) {
                while (index > 0) {
                    const parent = Math.floor((index - 1) / 2);
                    if (this.heap[parent].priority <= this.heap[index].priority) break;
                    this._swap(parent, index);
                    index = parent;
                }
            }
        
            _siftDown(index) {
                const n = this.heap.length;
                while (true) {
                    let left = 2 * index + 1;
                    let right = 2 * index + 2;
                    let smallest = index;
        
                    if (left < n && this.heap[left].priority < this.heap[smallest].priority) smallest = left;
                    if (right < n && this.heap[right].priority < this.heap[smallest].priority) smallest = right;
                    if (smallest === index) break;
        
                    this._swap(index, smallest);
                    index = smallest;
                }
            }
        
            _swap(i, j) {
                [this.heap[i], this.heap[j]] = [this.heap[j], this.heap[i]];
                this.nodeMap.set(this.heap[i].node, i);
                this.nodeMap.set(this.heap[j].node, j);
            }
        }
        
        function heuristic(a, b) {
            const [ax, ay] = a.split(',').map(Number);
            const [bx, by] = b.split(',').map(Number);
            return Math.sqrt(Math.pow(bx - ax, 2) + Math.pow(by - ay, 2));
        }
        
        function aStar(graph, start, end) {
            if (start === end) return [start.split(',').map(Number)];
            if (!graph[start] || !graph[end]) return null;
        
            const openSet = new PriorityQueue();
            const cameFrom = new Map();
            const gScore = new Map();
            const fScore = new Map();
        
            gScore.set(start, 0);
            fScore.set(start, heuristic(start, end));
            openSet.push(start, fScore.get(start));
        
            while (!openSet.isEmpty()) {
                const current = openSet.pop();
        
                if (current === end) {
                    const path = [];
                    let node = current;
                    while (node) {
                        path.unshift(node.split(',').map(Number));
                        node = cameFrom.get(node);
                    }
                    return path;
                }
        
                for (const neighbor in graph[current]) {
                    const tentativeGScore = gScore.get(current) + graph[current][neighbor];
        
                    if (!gScore.has(neighbor) || tentativeGScore < gScore.get(neighbor)) {
                        cameFrom.set(neighbor, current);
                        gScore.set(neighbor, tentativeGScore);
                        fScore.set(neighbor, tentativeGScore + heuristic(neighbor, end));
                        openSet.push(neighbor, fScore.get(neighbor));
                    }
                }
            }
        
            return null;
        }
        
        // ==================== –†–ê–ë–û–¢–ê –° –ú–ê–†–®–†–£–¢–û–ú ====================
        function calculateRealDistance(coord1, coord2) {
            const dx = coord1[0] - coord2[0];
            const dy = coord1[1] - coord2[1];
            return Math.sqrt(dx * dx + dy * dy) * SCALE_CORRECTION;
        }
        
        function getColorForSegment(start, end) {
            const segmentKey = `${start.join(',')}-${end.join(',')}`;
            const reverseKey = `${end.join(',')}-${start.join(',')}`;
            const weight = segmentWeights[segmentKey] || segmentWeights[reverseKey];
            
            const colors = {
                1: '#000000',      // –ó–∞–≤–∞–ª
                2: '#ff0000',      // –®–∫—É—Ä–æ–¥–µ—Ä
                3: '#ffa500',      // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ
                4: '#0000ff',      // –í–æ–¥–∞
                default: '#00ff00' // –°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥
            };
            return colors[weight] || colors.default;
        }
        
        function buildFullRoute() {
            if (selectedPoints.length < 2) {
                showCustomAlert('–î–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏');
                return;
            }
            
            if (Object.keys(graph).length === 0) {
                showCustomAlert('–ì—Ä–∞—Ñ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª tunnels_json.geojson');
                return;
            }
        
            showLoadingOverlay();
        
            setTimeout(() => {
                try {
                    if (routeLayer) map.removeLayer(routeLayer);
                    routeLayer = null;
                    
                    routePointMarkers.forEach(marker => map.removeLayer(marker));
                    routeLabelMarkers.forEach(marker => map.removeLayer(marker));
                    routePointMarkers = [];
                    routeLabelMarkers = [];
            
                    fullRoutePath = [];
                    const routeGroup = L.featureGroup();
                    let totalDistance = 0;
            
                    for (let i = 0; i < selectedPoints.length - 1; i++) {
                        const start = selectedPoints[i], end = selectedPoints[i + 1];
                        const startKey = start.join(','), endKey = end.join(',');
            
                        const segmentPath = aStar(graph, startKey, endKey);
            
                        if (!segmentPath) {
                            showCustomAlert(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø—É—Ç—å –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ ${i+1} –∏ ${i+2}`);
                            hideLoadingOverlay();
                            return;
                        }
            
                        fullRoutePath.push(...(i === 0 ? segmentPath : segmentPath.slice(1)));
            
                        for (let j = 1; j < segmentPath.length; j++) {
                            const a = segmentPath[j - 1], b = segmentPath[j];
                            totalDistance += calculateRealDistance(a, b);
            
                            if (currentMapType !== 'google-satellite') {
                                L.polyline([[a[1], a[0]], [b[1], b[0]]], {
                                    color: getColorForSegment(a, b),
                                    weight: 6,
                                    opacity: 0.8
                                }).addTo(routeGroup);
                            }
                        }
                    }
            
                    if (currentMapType !== 'google-satellite') {
                        routeLayer = routeGroup.addTo(map);
                        document.getElementById('status').innerHTML = 
                            `–ú–∞—Ä—à—Ä—É—Ç: <span class="route-distance">${totalDistance.toFixed(1)} –º</span>`;
                        
                        addRoutePointLabels();
                        addRouteJsonPointLabels();
                    }
                    
                    updateRoutePointsList();
                    updateRouteButtonsVisibility();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                    showCustomAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.');
                    
                    if (selectedPoints.length > 0) {
                        document.getElementById('status').textContent = 
                            `–í—ã–±—Ä–∞–Ω–æ ${selectedPoints.length} —Ç–æ—á–µ–∫. –û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è.`;
                    }
                } finally {
                    hideLoadingOverlay();
                    // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–¢–ö–†–´–¢–ò–ï –û–ö–ù–ê "–ù–ò–¢–ö–ê –ú–ê–†–®–†–£–¢–ê"
                    setTimeout(() => {
                        if (fullRoutePath.length > 0 && allPointsGeoJson) {
                            const nearbyPoints = findPointsNearRoute(fullRoutePath, allPointsGeoJson, 2.5);
                            if (nearbyPoints.length > 0) {
                                document.getElementById('route-points-popup').style.display = 'block';
                                document.getElementById('show-route-points-btn').textContent = 'üëÅÔ∏è';
                                document.getElementById('show-route-points-btn').style.display = 'block';
                            }
                        }
                    }, 500);
                }
            }, 10);
        }
        
        function addRoutePointLabels() {
            routeLabelMarkers.forEach(marker => map.removeLayer(marker));
            routeLabelMarkers = [];
            
            selectedPoints.forEach((pt, idx) => {
                const latlng = [pt[1], pt[0]];
                const labelText = idx === 0 ? '–°–¢–ê–†–¢' : idx === selectedPoints.length - 1 ? '–§–ò–ù–ò–®' : String(idx);
                
                // –î–ª—è —Å—Ç–∞—Ä—Ç–∞ –∏ —Ñ–∏–Ω–∏—à–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥—Ä—É–≥–æ–π —è–∫–æ—Ä—å, —á—Ç–æ–±—ã –Ω–∞–¥–ø–∏—Å—å –±—ã–ª–∞ –≤—ã—à–µ –∏ –±–ª–∏–∂–µ
                let iconAnchor;
                if (idx === 0 || idx === selectedPoints.length - 1) {
                    // –î–ª—è —Å—Ç–∞—Ä—Ç–∞ –∏ —Ñ–∏–Ω–∏—à–∞ - –Ω–∞–¥–ø–∏—Å—å –ø—Ä—è–º–æ –Ω–∞–¥ —Ç–æ—á–∫–æ–π
                    iconAnchor = [5, 25];
                } else {
                    // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–æ—á–µ–∫ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ
                    iconAnchor = [10, 22];
                }
                
                const label = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'route-point-label',
                        html: `<div style="
                            background: linear-gradient(135deg, #ff9800, #ffb74d);
                            border: 2px solid #0d47a1;
                            border-radius: 4px;
                            padding: 2px 6px;
                            color: #0d47a1;
                            font-weight: bold;
                            font-size: 12px;
                            white-space: nowrap;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                            transform: translateY(-8px);
                        ">${labelText}</div>`,
                        iconSize: null,
                        iconAnchor: iconAnchor
                    }),
                    interactive: false,
                    zIndexOffset: 1000
                }).addTo(map);
                
                routeLabelMarkers.push(label);
                updatePointMarkerStyle(idx);
            });
        }
        
        function updatePointMarkerStyle(idx) {
            if (pointMarkers[idx]) {
                const fillColor = idx === 0 ? 'green' : idx === pointMarkers.length - 1 ? 'blue' : 'red';
                pointMarkers[idx].setStyle({ 
                    color: 'white',
                    fillColor: fillColor,
                    weight: 2,
                    className: 'route-point-marker'
                });
            }
        }
        
        function addRouteJsonPointLabels() {
            if (!allPointsGeoJson || currentMapType === 'google-satellite') return;
            
            const nearbyPoints = findPointsNearRoute(fullRoutePath, allPointsGeoJson, 2.5);
            
            nearbyPoints.forEach(point => {
                const latlng = [point.coords[1], point.coords[0]];
                
                const hasRouteLabel = routeLabelMarkers.some(label => {
                    const labelLatLng = label.getLatLng();
                    return Math.abs(labelLatLng.lat - latlng[0]) < 0.0001 && 
                           Math.abs(labelLatLng.lng - latlng[1]) < 0.0001;
                });
                
                if (hasRouteLabel) return;
                
                const marker = L.circleMarker(latlng, {
                    radius: 5,
                    color: '#0000FF',
                    fillColor: '#33FFEE',
                    weight: 2,
                    fillOpacity: 2
                }).addTo(map);
                routePointMarkers.push(marker);
                
                const label = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'route-point-label-old',
                        html: point.name.length > 15 ? point.name.substring(0, 12) + '...' : point.name,
                        iconSize: null,
                        iconAnchor: [0, -10]
                    }),
                    interactive: false,
                    pane: 'markerPane'
                }).addTo(map);
                
                if (label.getElement()) label.getElement().style.zIndex = '100';
                routeLabelMarkers.push(label);
            });
        }
        
        function updateLabelVisibility() {
            const zoom = map.getZoom();
            const hide = zoom < 0;
            
            routeLabelMarkers.forEach(label => {
                const element = label.getElement();
                if (element && element.classList.contains('route-point-label-old')) {
                    element.classList.toggle('label-hidden', hide);
                }
            });
            
            updateMarkersVisibilityForCurrentMap();
        }
        
        // ==================== –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–ü–ò–°–ö–ê –¢–û–ß–ï–ö ====================
        function updateRoutePointsList() {
            if (!allPointsGeoJson || fullRoutePath.length === 0) {
                document.getElementById('show-route-points-btn').style.display = 'none';
                document.getElementById('route-points-popup').style.display = 'none';
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫–∏, –±–ª–∏–∑–∫–∏–µ –∫ –º–∞—Ä—à—Ä—É—Ç—É
            const nearbyPoints = findPointsNearRoute(fullRoutePath, allPointsGeoJson, 2.5);
            
            if (nearbyPoints.length > 0) {
                const listHtml = nearbyPoints.map((p, idx) => {
                    const displayName = p.name.length > 15 ? p.name.substring(0, 12) + '...' : p.name;
                    const directionArrow = getDirectionArrow(p.directionAngle);
                    
                    return `<div class="route-point-item" data-index="${idx}" data-lng="${p.coords[0]}" data-lat="${p.coords[1]}" data-name="${p.name}">
                        <span><strong>${idx + 1}.</strong> ${displayName}</span>
                        <span class="direction-indicator" title="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏">${directionArrow}</span>
                    </div>`;
                }).join('');
                
                document.getElementById('route-points-list').innerHTML = listHtml;
                document.getElementById('show-route-points-btn').style.display = 'block';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–æ—á–µ–∫
                const titleElement = document.querySelector('#route-points-popup > div:first-child');
                if (titleElement) {
                    const originalTitle = titleElement.innerHTML;
                    titleElement.innerHTML = `<div style="font-size: 13px;">–ù–∏—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ (${nearbyPoints.length} —Ç–æ—á–µ–∫)</div>
                                             <div style="font-size: 11px; font-weight: normal; margin-top: -2px;">
                                                 (—Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–∫–∞–∑–∞–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–µ–≤–µ—Ä–∞)
                                             </div>`;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
                document.querySelectorAll('.route-point-item').forEach((item, idx) => {
                    item.addEventListener('click', (e) => {
                        const el = e.target.closest('.route-point-item');
                        if (!el) return;
                        const lng = parseFloat(el.getAttribute('data-lng'));
                        const lat = parseFloat(el.getAttribute('data-lat'));
                        const name = el.getAttribute('data-name');
                        
                        if (isNaN(lng) || isNaN(lat)) return;
                        
                        let latlng;
                        if (currentMapType === 'google-satellite') {
                            latlng = epsg3857ToWgs84(lng, lat);
                        } else {
                            latlng = [lat, lng];
                        }
                        
                        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                        clearSearchHighlight();
                        
                        // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–æ—á–∫–µ
                        map.flyTo(latlng, 3, {
                            duration: 1.5,
                            easeLinearity: 0.25
                        });
                        
                        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
                        setTimeout(() => {
                            // –°–æ–∑–¥–∞–µ–º –æ—Ä–∞–Ω–∂–µ–≤—ã–π –æ—Ä–µ–æ–ª
                            const highlightMarker = L.circleMarker(latlng, {
                                radius: 15,
                                color: '#FF9800',
                                fillColor: 'rgba(255, 152, 0, 0.3)',
                                weight: 3,
                                fillOpacity: 0.5,
                                className: 'search-halo',
                                pane: 'markerPane',
                                zIndexOffset: 500
                            }).addTo(map);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º popup —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç–æ—á–∫–∏ –∏ –ø–æ—Ä—è–¥–∫–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º
                            const popupMarker = L.marker(latlng, {
                                icon: L.divIcon({
                                    className: 'search-highlight-marker',
                                    html: '<div style="background-color: #FF9800; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(255, 152, 0, 0.8);"></div>',
                                    iconSize: [20, 20],
                                    iconAnchor: [10, 10]
                                }),
                                zIndexOffset: 1000
                            }).bindPopup(`<b>${idx + 1}. ${name}</b><br>–ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –≤ –º–∞—Ä—à—Ä—É—Ç–µ: ${idx + 1}`).openPopup().addTo(map);
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä—ã
                            if (!window.highlightMarkers) window.highlightMarkers = [];
                            window.highlightMarkers.push(highlightMarker, popupMarker);
                            
                            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                            setTimeout(() => {
                                clearSearchHighlight();
                            }, 10000);
                        }, 1500);
                    });
                });
            } else {
                document.getElementById('show-route-points-btn').style.display = 'none';
                document.getElementById('route-points-popup').style.display = 'none';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        function clearSearchHighlight() {
            if (window.highlightMarkers) {
                window.highlightMarkers.forEach(marker => {
                    if (marker && map.hasLayer(marker)) {
                        if (marker.closePopup) marker.closePopup();
                        map.removeLayer(marker);
                    }
                });
                window.highlightMarkers = [];
            }
        }
        
        function toggleRoutePointsPopup() {
            const popup = document.getElementById('route-points-popup');
            const btn = document.getElementById('show-route-points-btn');
            
            if (popup.style.display === 'block') {
                popup.style.display = 'none';
                btn.textContent = 'üìç';
            } else {
                popup.style.display = 'block';
                btn.textContent = 'üëÅÔ∏è';
            }
        }
        
        function clearRoute() {
            if (routeLayer) map.removeLayer(routeLayer);
            pointMarkers.forEach(marker => map.removeLayer(marker));
            routePointMarkers.forEach(marker => map.removeLayer(marker));
            routeLabelMarkers.forEach(marker => map.removeLayer(marker));
        
            routeLayer = null;
            selectedPoints = [];
            pointMarkers = [];
            routePointMarkers = [];
            routeLabelMarkers = [];
            fullRoutePath = [];
            routeLocked = false;
        
            document.getElementById('lock-btn').textContent = 'üîì';
            document.getElementById('lock-btn-google').textContent = 'üîì';
            
            document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞';
            document.getElementById('clear-route-btn').style.display = 'none';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ "–ù–∏—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞"
            document.getElementById('route-points-popup').style.display = 'none';
            document.getElementById('show-route-points-btn').style.display = 'none';
            document.getElementById('show-route-points-btn').textContent = 'üìç';
            
            updateRouteButtonsVisibility();
        }
        
        function handleMapClick(e) {
            if (isEditMode) {
                handleEditModeClick(e);
                return;
            }
            
            if (isUserPointsMode) {
                let coords;
                if (currentMapType === 'google-satellite') {
                    coords = wgs84ToEpsg3857(e.latlng.lat, e.latlng.lng);
                } else {
                    coords = [e.latlng.lng, e.latlng.lat];
                }
                pendingPointCoords = coords;
                showAddPointPopup();
                return;
            }
            
            if (menuOpen || segments.length === 0 || routeLocked) return;
            
            const click = [e.latlng.lng, e.latlng.lat];
            const TOLERANCE = 4;
            let nearest = null;
            let minDist = Infinity;
            
            for (const node in graph) {
                const [x, y] = node.split(',').map(Number);
                const d = Math.hypot(x - click[0], y - click[1]);
                if (d < minDist) {
                    minDist = d;
                    nearest = [x, y];
                }
            }
            
            if (!nearest || minDist > TOLERANCE) {
                document.getElementById('status').textContent = '–ö–ª–∏–∫ —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –æ—Ç —Ç–æ–Ω–Ω–µ–ª–µ–π';
                return;
            }

            selectedPoints.push(nearest);
            const pointNumber = selectedPoints.length;
            
            const marker = L.circle([nearest[1], nearest[0]], {
                radius: 3,
                color: 'white',
                fillColor: pointNumber === 1 ? 'green' : pointNumber === selectedPoints.length ? 'blue' : 'red',
                weight: 2,
                fillOpacity: 1,
                className: 'route-point-marker'
            }).addTo(map);
            
            pointMarkers.push(marker);
            
            if (selectedPoints.length === 1) {
                document.getElementById('status').textContent = '–í—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é.';
            } else {
                buildFullRoute();
            }
            
            document.getElementById('clear-route-btn').style.display = 'block';
            updateRouteButtonsVisibility();
        }
        
        function handleEditModeClick(e) {
            console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            
            // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –º–µ—Ç–∫—É
            let minDist = Infinity;
            let nearestIndex = -1;
            
            userPointMarkers.forEach((marker, index) => {
                const markerLatLng = marker.getLatLng();
                const dist = e.latlng.distanceTo(markerLatLng);
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–¥–∏—É—Å –∫–ª–∏–∫–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ (100 –ø–∏–∫—Å–µ–ª–µ–π)
                if (dist < minDist && dist < 100) {
                    minDist = dist;
                    nearestIndex = index;
                }
            });
            
            if (nearestIndex !== -1) {
                console.log('–ù–∞–π–¥–µ–Ω–∞ –º–µ—Ç–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', nearestIndex);
                selectPointForEditing(nearestIndex);
                showEditPointPopup(nearestIndex);
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
                if (e.originalEvent) {
                    e.originalEvent.stopPropagation();
                    e.originalEvent.preventDefault();
                }
            }
        }
        
        function updateRoutePointStyles() {
            pointMarkers.forEach((m, idx) => {
                let fillColor;
                if (idx === 0) fillColor = 'green';
                else if (idx === pointMarkers.length - 1) fillColor = 'blue';
                else fillColor = 'red';
                m.setStyle({ 
                    color: 'white',
                    fillColor: fillColor,
                    weight: 2,
                    className: 'route-point-marker'
                });
            });
            
            if (selectedPoints.length > 1) buildFullRoute();
        }
        
        function onZoomEnd() {
            updateZoomDisplay();
            updateLabelVisibility();
        }
        
        function undoLastPoint() {
            if (selectedPoints.length === 0) return;
            
            selectedPoints.pop();
            const lastMarker = pointMarkers.pop();
            if (lastMarker) map.removeLayer(lastMarker);
            
            if (selectedPoints.length === 0) {
                clearRoute();
            } else if (selectedPoints.length === 1) {
                if (routeLayer) map.removeLayer(routeLayer);
                routeLayer = null;
                routePointMarkers.forEach(marker => map.removeLayer(marker));
                routeLabelMarkers.forEach(marker => map.removeLayer(marker));
                routePointMarkers = [];
                routeLabelMarkers = [];
                document.getElementById('status').textContent = '–í—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é.';
                document.getElementById('show-route-points-btn').style.display = 'none';
                document.getElementById('route-points-popup').style.display = 'none';
            } else {
                buildFullRoute();
            }
            updateRouteButtonsVisibility();
        }
        
        function updateRouteButtonsVisibility() {
            const clearBtn = document.getElementById('clear-route-btn');
            const showBtn = selectedPoints.length > 0;
            
            clearBtn.style.display = showBtn ? 'block' : 'none';
            
            const isGoogle = currentMapType === 'google-satellite';
            document.getElementById(isGoogle ? 'undo-btn-google' : 'undo-btn').style.display = showBtn ? 'flex' : 'none';
        }
        
        // ==================== –°–õ–û–ô –ö–ü 2025 ====================
        async function toggleKPLayer() {
            const isGoogle = currentMapType === 'google-satellite';
            const btn = document.getElementById(isGoogle ? 'kp-layer-btn-google' : 'kp-layer-btn');
            
            if (!kpLayerVisible) {
                showLoadingOverlay("–ó–∞–≥—Ä—É–∑–∫–∞ –ö–ü 2025...");
                
                try {
                    const data = await loadGeoJsonFile('kp_2025.geojson');
                    
                    if (kpLayer) map.removeLayer(kpLayer);
                    kpLayer = L.layerGroup();
                    
                    data.features.forEach(feature => {
                        if (feature.geometry.type !== 'Point') return;
                        const coords = feature.geometry.coordinates;
                        const name = feature.properties?.Name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                        const type = feature.properties?.type || 'point';
                        
                        if (!coords || coords.length < 2) return;
                        
                        let latlng;
                        if (currentMapType === 'google-satellite') {
                            latlng = epsg3857ToWgs84(coords[0], coords[1]);
                        } else {
                            latlng = [coords[1], coords[0]];
                        }
                        
                        const markerColor = type === '—Ç–µ—Ö. —ç—Ç–∞–ø' ? '#ff0000' : '#00ff00';
                        const labelClass = type === '—Ç–µ—Ö. —ç—Ç–∞–ø' ? 'kp-label-tech' : 'kp-label-point';
                        
                        const marker = L.circleMarker(latlng, {
                            radius: 4,
                            color: markerColor,
                            fillColor: markerColor,
                            fillOpacity: 0.7,
                            weight: 1
                        }).bindPopup(`<b>${name}</b><br>–¢–∏–ø: ${type}`);
                        
                        const label = L.marker(latlng, {
                            icon: L.divIcon({
                                className: labelClass,
                                html: name.length > 15 ? name.substring(0, 12) + '...' : name,
                                iconSize: null,
                                iconAnchor: [0, -8]
                            }),
                            interactive: false
                        });
                        
                        marker.addTo(kpLayer);
                        label.addTo(kpLayer);
                    });
                    
                    kpLayer.addTo(map);
                    kpLayerVisible = true;
                    btn.classList.add('layer-active');
                    
                    updateMarkersVisibilityForCurrentMap();
                    document.getElementById('status').textContent = `–°–ª–æ–π –ö–ü 2025 –∑–∞–≥—Ä—É–∂–µ–Ω: ${data.features.length} —Ç–æ—á–µ–∫`;
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ö–ü:', error);
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—è –ö–ü 2025');
                }
                
                hideLoadingOverlay();
            } else {
                if (kpLayer) map.removeLayer(kpLayer);
                kpLayer = null;
                kpLayerVisible = false;
                btn.classList.remove('layer-active');
                document.getElementById('status').textContent = '–°–ª–æ–π –ö–ü 2025 —Å–∫—Ä—ã—Ç';
            }
        }
        
        // ==================== –°–õ–û–ô –í–°–ï–• –ú–ï–¢–û–ö –ò –†–ï–ë–ï–† ====================
        async function toggleAllEdgesLayer() {
            const isGoogle = currentMapType === 'google-satellite';
            const btn = document.getElementById('all-edges-btn');
            
            if (!allEdgesLayerVisible) {
                showLoadingOverlay("–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –∏ —Ä–µ–±–µ—Ä...");
                
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ—á–∫–∏
                    const pointsData = await loadGeoJsonFile('points_json.geojson');
                    const tunnelsData = await loadGeoJsonFile('tunnels_json.geojson');
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª–æ–π, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (allEdgesLayer) map.removeLayer(allEdgesLayer);
                    allEdgesLayer = L.layerGroup();
                    
                    let edgeCount = 0;
                    let pointCount = 0;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–∞ (—Ç—É–Ω–Ω–µ–ª–∏)
                    tunnelsData.features.forEach(f => {
                        if (!f.geometry) return;
                        
                        let lines = [];
                        if (f.geometry.type === 'LineString') lines = [f.geometry.coordinates];
                        else if (f.geometry.type === 'MultiLineString') lines = f.geometry.coordinates;
                        else return;
                        
                        let weight = f.properties?.weight || 5;
                        
                        lines.forEach(coords => {
                            if (!Array.isArray(coords) || coords.length < 2) return;
                            
                            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è Google Maps
                            const latlngs = [];
                            for (let i = 0; i < coords.length; i++) {
                                const pt = coords[i];
                                if (!Array.isArray(pt) || pt.length < 2) continue;
                                
                                let latlng;
                                if (currentMapType === 'google-satellite') {
                                    latlng = epsg3857ToWgs84(pt[0], pt[1]);
                                } else {
                                    latlng = [pt[1], pt[0]];
                                }
                                latlngs.push(latlng);
                            }
                            
                            if (latlngs.length < 2) return;
                            
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Å–∞
                            let color;
                            switch(weight) {
                                case 1: color = '#000000'; break; // –ó–∞–≤–∞–ª
                                case 2: color = '#ff0000'; break; // –®–∫—É—Ä–æ–¥–µ—Ä
                                case 3: color = '#ffa500'; break; // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ
                                case 4: color = '#0000ff'; break; // –í–æ–¥–∞
                                default: color = '#00ff00'; // –°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥
                            }
                            
                            // –°–æ–∑–¥–∞–µ–º –ª–∏–Ω–∏—é
                            const polyline = L.polyline(latlngs, {
                                color: color,
                                weight: 3,
                                opacity: 0.7
                            }).addTo(allEdgesLayer);
                            edgeCount++;
                        });
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫–∏
                    pointsData.features.forEach(feature => {
                        if (feature.geometry.type !== 'Point') return;
                        const coords = feature.geometry.coordinates;
                        const name = feature.properties?.Name || '';
                        
                        if (!coords || coords.length < 2 || !name) return;
                        
                        let latlng;
                        if (currentMapType === 'google-satellite') {
                            latlng = epsg3857ToWgs84(coords[0], coords[1]);
                        } else {
                            latlng = [coords[1], coords[0]];
                        }
                        
                        const marker = L.circleMarker(latlng, {
                            radius: 4,
                            color: '#5D4037',
                            fillColor: 'white',
                            weight: 1,
                            fillOpacity: 1
                        }).bindPopup(`<b>${name}</b>`);
                        
                        const label = L.marker(latlng, {
                            icon: L.divIcon({
                                className: 'point-label-from-json',
                                html: name.length > 15 ? name.substring(0, 12) + '...' : name,
                                iconSize: null,
                                iconAnchor: [0, -8]
                            }),
                            interactive: false
                        });
                        
                        marker.addTo(allEdgesLayer);
                        label.addTo(allEdgesLayer);
                        pointCount++;
                    });
                    
                    allEdgesLayer.addTo(map);
                    allEdgesLayerVisible = true;
                    btn.classList.add('layer-active');
                    
                    updateMarkersVisibilityForCurrentMap();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–µ–≥–µ–Ω–¥—É
                    const legendHtml = `
                        <div class="tunnel-legend">
                            <div class="tunnel-legend-title">–õ–µ–≥–µ–Ω–¥–∞ –ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç–∏:</div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #00ff00;"></div>
                                <span>–°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #ffa500;"></div>
                                <span>–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #ff0000;"></div>
                                <span>–®–∫—É—Ä–æ–¥–µ—Ä</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #0000ff;"></div>
                                <span>–í–æ–¥–∞</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #000000;"></div>
                                <span>–ó–∞–≤–∞–ª</span>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('status').innerHTML = 
                        `–°–ª–æ–π –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –∏ —Ä–µ–±–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω: ${pointCount} —Ç–æ—á–µ–∫ –∏ ${edgeCount} —Ä–µ–±–µ—Ä. ${legendHtml}`;
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –∏ —Ä–µ–±–µ—Ä:', error);
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—è –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –∏ —Ä–µ–±–µ—Ä');
                }
                
                hideLoadingOverlay();
            } else {
                if (allEdgesLayer) map.removeLayer(allEdgesLayer);
                allEdgesLayer = null;
                allEdgesLayerVisible = false;
                btn.classList.remove('layer-active');
                document.getElementById('status').textContent = '–°–ª–æ–π –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –∏ —Ä–µ–±–µ—Ä —Å–∫—Ä—ã—Ç';
            }
        }
        
        // ==================== –°–õ–û–ô –û–ü–ê–°–ù–´–• –ú–ï–°–¢ ====================
        async function toggleDangerLayer() {
            const isGoogle = currentMapType === 'google-satellite';
            const btn = document.getElementById(isGoogle ? 'danger-layer-btn-google' : 'danger-layer-btn');
            
            if (!dangerLayerVisible) {
                showLoadingOverlay("–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç...");
                
                try {
                    const data = await loadGeoJsonFile('danger_points.geojson');
                    
                    if (dangerLayer) map.removeLayer(dangerLayer);
                    dangerLayer = L.layerGroup();
                    
                    data.features.forEach(feature => {
                        if (feature.geometry.type !== 'Point') return;
                        const coords = feature.geometry.coordinates;
                        const name = feature.properties?.Name || '–û–ø–∞—Å–Ω–æ–µ –º–µ—Å—Ç–æ';
                        const description = feature.properties?.description || '';
                        
                        if (!coords || coords.length < 2) return;
                        
                        let latlng;
                        if (currentMapType === 'google-satellite') {
                            latlng = epsg3857ToWgs84(coords[0], coords[1]);
                        } else {
                            latlng = [coords[1], coords[0]];
                        }
                        
                        const marker = L.marker(latlng, {
                            icon: L.divIcon({
                                className: 'danger-marker',
                                html: '<span style="font-size: 24px">üö∑</span>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).bindPopup(`<b>${name}</b>${description ? '<br>' + description : ''}`);
                        
                        const label = L.marker(latlng, {
                            icon: L.divIcon({
                                className: 'danger-point-label',
                                html: name.length > 15 ? name.substring(0, 12) + '...' : name,
                                iconSize: null,
                                iconAnchor: [0, -15]
                            }),
                            interactive: false
                        });
                        
                        marker.addTo(dangerLayer);
                        label.addTo(dangerLayer);
                    });
                    
                    dangerLayer.addTo(map);
                    dangerLayerVisible = true;
                    btn.classList.add('layer-active');
                    
                    updateMarkersVisibilityForCurrentMap();
                    document.getElementById('status').textContent = `–°–ª–æ–π –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω: ${data.features.length} —Ç–æ—á–µ–∫`;
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç:', error);
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—è –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç');
                }
                
                hideLoadingOverlay();
            } else {
                if (dangerLayer) map.removeLayer(dangerLayer);
                dangerLayer = null;
                dangerLayerVisible = false;
                btn.classList.remove('layer-active');
                document.getElementById('status').textContent = '–°–ª–æ–π –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç —Å–∫—Ä—ã—Ç';
            }
        }
        
        // ==================== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ï –ú–ï–¢–ö–ò ====================
        function loadUserPoints() {
            const saved = localStorage.getItem('userPoints');
            if (saved) {
                try {
                    userPointsData = JSON.parse(saved);
                } catch (e) {
                    userPointsData = { type: "FeatureCollection", features: [] };
                }
            }
            return userPointsData;
        }
        
        function saveUserPoints() {
            localStorage.setItem('userPoints', JSON.stringify(userPointsData));
        }
        
        function toggleUserPointsLayer() {
            const btn = document.getElementById('points-layer-btn');
            
            if (!userPointsLayerVisible) {
                // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫
                userPointsLayerVisible = true;
                isUserPointsMode = false;
                isEditMode = false;
                selectedPointIndex = null;
                btn.classList.add('active');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                document.getElementById('add-point-btn').style.display = 'flex';
                document.getElementById('edit-points-btn').style.display = 'flex';
                document.getElementById('cancel-edit-btn').style.display = 'none';
                document.getElementById('delete-point-btn').style.display = 'none';
                document.getElementById('points-controls-expanded').classList.add('active');
                
                loadUserPoints();
                displayUserPoints();
                
                document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
                
            } else {
                // –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫
                userPointsLayerVisible = false;
                isUserPointsMode = false;
                isEditMode = false;
                selectedPointIndex = null;
                btn.classList.remove('active');
                
                // –°–∫—Ä—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                document.getElementById('add-point-btn').style.display = 'none';
                document.getElementById('edit-points-btn').style.display = 'none';
                document.getElementById('cancel-edit-btn').style.display = 'none';
                document.getElementById('delete-point-btn').style.display = 'none';
                document.getElementById('points-controls-expanded').classList.remove('active');
                
                if (userPointsLayer) {
                    map.removeLayer(userPointsLayer);
                    userPointsLayer = null;
                    userPointMarkers = [];
                    userPointLabels = [];
                }
                
                document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞';
            }
        }
        
        function displayUserPoints() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª–æ–∏
            if (userPointsLayer) {
                map.removeLayer(userPointsLayer);
            }
            userPointMarkers = [];
            userPointLabels = [];
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–ª–æ–π
            userPointsLayer = L.layerGroup();
            
            userPointsData.features.forEach((feature, index) => {
                if (feature.geometry.type !== 'Point') return;
                const coords = feature.geometry.coordinates;
                const name = feature.properties?.name || `–ú–µ—Ç–∫–∞ ${index + 1}`;
                const comment = feature.properties?.comment || '';
                
                if (!coords || coords.length < 2) return;
                
                let latlng;
                if (currentMapType === 'google-satellite') {
                    latlng = epsg3857ToWgs84(coords[0], coords[1]);
                } else {
                    latlng = [coords[1], coords[0]];
                }
                
                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
                const marker = L.circleMarker(latlng, {
                    radius: 8,
                    color: '#8B008B',
                    fillColor: '#FFB6C1',
                    weight: 2,
                    fillOpacity: 0.9,
                    className: 'user-point-marker'
                }).bindPopup(`<b>${name}</b>${comment ? '<br>' + comment : ''}<br><small><i>ID: ${index + 1}</i></small>`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                marker.on('click', function(e) {
                    console.log('–ö–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É –º–µ—Ç–∫–∏:', index);
                    if (isEditMode) {
                        console.log('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω, –≤—ã–±–∏—Ä–∞–µ–º –º–µ—Ç–∫—É');
                        e.originalEvent.stopPropagation();
                        e.originalEvent.preventDefault();
                        selectPointForEditing(index);
                        showEditPointPopup(index);
                        return false;
                    }
                });
                
                // –ü–æ–¥–ø–∏—Å—å
                const label = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'user-point-label',
                        html: name.length > 15 ? name.substring(0, 12) + '...' : name,
                        iconSize: null,
                        iconAnchor: [0, -15]
                    }),
                    interactive: false
                });
                
                marker.addTo(userPointsLayer);
                label.addTo(userPointsLayer);
                userPointMarkers.push(marker);
                userPointLabels.push(label);
            });
            
            userPointsLayer.addTo(map);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
            if (isEditMode) {
                updateMarkersForEditMode();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–µ—Ç–æ–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç—ã
            updateMarkersVisibilityForCurrentMap();
        }
        
        function startEditMode() {
            console.log('–ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            isEditMode = true;
            isUserPointsMode = false;
            
            // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('add-point-btn').style.display = 'none';
            document.getElementById('edit-points-btn').style.display = 'none';
            document.getElementById('cancel-edit-btn').style.display = 'flex';
            document.getElementById('delete-point-btn').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
            updateMarkersForEditMode();
            
            document.getElementById('status').textContent = '–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–∫. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –º–µ—Ç–∫—É –¥–ª—è –≤—ã–±–æ—Ä–∞.';
        }
        
        function cancelEditMode() {
            console.log('–û—Ç–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            isEditMode = false;
            isUserPointsMode = false;
            
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                const markerElement = userPointMarkers[selectedPointIndex].getElement();
                if (markerElement) {
                    markerElement.classList.remove('selected');
                }
            }
            selectedPointIndex = null;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('add-point-btn').style.display = 'flex';
            document.getElementById('edit-points-btn').style.display = 'flex';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.getElementById('delete-point-btn').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
            updateMarkersForEditMode();
            
            document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
        }
        
        function updateMarkersForEditMode() {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –º–∞—Ä–∫–µ—Ä–æ–≤, —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', isEditMode);
            
            userPointMarkers.forEach((marker, index) => {
                const element = marker.getElement();
                if (element) {
                    if (isEditMode) {
                        element.classList.add('editing');
                        if (index === selectedPointIndex) {
                            element.classList.add('selected');
                        } else {
                            element.classList.remove('selected');
                        }
                    } else {
                        element.classList.remove('editing');
                        element.classList.remove('selected');
                    }
                }
            });
        }
        
        function selectPointForEditing(index) {
            console.log('–í—ã–±–æ—Ä –º–µ—Ç–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', index);
            
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –º–µ—Ç–∫–∏
            if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                const prevMarkerElement = userPointMarkers[selectedPointIndex].getElement();
                if (prevMarkerElement) {
                    prevMarkerElement.classList.remove('selected');
                }
            }
            
            // –í—ã–¥–µ–ª—è–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É
            selectedPointIndex = index;
            if (userPointMarkers[index]) {
                const markerElement = userPointMarkers[index].getElement();
                if (markerElement) {
                    markerElement.classList.add('selected');
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
            document.getElementById('delete-point-btn').style.display = 'flex';
        }
        
        function showAddPointPopup() {
            document.getElementById('add-point-overlay').style.display = 'block';
            document.getElementById('add-point-popup').style.display = 'block';
            document.getElementById('point-name').focus();
        }
        
        function hideAddPointPopup() {
            document.getElementById('add-point-overlay').style.display = 'none';
            document.getElementById('add-point-popup').style.display = 'none';
            document.getElementById('point-name').value = '';
            document.getElementById('point-comment').value = '';
            pendingPointCoords = null;
        }
        
        function showEditPointPopup(index) {
            console.log('–ü–æ–∫–∞–∑ –ø–æ–ø–∞–ø–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –º–µ—Ç–∫–∏:', index);
            const feature = userPointsData.features[index];
            if (!feature) {
                console.error('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É:', index);
                return;
            }
            
            document.getElementById('edit-point-name').value = feature.properties?.name || '';
            document.getElementById('edit-point-comment').value = feature.properties?.comment || '';
            document.getElementById('edit-point-overlay').style.display = 'flex';
        }
        
        function hideEditPointPopup() {
            document.getElementById('edit-point-overlay').style.display = 'none';
            document.getElementById('edit-point-name').value = '';
            document.getElementById('edit-point-comment').value = '';
        }
        
        function addUserPoint() {
            const name = document.getElementById('point-name').value.trim();
            const comment = document.getElementById('point-comment').value.trim();
            
            if (!name) {
                showCustomAlert('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
                return;
            }
            
            if (!pendingPointCoords) {
                showCustomAlert('–û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã');
                return;
            }
            
            const newFeature = {
                type: "Feature",
                geometry: {
                    type: "Point",
                    coordinates: pendingPointCoords
                },
                properties: {
                    name: name,
                    comment: comment,
                    created: new Date().toISOString()
                }
            };
            
            userPointsData.features.push(newFeature);
            saveUserPoints();
            
            if (userPointsLayerVisible) {
                displayUserPoints();
            }
            
            showCustomAlert(`–ú–µ—Ç–∫–∞ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`);
            hideAddPointPopup();
            isUserPointsMode = false;
            document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
        }
        
        function updateUserPoint() {
            if (selectedPointIndex === null) return;
            
            const name = document.getElementById('edit-point-name').value.trim();
            const comment = document.getElementById('edit-point-comment').value.trim();
            
            if (!name) {
                showCustomAlert('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
                return;
            }
            
            userPointsData.features[selectedPointIndex].properties.name = name;
            userPointsData.features[selectedPointIndex].properties.comment = comment;
            userPointsData.features[selectedPointIndex].properties.updated = new Date().toISOString();
            
            saveUserPoints();
            
            if (userPointsLayerVisible) {
                displayUserPoints();
            }
            
            showCustomAlert(`–ú–µ—Ç–∫–∞ "${name}" –æ–±–Ω–æ–≤–ª–µ–Ω–∞`);
            hideEditPointPopup();
            
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
            if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                userPointMarkers[selectedPointIndex].getElement().classList.remove('selected');
            }
            selectedPointIndex = null;
            document.getElementById('delete-point-btn').style.display = 'none';
        }
        
        function deleteUserPoint() {
            if (selectedPointIndex === null) return;
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–µ—Ç–∫—É?')) {
                return;
            }
            
            const pointName = userPointsData.features[selectedPointIndex].properties?.name || '–ú–µ—Ç–∫–∞';
            userPointsData.features.splice(selectedPointIndex, 1);
            saveUserPoints();
            
            if (userPointsLayerVisible) {
                displayUserPoints();
            }
            
            showCustomAlert(`–ú–µ—Ç–∫–∞ "${pointName}" —É–¥–∞–ª–µ–Ω–∞`);
            hideEditPointPopup();
            
            selectedPointIndex = null;
            document.getElementById('delete-point-btn').style.display = 'none';
        }
        
        function saveUserPointsToFile() {
            const bookmarkName = document.getElementById('bookmark-name').value.trim();
            if (!bookmarkName) {
                showCustomAlert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–æ–∫');
                return;
            }
            
            const dataStr = JSON.stringify(userPointsData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${bookmarkName.replace(/[^\w–∞-—è–ê-–Ø—ë–Å\s.-]/g, '_').replace(/\s+/g, '_')}.geojson`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showCustomAlert(`–ú–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª: ${link.download}`);
            document.getElementById('bookmark-name').value = '';
        }
        
        // ==================== –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–û–ò–°–ö –¢–û–ß–ï–ö ====================
        function performSearch(query) {
            const resultsContainer = document.getElementById('search-results-panel');
            resultsContainer.innerHTML = '';
            
            if (query.trim()) {
                lastSearchQuery = query.trim();
                localStorage.setItem('lastSearchQuery', lastSearchQuery);
            }
            
            if (!query.trim() || !allPointsGeoJson) {
                resultsContainer.style.display = 'none';
                return;
            }

            const q = query.trim().toLowerCase();
            const matches = [];

            allPointsGeoJson.features.forEach(feature => {
                if (feature.geometry.type !== "Point") return;
                const name = feature.properties?.Name;
                const coords = feature.geometry.coordinates;
                if (!name || !coords || coords.length < 2) return;
                
                const nameLower = name.toLowerCase();
                if (nameLower.includes(q)) {
                    let priority = 2;
                    if (nameLower === q) priority = 0;
                    else if (nameLower.startsWith(q)) priority = 1;
                    matches.push({ name, coords, priority });
                }
            });

            if (matches.length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }

            matches.sort((a, b) => {
                if (a.priority !== b.priority) return a.priority - b.priority;
                return a.name.localeCompare(b.name, 'ru');
            });

            matches.slice(0, 20).forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-result-item-panel';
                div.textContent = item.name;
                div.setAttribute('data-lng', item.coords[0]);
                div.setAttribute('data-lat', item.coords[1]);
                div.addEventListener('click', (e) => {
                    const lng = parseFloat(e.target.getAttribute('data-lng'));
                    const lat = parseFloat(e.target.getAttribute('data-lat'));
                    if (!isNaN(lng) && !isNaN(lat)) {
                        let targetLat, targetLng;
                        if (currentMapType === 'google-satellite') {
                            const wgs84Coords = epsg3857ToWgs84(lng, lat);
                            targetLat = wgs84Coords[0];
                            targetLng = wgs84Coords[1];
                        } else {
                            targetLat = lat;
                            targetLng = lng;
                        }
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
                        const currentCenter = map.getCenter();
                        const currentZoom = map.getZoom();
                        const targetZoom = currentMapType === 'google-satellite' ? 18 : 2;
                        
                        // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–æ—á–∫–µ —Å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º
                        map.flyTo([targetLat, targetLng], targetZoom, {
                            duration: 2.5,
                            easeLinearity: 0.25
                        });

                        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                        if (searchHighlightMarker) {
                            map.removeLayer(searchHighlightMarker);
                            searchHighlightMarker = null;
                        }
                        if (searchHaloMarker) {
                            map.removeLayer(searchHaloMarker);
                            searchHaloMarker = null;
                        }
                        
                        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–ª–µ—Ç–∞
                        setTimeout(() => {
                            // –°–æ–∑–¥–∞–µ–º –æ—Ä–µ–æ–ª –≤–æ–∫—Ä—É–≥ —Ç–æ—á–∫–∏
                            searchHaloMarker = L.circleMarker([targetLat, targetLng], {
                                radius: 20,
                                color: '#0066cc',
                                fillColor: 'rgba(0, 102, 204, 0.2)',
                                weight: 1,
                                fillOpacity: 0.5,
                                className: 'search-halo'
                            }).addTo(map);
                            
                            // –°–æ–∑–¥–∞–µ–º —Å–∏–Ω–∏–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏
                            searchHighlightMarker = L.marker([targetLat, targetLng], {
                                icon: L.divIcon({
                                    className: 'search-highlight-marker',
                                    html: '<div style="background-color: #0066cc; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(0, 102, 204, 0.8);"></div>',
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 12]
                                }),
                                zIndexOffset: 10000
                            }).bindPopup(`<b>${item.name}</b>`).openPopup().addTo(map);

                            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                            setTimeout(() => {
                                if (searchHighlightMarker) {
                                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º popup –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
                                    searchHighlightMarker.closePopup();
                                    map.removeLayer(searchHighlightMarker);
                                    searchHighlightMarker = null;
                                }
                                if (searchHaloMarker) {
                                    map.removeLayer(searchHaloMarker);
                                    searchHaloMarker = null;
                                }
                            }, 10000);
                        }, 2500);

                        toggleSearchPanel();
                    }
                });
                resultsContainer.appendChild(div);
            });

            resultsContainer.style.display = 'block';
        }
        
        function toggleSearchPanel() {
            const searchPanel = document.getElementById('search-panel');
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results-panel');

            if (!searchPanelVisible) {
                if (!allPointsGeoJson) {
                    showCustomAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞");
                    return;
                }

                searchPanel.style.display = 'block';
                searchPanelVisible = true;
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';

                lastSearchQuery = localStorage.getItem('lastSearchQuery') || '';
                searchInput.value = lastSearchQuery;

                setTimeout(() => {
                    searchInput.focus();
                    setTimeout(() => {
                        if (lastSearchQuery) {
                            searchInput.setSelectionRange(0, lastSearchQuery.length);
                        }
                    }, 10);
                }, 50);

                if (lastSearchQuery) {
                    performSearch(lastSearchQuery);
                }
            } else {
                searchPanel.style.display = 'none';
                searchPanelVisible = false;
                searchInput.value = '';
                searchResults.style.display = 'none';
            }
        }

        function showSearchPointsPopup() {
            toggleSearchPanel();
        }

        function goToPoint(point) {
            if (!point) return;
            
            const [x, y] = point.coords;
            let latlng;
            
            if (currentMapType === 'google-satellite') {
                latlng = epsg3857ToWgs84(x, y);
            } else {
                latlng = [y, x];
            }
            
            // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–æ—á–∫–µ
            map.flyTo(latlng, currentMapType === 'google-satellite' ? 18 : 0, {
                duration: 2.5,
                easeLinearity: 0.25
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç–æ—á–∫–∏
            const marker = L.marker(latlng).addTo(map)
                .bindPopup(`<b>${point.name}</b>`)
                .openPopup();
            
            // –£–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                map.removeLayer(marker);
            }, 5000);
            
            document.getElementById('status').textContent = `–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–æ—á–∫–µ: ${point.name}`;
        }
        
        // ==================== –°–û–•–†–ê–ù–ï–ù–ò–ï/–ó–ê–ì–†–£–ó–ö–ê ====================
        function saveRoute() {
            const routeName = document.getElementById('route-name').value.trim();
            if (!routeName) {
                showCustomAlert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –º–∞—Ä—à—Ä—É—Ç–∞');
                return;
            }
            
            if (selectedPoints.length < 2) {
                showCustomAlert('–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏');
                return;
            }
            
            const routeData = {
                name: routeName,
                points: selectedPoints,
                date: new Date().toISOString(),
                distance: calculateTotalDistance()
            };
            
            let savedRoutes = JSON.parse(localStorage.getItem('userRoutes') || '[]');
            savedRoutes.push(routeData);
            localStorage.setItem('userRoutes', JSON.stringify(savedRoutes));
            
            const dataStr = JSON.stringify(routeData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${routeName.replace(/[^\w–∞-—è–ê-–Ø—ë–Å\s.-]/g, '_').replace(/\s+/g, '_')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showCustomAlert(`–ú–∞—Ä—à—Ä—É—Ç "${routeName}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω`);
            document.getElementById('route-name').value = '';
        }
        
        function calculateTotalDistance() {
            let total = 0;
            for (let i = 0; i < selectedPoints.length - 1; i++) {
                total += calculateRealDistance(selectedPoints[i], selectedPoints[i + 1]);
            }
            return total;
        }
        
        function loadRouteFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.points || !Array.isArray(data.points)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    
                    clearRoute();
                    selectedPoints = data.points.map(pt => [...pt]);
                    
                    selectedPoints.forEach((pt, idx) => {
                        const fillColor = idx === 0 ? 'green' : idx === selectedPoints.length - 1 ? 'blue' : 'red';
                        const marker = L.circle([pt[1], pt[0]], {
                            radius: 3,
                            color: 'white',
                            fillColor: fillColor,
                            weight: 2,
                            fillOpacity: 1,
                            className: 'route-point-marker'
                        }).addTo(map);
                        pointMarkers.push(marker);
                    });
                    
                    buildFullRoute();
                    showCustomAlert(`–ú–∞—Ä—à—Ä—É—Ç "${data.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}" –∑–∞–≥—Ä—É–∂–µ–Ω`);
                } catch (error) {
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function loadUserPointsFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.type !== 'FeatureCollection') throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç GeoJSON');
                    
                    userPointsData = data;
                    saveUserPoints();
                    
                    if (userPointsLayerVisible) displayUserPoints();
                    showCustomAlert('–ú–µ—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                } catch (error) {
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // ==================== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ö–ê–†–¢ ====================
        function switchMapLayer(mapType) {
            if (currentMapType === mapType) return;
            currentMapType = mapType;

            showLoadingOverlay("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã...");
            
            const wasKpVisible = kpLayerVisible;
            const wasUserPointsVisible = userPointsLayerVisible;
            const wasAllEdgesVisible = allEdgesLayerVisible;
            const wasDangerVisible = dangerLayerVisible;
            const wasEditMode = isEditMode;
            
            if (entranceMarker) map.removeLayer(entranceMarker);
            if (currentImageOverlay) map.removeLayer(currentImageOverlay);
            if (googleSatelliteLayer) map.removeLayer(googleSatelliteLayer);
            if (kpLayer) map.removeLayer(kpLayer);
            if (userPointsLayer) map.removeLayer(userPointsLayer);
            if (allEdgesLayer) map.removeLayer(allEdgesLayer);
            if (dangerLayer) map.removeLayer(dangerLayer);
            if (routeLayer) map.removeLayer(routeLayer);
            
            entranceMarker = currentImageOverlay = googleSatelliteLayer = null;

            if (mapType === 'google-satellite') {
                map.options.crs = L.CRS.EPSG3857;
                map.options.minZoom = 10;
                map.options.maxZoom = 21;

                googleSatelliteLayer = L.tileLayer('https://mt{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                    maxZoom: 21,
                    minZoom: 10,
                    subdomains: ['0','1','2','3'],
                    attribution: false // –û—Ç–∫–ª—é—á–∞–µ–º –∞—Ç—Ç—Ä–∏–±—É—Ü–∏—é
                }).addTo(map);

                setTimeout(() => {
                    addEntranceMarker();
                    const [x, y] = ENTRANCE_COORDS_EPSG3857;
                    const [lat, lng] = epsg3857ToWgs84(x, y);
                    map.setView([lat, lng], 17);

                    updateControlsVisibility();
                    
                    if (wasKpVisible) toggleKPLayer();
                    if (wasUserPointsVisible && userPointsData.features.length > 0) displayUserPoints();
                    if (wasAllEdgesVisible) toggleAllEdgesLayer();
                    if (wasDangerVisible) toggleDangerLayer();
                    
                    setTimeout(() => updateMarkersVisibilityForCurrentMap(), 100);
                    hideLoadingOverlay();
                }, 100);
            } else {
                map.options.crs = L.CRS.Simple;
                map.options.minZoom = -2;
                map.options.maxZoom = 4;
                
                updateControlsVisibility();
                
                if (!mapBounds) mapBounds = [[0, 0], [1000, 1000]];
                currentImageOverlay = L.imageOverlay(mapType, mapBounds, { opacity: 1 }).addTo(map);

                setTimeout(() => {
                    addEntranceMarker();
                    const centerX = (mapBounds[0][1] + mapBounds[1][1]) / 2;
                    const centerY = (mapBounds[0][0] + mapBounds[1][0]) / 2;
                    map.setView([centerY, centerX], -1);

                    if (wasKpVisible) toggleKPLayer();
                    if (wasUserPointsVisible && userPointsData.features.length > 0) displayUserPoints();
                    if (wasAllEdgesVisible) toggleAllEdgesLayer();
                    if (wasDangerVisible) toggleDangerLayer();
                    if (selectedPoints.length > 1) buildFullRoute();
                    if (wasEditMode && wasUserPointsVisible) startEditMode();
                    
                    setTimeout(() => updateMarkersVisibilityForCurrentMap(), 100);
                    hideLoadingOverlay();
                }, 100);
            }
        }
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        async function initializeMap() {
            document.getElementById('status').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã...';
            
            try {
                const fileChecks = await Promise.allSettled(
                    REQUIRED_FILES.map(file => fetch(file))
                );
                
                const missingFiles = [];
                fileChecks.forEach((result, index) => {
                    if (result.status === 'rejected') missingFiles.push(REQUIRED_FILES[index]);
                });
                
                if (missingFiles.length > 0) {
                    console.warn('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ñ–∞–π–ª—ã:', missingFiles);
                    showCustomAlert(`–í–Ω–∏–º–∞–Ω–∏–µ: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã: ${missingFiles.join(', ')}`);
                }
                
                await loadTunnelsData();
                allPointsGeoJson = await loadGeoJsonFile('points_json.geojson');
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é –¥–ª–∏–Ω—É —à—Ç—Ä–µ–∫–æ–≤
                calculateTotalTunnelLength();
                
                if (segments.length === 0) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç—É–Ω–Ω–µ–ª–µ–π');
                
                currentImageOverlay = L.imageOverlay('byaki.png', mapBounds, { opacity: 1 }).addTo(map);
                addEntranceMarker();
                
                const centerX = (mapBounds[0][1] + mapBounds[1][1]) / 2;
                const centerY = (mapBounds[0][0] + mapBounds[1][0]) / 2;
                map.setView([centerY, centerX], -1);
                
                loadUserPoints();
                updateControlsVisibility();
                
                document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å—Ö–µ–º—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ—á–µ–∫.';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã';
                showCustomAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã: ${error.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ.`);
                
                mapBounds = [[0, 0], [1000, 1000]];
                currentImageOverlay = L.imageOverlay('byaki.png', mapBounds, { opacity: 0.5 }).addTo(map);
            }
        }
        
        // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ====================
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('dropdown-menu');
                const menuBtn = document.getElementById('menu-button');
                const searchPanel = document.getElementById('search-panel');
                
                if (menuOpen && !dropdown.contains(e.target) && !menuBtn.contains(e.target)) {
                    menuOpen = false;
                    dropdown.classList.remove('active');
                }
                
                if (searchPanelVisible && !searchPanel.contains(e.target) && e.target.id !== 'search-points-btn') {
                    toggleSearchPanel();
                }
            });
            
            document.getElementById('menu-button').addEventListener('click', (e) => {
                e.stopPropagation();
                menuOpen = !menuOpen;
                document.getElementById('dropdown-menu').classList.toggle('active', menuOpen);
            });
            
            document.getElementById('zoom-in').addEventListener('click', () => map.getZoom() < map.getMaxZoom() && map.zoomIn());
            document.getElementById('zoom-out').addEventListener('click', () => map.getZoom() > map.getMinZoom() && map.zoomOut());
            map.on('zoomend', onZoomEnd);
            
            document.getElementById('background-select').addEventListener('change', (e) => switchMapLayer(e.target.value));
            
            const setupButton = (id, handler) => document.getElementById(id).addEventListener('click', (e) => {
                e.stopPropagation();
                handler();
            });
            
            setupButton('save-route', saveRoute);
            setupButton('load-route', () => document.getElementById('route-file-input').click());
            setupButton('save-bookmark', saveUserPointsToFile);
            setupButton('load-bookmark', () => document.getElementById('bookmark-file-input').click());
            setupButton('clear-route-btn', clearRoute);
            setupButton('show-route-points-btn', toggleRoutePointsPopup);
            setupButton('undo-btn', undoLastPoint);
            setupButton('undo-btn-google', undoLastPoint);
            setupButton('kp-layer-btn', toggleKPLayer);
            setupButton('kp-layer-btn-google', toggleKPLayer);
            setupButton('danger-layer-btn', toggleDangerLayer);
            setupButton('danger-layer-btn-google', toggleDangerLayer);
            setupButton('points-layer-btn', toggleUserPointsLayer);
            setupButton('all-edges-btn', toggleAllEdgesLayer);
            setupButton('add-point-btn', () => {
                isUserPointsMode = true;
                isEditMode = false;
                document.getElementById('status').textContent = '–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏';
            });
            setupButton('edit-points-btn', startEditMode);
            setupButton('cancel-edit-btn', cancelEditMode);
            setupButton('delete-point-btn', deleteUserPoint);
            setupButton('add-point-cancel', () => {
                hideAddPointPopup();
                isUserPointsMode = false;
                document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
            });
            setupButton('add-point-save', addUserPoint);
            setupButton('edit-point-cancel', () => {
                hideEditPointPopup();
                if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                    userPointMarkers[selectedPointIndex].getElement().classList.remove('selected');
                }
                selectedPointIndex = null;
                document.getElementById('delete-point-btn').style.display = 'none';
            });
            setupButton('edit-point-delete', deleteUserPoint);
            setupButton('edit-point-save', updateUserPoint);
            setupButton('show-disclaimer', () => document.getElementById('disclaimer-overlay').style.display = 'flex');
            setupButton('close-disclaimer', () => document.getElementById('disclaimer-overlay').style.display = 'none');
            setupButton('search-points-btn', showSearchPointsPopup);
            
            const toggleLock = () => {
                routeLocked = !routeLocked;
                const lockBtn = document.getElementById('lock-btn');
                const lockBtnGoogle = document.getElementById('lock-btn-google');
                lockBtn.textContent = lockBtnGoogle.textContent = routeLocked ? 'üîí' : 'üîì';
                
                if (routeLocked) {
                    map.off('click', handleMapClick);
                    document.getElementById('status').textContent = '–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ';
                } else {
                    map.on('click', handleMapClick);
                    document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞';
                }
            };
            
            document.getElementById('lock-btn').addEventListener('click', toggleLock);
            document.getElementById('lock-btn-google').addEventListener('click', toggleLock);
            
            document.getElementById('add-point-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'add-point-overlay') {
                    hideAddPointPopup();
                    isUserPointsMode = false;
                    document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
                }
            });
            
            document.getElementById('edit-point-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'edit-point-overlay') {
                    hideEditPointPopup();
                    if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                        userPointMarkers[selectedPointIndex].getElement().classList.remove('selected');
                    }
                    selectedPointIndex = null;
                    document.getElementById('delete-point-btn').style.display = 'none';
                }
            });
            
            document.getElementById('disclaimer-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'disclaimer-overlay') {
                    document.getElementById('disclaimer-overlay').style.display = 'none';
                }
            });
            
            map.on('click', handleMapClick);
            
            document.getElementById('route-file-input').addEventListener('change', (e) => {
                if (e.target.files.length > 0) loadRouteFromFile(e.target.files[0]);
            });
            
            document.getElementById('bookmark-file-input').addEventListener('change', (e) => {
                if (e.target.files.length > 0) loadUserPointsFromFile(e.target.files[0]);
            });
            
            document.getElementById('search-input').addEventListener('input', (e) => performSearch(e.target.value));
            document.getElementById('search-input').addEventListener('keypress', (e) => e.key === 'Enter' && performSearch(e.target.value));
            document.getElementById('search-input').addEventListener('keydown', (e) => e.key === 'Escape' && toggleSearchPanel());
        });
    </script>
</body>
</html>
