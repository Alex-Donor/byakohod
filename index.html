<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ë—è–∫–æ–•–æ–¥ ‚Äî –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
        }
        body {
            margin: 0;
            padding: 0;
            font-family: Calibri, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100vh;
            cursor: default;
            touch-action: pan-x pan-y;
        }
        #menu-button {
            position: absolute;
            top: calc(10px + var(--safe-area-inset-top));
            left: calc(10px + var(--safe-area-inset-left));
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }
        #menu-button span {
            display: block;
            width: 4px;
            height: 4px;
            background: #333;
            border-radius: 50%;
            margin: 1px 0;
        }
        #left-controls {
            position: absolute;
            top: calc(12px + var(--safe-area-inset-top));
            left: calc(60px + var(--safe-area-inset-left));
            display: flex;
            gap: 4px;
            z-index: 1000;
            align-items: center;
        }
        #left-controls .control-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            font-size: 20px;
            color: #333;
            padding: 0;
            margin: 0;
            font-weight: bold;
            line-height: 1;
        }
        #zoom-level-display {
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            color: #007bff;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                1px 1px 0 white;
            pointer-events: none;
        }
        /* –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ –º–µ—Ç–æ–∫ */
        #search-points-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            font-size: 20px;
            color: #333;
            padding: 0;
            margin: 0;
            font-weight: bold;
            line-height: 1;
        }
        #dropdown-menu {
            display: none;
            position: absolute;
            top: 55px;
            left: 10px;
            background: #e8e8e8;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 0 12px rgba(0,0,0,0.5);
            z-index: 1000;
            width: fit-content;
            font-size: 13px;
            max-height: 80vh;
            overflow-y: auto;
        }
        #dropdown-menu.active {
            display: block;
        }
        .menu-section {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .menu-label {
            display: block;
            font-weight: bold;
            color: #222;
            margin-bottom: 6px;
        }
        .menu-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            font-size: 14px;
            background: #dcdcdc;
            border: 1px solid #aaa;
            border-radius: 4px;
            cursor: pointer;
            padding: 10px 12px;
            white-space: nowrap;
            width: 100%;
        }
        .menu-btn:hover {
            background: #ccc;
        }
        #status {
            position: absolute;
            bottom: calc(12px + var(--safe-area-inset-bottom));
            left: calc(12px + var(--safe-area-inset-left));
            background: #e8e8e8;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            color: #222;
            z-index: 1000;
            max-width: calc(300px - var(--safe-area-inset-left));
            line-height: 1.4;
            box-shadow: 0 1px 4px rgba(0,0,0,0.25);
        }
        .route-distance {
            color: red;
            font-weight: bold;
        }
        #clear-route-btn {
            position: absolute;
            bottom: calc(70px + var(--safe-area-inset-bottom));
            left: calc(12px + var(--safe-area-inset-left));
            padding: 8px 12px;
            font-size: 14px;
            background: #dcdcdc;
            border: 1px solid #aaa;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 1px 4px rgba(0,0,0,0.25);
            font-weight: bold;
            display: none;
        }
        /* –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤—ã–µ –∫–Ω–æ–ø–∫–∏ (–∑–∞–º–æ–∫, –ö–ü 2025, –æ—Ç–º–µ–Ω–∞) - –ù–ê –ë–ê–ó–û–í–´–• –ö–ê–†–¢–ê–• */
        #basic-map-right-controls {
            position: absolute;
            top: calc(12px + var(--safe-area-inset-top));
            right: calc(12px + var(--safe-area-inset-right));
            display: flex;
            gap: 8px;
            z-index: 1003;
            align-items: center;
        }
        
        /* –ü—Ä–∞–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ Google Satellite */
        #google-map-right-controls {
            position: absolute;
            top: calc(12px + var(--safe-area-inset-top));
            right: calc(12px + var(--safe-area-inset-right));
            display: flex;
            gap: 8px;
            z-index: 1003;
            align-items: center;
        }
        
        #basic-map-right-controls button,
        #google-map-right-controls button {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            font-size: 20px;
            color: #333;
            padding: 0;
            margin: 0;
            font-weight: bold;
            line-height: 1;
        }
        #kp-layer-btn {
            font-size: 13px !important;
            font-weight: bold !important;
        }
        #json-points-btn {
            font-size: 20px !important;
        }
        #json-points-btn.active,
        #points-layer-btn.active,
        #kp-layer-btn.active {
            background-color: #4CAF50 !important;
            border-color: #388E3C !important;
            color: white;
        }
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        #loading-modal {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }
        .custom-dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .custom-dialog {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            font-family: Calibri, Arial, sans-serif;
            max-width: 90%;
            width: 400px;
            z-index: 10001;
        }
        .custom-dialog-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
            color: #222;
        }
        .custom-dialog-message {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
            text-align: center;
        }
        .custom-dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .custom-dialog-button {
            padding: 8px 20px;
            font-size: 14px;
            border: 1px solid #aaa;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            min-width: 80px;
        }
        .custom-dialog-button-ok {
            background: #dcdcdc;
        }
        .file-selector-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .file-selector-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            font-family: Calibri, Arial, sans-serif;
            max-width: 90%;
            width: 320px;
            max-height: 80%;
            overflow-y: auto;
        }
        .file-selector-title {
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            color: #222;
            font-size: 16px;
            font-weight: bold;
        }
        .file-selector-item {
            padding: 12px;
            margin: 6px 0;
            border: 2px solid #007BFF;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f0f8ff;
            font-size: 14px;
            font-weight: bold;
            color: #0056b3;
        }
        .file-selector-item:hover {
            background: #e3f2fd;
        }
        .leaflet-control-attribution {
            display: none !important;
        }
        .route-io-section {
            border: 2px solid #007BFF;
            border-radius: 6px;
            padding: 10px;
            background-color: #f0f8ff;
            margin-bottom: 12px;
        }
        .route-save-row,
        .route-load-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }
        .menu-label.inline {
            margin: 0;
            font-weight: bold;
            font-size: 12px;
            white-space: nowrap;
        }
        #route-name,
        #bookmark-name {
            flex: 1;
            min-width: 60px;
            padding: 8px 10px;
            font-size: 12px;
            border: 2px solid #007BFF;
            border-radius: 8px;
            box-sizing: border-box;
            background-color: #fff;
        }
        .menu-btn.icon-only {
            width: 28px;
            height: 28px;
            padding: 0;
            display: flex;
            justify-content: center; 
            align-items: center;     
            font-size: 14px;
            background: #dcdcdc;
            border: 1px solid #aaa;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        /* –û–∫–Ω–æ –Ω–∏—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ */
        #route-points-popup {
            position: fixed;
            bottom: calc(140px + var(--safe-area-inset-bottom)); /* –°–º–µ—â–µ–Ω–æ –µ—â–µ –Ω–∏–∂–µ */
            right: calc(12px + var(--safe-area-inset-right));
            background: white;
            padding: 12px;
            border: 2px solid #aaffaa;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            max-height: 30vh;
            overflow-y: auto;
            font-family: Calibri, Arial, sans-serif;
            font-size: 13px;
            z-index: 2000;
            max-width: 150px;
            display: none;
        }
        .route-point-item {
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            margin: 3px 0;
            background-color: #e6f7ff;
            border-left: 3px solid #b3e0ff;
        }
        .route-point-item:hover {
            background-color: #d0ebff;
        }
        #show-route-points-btn {
            position: absolute;
            bottom: calc(100px + var(--safe-area-inset-bottom)); /* –°–º–µ—â–µ–Ω–æ –Ω–∏–∂–µ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∞–º–∏ */
            right: calc(12px + var(--safe-area-inset-right));
            padding: 8px 12px;
            background: #dcdcdc;
            border: 1px solid #aaa;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            z-index: 1000;
            display: none;
            box-shadow: 0 1px 4px rgba(0,0,0,0.25);
        }
        
        /* –ü–æ–ø–∞–ø –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫ */
        #add-point-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.8);
            z-index: 10000;
            width: 300px;
            max-width: 90%;
            font-family: Calibri, Arial, sans-serif;
            border: 3px solid #8B008B;
        }
        #add-point-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
        }
        #add-point-popup h3 {
            margin: 0 0 15px;
            text-align: center;
            font-size: 18px;
            color: #8B008B;
            font-weight: bold;
        }
        #add-point-popup label {
            display: block;
            margin-top: 12px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        #add-point-popup input,
        #add-point-popup textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 2px solid #ccc;
            border-radius: 6px;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
            box-sizing: border-box;
        }
        #add-point-popup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        #add-point-popup-buttons button {
            flex: 1;
            padding: 10px;
            font-weight: bold;
            border: 2px solid #aaa;
            border-radius: 6px;
            cursor: pointer;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ "by Alex Donor" */
        .menu-copyright {
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #aaa;
            width: 100%;
        }
        .menu-copyright a {
            text-decoration: none;
            color: #0066cc;
            font-weight: bold;
            font-size: 12px;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            transition: all 0.2s;
            text-shadow: 
                0 0 2px white,
                0 0 4px white;
            font-weight: 900;
            letter-spacing: 0.5px;
        }
        .menu-copyright a:hover {
            background-color: #dcdcdc;
            color: #004499;
            text-decoration: underline;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π –º–µ—Ç–æ–∫ */
        .kp-label-tech {
            font-family: Calibri, Arial, sans-serif !important;
            font-size: 10px !important;
            font-weight: bold !important;
            color: #ff0000 !important;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                3px 3px 0 white !important;
            background: transparent !important;
            border: none !important;
            white-space: nowrap !important;
        }
        .kp-label-point {
            font-family: Calibri, Arial, sans-serif !important;
            font-size: 10px !important;
            font-weight: bold !important;
            color: #004524 !important;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                3px 3px 0 white !important;
            background: transparent !important;
            border: none !important;
            white-space: nowrap !important;
        }
        .point-label-from-json {
            font-family: Calibri, Arial, sans-serif !important;
            font-size: 10px !important;
            font-weight: bold !important;
            color: #5D4037 !important;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                1px 1px 0 white !important;
            background: transparent !important;
            border: none !important;
            white-space: nowrap !important;
        }
        
        /* –ü–æ–¥–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫ */
        .user-point-label {
            font-family: Calibri, Arial, sans-serif !important;
            font-size: 12px !important;
            font-weight: bold !important;
            color: #8B008B !important;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                2px 2px 0 white !important;
            background: transparent !important;
            border: none !important;
            white-space: nowrap !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ (–°–¢–ê–†–¢/–§–ò–ù–ò–®/—Ü–∏—Ñ—Ä—ã) - –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ */
        .route-point-label {
			font-family: Calibri, Arial, sans-serif !important;
			font-size: 14px !important;
			font-weight: bold !important;
			color: #0d47a1 !important;
			text-shadow:
				-1px -1px 0 white,
				1px -1px 0 white,
				-1px 1px 0 white,
				2px 2px 0 white !important;
			/* –£–î–ê–õ–ï–ù–û: border: 2px solid #0d47a1 !important; */
			border-radius: 4px !important;
			padding: 4px 8px !important;
			white-space: nowrap !important;
			box-shadow: 0 3px 8px rgba(0,0,0,0.4) !important;
			z-index: 10000 !important; /* –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç */
		}

        /* –°—Ç–∞—Ä—ã–π —Å—Ç–∏–ª—å –ø–æ–¥–ø–∏—Å–µ–π —Ç–æ—á–µ–∫ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ (–∏–∑ JSON) */
        .route-point-label-old {
            font-family: Calibri, Arial, sans-serif !important;
            font-size: 11px !important;
            font-weight: bold !important;
            color: #01579b !important;
            text-shadow:
                -1px -1px 0 white,
                1px -1px 0 white,
                -1px 1px 0 white,
                1px 1px 0 white !important;
            background: #e3f2fd !important;
            border: 1px solid #90caf9 !important;
            border-radius: 3px !important;
            padding: 1px 3px !important;
            white-space: nowrap !important;
            z-index: 100 !important; /* –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç */
        }
        
        /* –ú–∞—Ä–∫–µ—Ä—ã —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ —Å –±–µ–ª–æ–π –æ–±–≤–æ–¥–∫–æ–π */
        .route-point-marker {
            stroke: white !important;
            stroke-width: 2px !important;
        }
        
        /* –°–∫—Ä—ã—Ç–∏–µ –ø–æ–¥–ø–∏—Å–µ–π –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –∑—É–º–µ */
        .label-hidden {
            display: none !important;
        }
        
        /* –ù–û–í–´–ô –ë–õ–û–ö –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ú–ò –ú–ï–¢–ö–ê–ú–ò - –†–ê–°–ü–û–õ–û–ñ–ï–ù –ù–ò–ñ–ï */
        #points-controls-container {
            position: absolute;
            top: calc(60px + var(--safe-area-inset-top)); /* –ï—â–µ –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–æ—Å—å */
            right: calc(12px + var(--safe-area-inset-right));
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            z-index: 1002; /* –ù–∏–∂–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
        }
        
        /* –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∞–º–∏ */
        #points-controls-main {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #points-controls-expanded {
            display: none;
            flex-direction: column; /* –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ column –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è */
            gap: 8px;
            margin-top: 8px; /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
            margin-right: 8px;
            transition: all 0.3s ease;
            align-items: flex-end; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
        }
        
        #points-controls-expanded.active {
            display: flex;
            animation: slideInDown 0.3s ease; /* –ò–∑–º–µ–Ω–µ–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—è */
        }
        
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∞–º–∏ */
        .points-control-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            font-size: 20px;
            color: #333;
            padding: 0;
            margin: 0;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –º–µ—Ç–æ–∫ */
        #points-layer-btn {
            background-color: #8B008B !important;
            border-color: #6A006A !important;
            color: white !important;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
        #add-point-btn {
            background-color: #4CAF50 !important;
            border-color: #388E3C !important;
            color: white !important;
            display: none;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        #edit-points-btn {
            background-color: #ff9800 !important;
            border-color: #f57c00 !important;
            color: white !important;
            display: none;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        #cancel-edit-btn {
            background-color: #f44336 !important;
            border-color: #d32f2f !important;
            color: white !important;
            display: none;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */
        #delete-point-btn {
            background-color: #f44336 !important;
            border-color: #d32f2f !important;
            color: white !important;
            display: none;
        }
        
        /* –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–∫ - –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é */
        .user-point-marker.editing {
            animation: pulse 1.5s infinite;
            cursor: pointer;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 152, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
            }
        }
        
        .user-point-marker.selected {
            animation: selected-pulse 1s infinite;
            box-shadow: 0 0 0 5px rgba(255, 152, 0, 0.7) !important;
        }
        
        @keyframes selected-pulse {
            0% {
                box-shadow: 0 0 0 5px rgba(255, 152, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(255, 152, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 5px rgba(255, 152, 0, 0.7);
            }
        }
        
        /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ–±–≤–æ–¥–∫—É Leaflet –ø—Ä–∏ –≤—ã–±–æ—Ä–µ */
        .user-point-marker.editing.leaflet-interactive {
            outline: none;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–∫ */
        #edit-point-popup .custom-dialog {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 3px solid #ff9800;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            width: 320px;
            max-width: 90vw;
        }

        #edit-point-popup .custom-dialog-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        #edit-point-popup .custom-dialog-message {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #edit-point-popup label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }

        #edit-point-popup input,
        #edit-point-popup textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        #edit-point-popup input:focus,
        #edit-point-popup textarea:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.2);
        }

        #edit-point-popup input {
            height: 40px;
        }

        #edit-point-popup textarea {
            min-height: 80px;
            resize: vertical;
        }

        #edit-point-popup .custom-dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 20px;
        }

        #edit-point-popup .custom-dialog-button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #edit-point-cancel {
            background: #e0e0e0;
            color: #333;
        }

        #edit-point-cancel:hover {
            background: #d0d0d0;
        }

        #edit-point-delete {
            background: #f44336;
            color: white;
        }

        #edit-point-delete:hover {
            background: #d32f2f;
        }

        #edit-point-save {
            background: #4CAF50;
            color: white;
        }

        #edit-point-save:hover {
            background: #388E3C;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ undo –∏ –∑–∞–º–æ–∫ –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç */
        #basic-map-left-controls {
            position: absolute;
            top: calc(12px + var(--safe-area-inset-top));
            right: calc(60px + var(--safe-area-inset-right)); /* –°–ª–µ–≤–∞ –æ—Ç –ö–ü 2025 */
            display: flex;
            gap: 8px;
            z-index: 1002;
            align-items: center;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ undo, –∑–∞–º–æ–∫ –∏ –ö–ü 2025 –¥–ª—è Google –∫–∞—Ä—Ç—ã */
        #google-map-left-controls {
            position: absolute;
            top: calc(12px + var(--safe-area-inset-top));
            right: calc(60px + var(--safe-area-inset-right)); /* –°–ª–µ–≤–∞ –æ—Ç –∫–Ω–æ–ø–∫–∏ "–º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ" */
            display: flex;
            gap: 8px;
            z-index: 1002;
            align-items: center;
        }
        
        #basic-map-left-controls button,
        #google-map-left-controls button {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            font-size: 20px;
            color: #333;
            padding: 0;
            margin: 0;
            font-weight: bold;
            line-height: 1;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞ */
        #search-points-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        #search-points-popup {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 30px rgba(0,0,0,0.8);
            border: 3px solid #007bff;
        }
        
        #search-points-popup h3 {
            margin: 0 0 15px 0;
            text-align: center;
            font-size: 18px;
            color: #007bff;
            font-weight: bold;
        }
        
        #search-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        #search-points-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
        }
        
        #search-points-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
        }
        
        #search-points-button {
            padding: 12px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        #search-points-button:hover {
            background: #0056cc;
        }
        
        #search-results-container {
            flex: 1;
            overflow-y: auto;
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 10px;
            background: #f8f9fa;
        }
        
        .search-result-item {
            padding: 12px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-result-item:hover {
            background: #e3f2fd;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .search-result-item.selected {
            background: #d0ebff;
            border-color: #0056cc;
            border-width: 2px;
        }
        
        .result-point-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }
        
        .result-point-coords {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }
        
        #search-no-results {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        
        #search-points-close {
            margin-top: 15px;
            padding: 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        #search-points-close:hover {
            background: #545b62;
        }
        
        /* –ù–û–í–´–ô –°–¢–ò–õ–¨: –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –∫–∞–∫ –≤ Android –≤–µ—Ä—Å–∏–∏ */
        #search-panel {
            position: absolute;
            top: calc(58px + var(--safe-area-inset-top));
            left: calc(60px + var(--safe-area-inset-left));
            width: 220px;
            display: none;
            z-index: 1003;
            transition: all 0.3s ease;
        }
        
        #search-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #aaa;
            border-radius: 4px;
            font-size: 14px;
            font-family: Calibri, Arial, sans-serif;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        #search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }
        
        #search-results-panel {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 2px solid #aaa;
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: none;
        }
        
        .search-result-item-panel {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
            font-family: Calibri, Arial, sans-serif;
            border-bottom: 1px solid #eee;
            -webkit-tap-highlight-color: transparent;
        }
        
        .search-result-item-panel:hover {
            background-color: #f0f8ff;
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏ (—Å–∏–Ω–∏–π –º–∞—Ä–∫–µ—Ä —Å –æ—Ä–µ–æ–ª–æ–º) */
        .search-highlight-marker {
            z-index: 10000 !important;
        }
        
        .search-highlight-marker .leaflet-marker-icon {
            filter: drop-shadow(0 0 8px rgba(0, 102, 204, 0.8));
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –æ—Ä–µ–æ–ª–∞ –≤–æ–∫—Ä—É–≥ –º–∞—Ä–∫–µ—Ä–∞ */
        .search-halo {
            animation: halo-pulse 2s infinite;
            z-index: 9999 !important;
        }
        
        @keyframes halo-pulse {
            0% {
                opacity: 0.7;
                transform: scale(1);
            }
            50% {
                opacity: 0.9;
                transform: scale(1.1);
            }
            100% {
                opacity: 0.7;
                transform: scale(1);
            }
        }
		
		/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ö–ü 2025 –Ω–∞ –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç–∞—Ö */
		#kp-layer-btn {
			font-size: 13px !important;
			font-weight: bold !important;
		}

		/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ö–ü 2025 –Ω–∞ Google Satellite - –¢–ê–ö–û–ô –ñ–ï –†–ê–ó–ú–ï–† */
		#kp-layer-btn-google {
			font-size: 13px !important;
			font-weight: bold !important;
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 0;
			margin: 0;
		}
		
    </style>
</head>
<body>
    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ -->
    <div id="menu-button">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div id="left-controls">
        <button class="control-btn" id="zoom-in">+</button>
        <button class="control-btn" id="zoom-out">‚àí</button>
        <div id="zoom-level-display">0</div>
        <button id="search-points-btn" title="–ü–æ–∏—Å–∫ —Ç–æ—á–µ–∫">üîç</button>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ (Android —Å—Ç–∏–ª—å) -->
    <div id="search-panel">
        <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ—á–µ–∫...">
        <div id="search-results-panel"></div>
    </div>
    
    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç (byaki.png, map2.png) -->
    <div id="basic-map-right-controls" style="display: none;">
        <button id="kp-layer-btn">–ö–ü 2025</button>
    </div>
    
    <div id="basic-map-left-controls" style="display: none;">
        <button id="undo-btn" style="display: none;">‚Ü©Ô∏è</button>
        <button id="lock-btn">üîì</button>
    </div>
    
    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è Google Satellite -->
    <div id="google-map-right-controls" style="display: none;">
        <button id="json-points-btn" style="display: none;">üìç</button>
    </div>
    
    <div id="google-map-left-controls" style="display: none;">
        <button id="undo-btn-google" style="display: none;">‚Ü©Ô∏è</button>
        <button id="lock-btn-google">üîì</button>
        <button id="kp-layer-btn-google">–ö–ü 2025</button>
    </div>
    
    <!-- –ë–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –º–µ—Ç–∫–∞–º–∏ - –ï–©–ï –ù–ò–ñ–ï –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ -->
    <div id="points-controls-container">
        <div id="points-controls-main">
            <button id="points-layer-btn" class="points-control-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –º–µ—Ç–∫–∏">üìå</button>
        </div>
        <div id="points-controls-expanded">
            <button id="add-point-btn" class="points-control-btn" title="–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É">‚ûï</button>
            <button id="edit-points-btn" class="points-control-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∫–∏">‚úèÔ∏è</button>
            <button id="cancel-edit-btn" class="points-control-btn" title="–í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">‚ùå</button>
            <button id="delete-point-btn" class="points-control-btn" title="–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–µ—Ç–∫—É">üóëÔ∏è</button>
        </div>
    </div>
    
    <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é -->
    <div id="dropdown-menu">
        <div class="menu-section">
            <span class="menu-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É:</span>
            <select id="background-select">
                <option value="byaki.png">–ë–∞–∑–æ–≤–∞—è –∫–∞—Ä—Ç–∞</option>
                <option value="map2.png">–ö–∞—Ä—Ç–∞ —Å –∑–∞–ª–∏–≤–∫–æ–π</option>
                <option value="google-satellite">Google Satellite</option>
            </select>
        </div>
        
        <div class="menu-section route-io-section">
            <div style="text-align: center; font-weight: bold; margin-bottom: 8px; font-size: 13px;">–ú–∞—Ä—à—Ä—É—Ç</div>
            <div class="route-save-row">
                <span class="menu-label inline">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å:</span>
                <input type="text" id="route-name" placeholder="–ò–º—è –º–∞—Ä—à—Ä—É—Ç–∞">
                <button class="menu-btn icon-only" id="save-route">üíæ</button>
            </div>
            <div class="route-load-row">
                <span class="menu-label inline">–ó–∞–≥—Ä—É–∑–∏—Ç—å:</span>
                <button class="menu-btn icon-only" id="load-route">üìÅ</button>
                <input type="file" id="route-file-input" accept=".json" style="display: none;">
            </div>
        </div>
        
        <div class="menu-section route-io-section">
            <div style="text-align: center; font-weight: bold; margin-bottom: 8px; font-size: 13px;">–ú–µ—Ç–∫–∏</div>
            <div class="route-save-row">
                <span class="menu-label inline">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å:</span>
                <input type="text" id="bookmark-name" placeholder="–ò–º—è –º–µ—Ç–æ–∫">
                <button class="menu-btn icon-only" id="save-bookmark">üíæ</button>
            </div>
            <div class="route-load-row">
                <span class="menu-label inline">–ó–∞–≥—Ä—É–∑–∏—Ç—å:</span>
                <button class="menu-btn icon-only" id="load-bookmark">üìÅ</button>
                <input type="file" id="bookmark-file-input" accept=".geojson" style="display: none;">
            </div>
        </div>
        
        <div class="menu-section">
            <button class="menu-btn" id="show-disclaimer">‚ÑπÔ∏è –û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</button>
        </div>
        <div class="menu-copyright">
            <a href="https://t.me/Aleks_Donor" target="_blank" rel="noopener noreferrer">
                ¬© by Alex Donor
            </a>
        </div>
    </div>
    
    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–º -->
    <button id="clear-route-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ - –°–ú–ï–©–ï–ù–ê –ï–©–ï –ù–ò–ñ–ï -->
    <button id="show-route-points-btn">üìç</button>
    
    <!-- –û–∫–Ω–æ –Ω–∏—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ - –¢–ê–ö–ñ–ï –°–ú–ï–©–ï–ù–û -->
    <div id="route-points-popup">
        <div style="font-weight: bold; margin-bottom: 8px; font-size: 13px;">–ù–∏—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞:</div>
        <div id="route-points-list"></div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ -->
    <div id="map"></div>
    
    <!-- –°—Ç–∞—Ç—É—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ -->
    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    
    <!-- –û–≤–µ—Ä–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loading-overlay">
        <div id="loading-modal">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ‚Ä¶<br>–ú–∞—Ä—à—Ä—É—Ç —Å—Ç—Ä–æ–∏—Ç—Å—è</div>
    </div>
    
    <!-- –ü–æ–ø–∞–ø –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫ -->
    <div id="add-point-overlay"></div>
    <div id="add-point-popup">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –º–µ—Ç–∫—É</h3>
        <label for="point-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" id="point-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
        <label for="point-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea id="point-comment" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" rows="3"></textarea>
        <div id="add-point-popup-buttons">
            <button id="add-point-cancel">–û—Ç–º–µ–Ω–∞</button>
            <button id="add-point-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <!-- –ü–æ–ø–∞–ø –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫ -->
    <div id="edit-point-overlay" class="custom-dialog-overlay">
        <div id="edit-point-popup" class="custom-dialog" style="width: 300px;">
            <div class="custom-dialog-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∫—É</div>
            <div class="custom-dialog-message">
                <label for="edit-point-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" id="edit-point-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                <label for="edit-point-comment" style="margin-top: 10px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="edit-point-comment" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" rows="3"></textarea>
            </div>
            <div class="custom-dialog-buttons">
                <button id="edit-point-cancel" class="custom-dialog-button">–û—Ç–º–µ–Ω–∞</button>
                <button id="edit-point-delete" class="custom-dialog-button" style="background: #f44336; color: white;">–£–¥–∞–ª–∏—Ç—å</button>
                <button id="edit-point-save" class="custom-dialog-button" style="background: #4CAF50; color: white;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ -->
    <div id="custom-alert-overlay" class="custom-dialog-overlay">
        <div class="custom-dialog">
            <div class="custom-dialog-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div class="custom-dialog-message" id="custom-alert-message"></div>
            <div class="custom-dialog-buttons">
                <button id="custom-alert-ok" class="custom-dialog-button custom-dialog-button-ok">OK</button>
            </div>
        </div>
    </div>
    
    <!-- –û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ -->
    <div id="disclaimer-overlay" class="custom-dialog-overlay">
        <div style="
            background: white;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        ">
            <h3 style="margin-top: 0; margin-bottom: 15px; color: #222; text-align: center;">–û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</h3>
            <div style="text-align: justify;">
                <p style="margin-top: 0; margin-bottom: 12px;">–ù–∞—Å—Ç–æ—è—â–µ–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ (–¥–∞–ª–µ–µ ‚Äî –ü—Ä–æ–¥—É–∫—Ç) —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –∏ —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö –∏ –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–∞–∫–æ–π-–ª–∏–±–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏–ª–∏ –Ω–µ–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å –ø—Ä–µ–±—ã–≤–∞–Ω–∏–µ–º –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Ä–∞–±–æ—Ç –ø–æ–¥ –∑–µ–º–ª—ë–π, –≤–∫–ª—é—á–∞—è, –Ω–æ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—è—Å—å: —Å–ø–µ–ª–µ–æ–ª–æ–≥–∏–µ–π, –ø–æ–¥–∑–µ–º–Ω—ã–º —Ç—É—Ä–∏–∑–º–æ–º, –≥–æ—Ä–Ω—ã–º–∏, —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–º–∏, –∞–≤–∞—Ä–∏–π–Ω–æ-—Å–ø–∞—Å–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∏ –∏–Ω—ã–º–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º–∏ –≤–∏–¥–∞–º–∏ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.</p>
                <p style="margin-top: 0; margin-bottom: 12px;">–ê–≤—Ç–æ—Ä –ü—Ä–æ–¥—É–∫—Ç–∞ –Ω–µ –¥–∞—ë—Ç –Ω–∏–∫–∞–∫–∏—Ö –≥–∞—Ä–∞–Ω—Ç–∏–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–æ—á–Ω–æ—Å—Ç–∏, –ø–æ–ª–Ω–æ—Ç—ã, –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –∏–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤, –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∏–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–æ—Å—è—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏.</p>
                <p style="margin-top: 0; margin-bottom: 12px;">–ê–≤—Ç–æ—Ä –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ª—é–±–æ–π —É—â–µ—Ä–±, —É–±—ã—Ç–∫–∏, —Ç—Ä–∞–≤–º—ã –∏–ª–∏ –∏–Ω—ã–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è, –≤–æ–∑–Ω–∏–∫—à–∏–µ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ü—Ä–æ–¥—É–∫—Ç–∞, –≤ —Ç–æ–º —á–∏—Å–ª–µ –ø—Ä–∏ –µ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –≤ —É—Å–ª–æ–≤–∏—è—Ö, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —Ä–∏—Å–∫–æ–º –¥–ª—è –∂–∏–∑–Ω–∏ –∏ –∑–¥–æ—Ä–æ–≤—å—è.</p>
                <p style="margin-top: 0; margin-bottom: 12px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ü—Ä–æ–¥—É–∫—Ç –Ω–∞ —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ –∏ –æ—Å–æ–∑–Ω–∞—ë—Ç, —á—Ç–æ –æ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∏–ª–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏–ª–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∑–µ–º–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤.</p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="close-disclaimer" style="
                    padding: 8px 20px;
                    font-size: 14px;
                    background: #dcdcdc;
                    border: 1px solid #aaa;
                    border-radius: 5px;
                    cursor: pointer;
                    font-weight: bold;
                    min-width: 100px;
                ">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 4,
            zoomControl: false,
            tap: false,
            touchZoom: true,
            scrollWheelZoom: true,
            dragging: true,
            wheelPxPerZoomLevel: 60
        });
        
        let currentImageOverlay = null;
        let googleSatelliteLayer = null;
        let currentMapType = 'byaki.png';
        let entranceMarker = null;
        let routeLocked = false;
        let menuOpen = false;
        let isUserPointsMode = false;
        let isEditMode = false;
        let pendingPointCoords = null;
        let selectedPointIndex = null;
        
        // –°–ª–æ–∏ –∏ –º–∞—Ä–∫–µ—Ä—ã
        let kpLayer = null;
        let kpLayerVisible = false;
        let kpMarkers = [];
        let kpLabels = [];
        let userPointsLayer = null;
        let userPointsLayerVisible = false;
        let userPointMarkers = [];
        let userPointLabels = [];
        let jsonPointsLayer = null;
        let jsonPointsLayerVisible = false;
        let jsonPointsMarkers = [];
        let jsonPointsLabels = [];
        
        // –î–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞
        let segments = [];
        let graph = {};
        let segmentWeights = {};
        let selectedPoints = [];
        let pointMarkers = [];
        let routeLayer = null;
        let routePointMarkers = [];
        let routeLabelMarkers = [];
        let mapBounds = null;
        let fullRoutePath = [];
        let allPointsGeoJson = null;
        
        const SCALE_CORRECTION = 84 / 145.9;
        const ENTRANCE_COORDS_EPSG3857 = [4252305.4, 7245838.4];
        
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
        let userPointsData = { type: "FeatureCollection", features: [] };
        
        // –°–ø–∏—Å–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤
        const REQUIRED_FILES = [
            'tunnels_json.geojson',
            'kp_2025.geojson', 
            'points_json.geojson',
            'byaki.png',
            'map2.png'
        ];
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ (Android —Å—Ç–∏–ª—å)
        let searchPanelVisible = false;
        let searchHighlightMarker = null; // –ú–∞—Ä–∫–µ—Ä –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏
        let searchHaloMarker = null; // –û—Ä–µ–æ–ª –≤–æ–∫—Ä—É–≥ –º–∞—Ä–∫–µ—Ä–∞
        let lastSearchQuery = '';
        
        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function updateZoomDisplay() {
            const zoom = map.getZoom();
            document.getElementById('zoom-level-display').textContent = Math.round(zoom);
        }
        
        function showCustomAlert(message) {
            const overlay = document.getElementById('custom-alert-overlay');
            const messageEl = document.getElementById('custom-alert-message');
            messageEl.textContent = message;
            overlay.style.display = 'flex';
            
            document.getElementById('custom-alert-ok').onclick = () => {
                overlay.style.display = 'none';
            };
            
            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.style.display = 'none';
            };
        }
        
        function hideLoadingOverlay() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        function showLoadingOverlay(message = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ‚Ä¶<br>–ú–∞—Ä—à—Ä—É—Ç —Å—Ç—Ä–æ–∏—Ç—Å—è") {
            document.getElementById('loading-modal').innerHTML = message;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        
        function wgs84ToEpsg3857(lat, lng) {
            const R = 6378137;
            const x = (lng * Math.PI / 180) * R;
            const y = Math.log(Math.tan((90 + lat) * Math.PI / 360)) * R;
            return [x, y];
        }
        
        function epsg3857ToWgs84(x, y) {
            const R = 6378137;
            const lng = (x / R) * (180 / Math.PI);
            const lat = (Math.PI / 2 - 2 * Math.atan(Math.exp(-y / R))) * (180 / Math.PI);
            return [lat, lng];
        }
        
        function addEntranceMarker() {
            if (entranceMarker) {
                map.removeLayer(entranceMarker);
                entranceMarker = null;
            }
        
            if (currentMapType === 'google-satellite') {
                const [x, y] = ENTRANCE_COORDS_EPSG3857;
                const [lat, lng] = epsg3857ToWgs84(x, y);
        
                entranceMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'entrance-marker-large',
                        html: '<span style="font-size: 30px">üö∑</span>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map).bindPopup("–í—Ö–æ–¥ –≤ –ì—É—Ä—å–µ–≤—Å–∫–∏–µ –∫–∞–º–µ–Ω–æ–ª–æ–º–Ω–∏");
            } else {
                const [x, y] = ENTRANCE_COORDS_EPSG3857;
                entranceMarker = L.marker([y, x], {
                    icon: L.divIcon({
                        className: 'entrance-marker-large',
                        html: '<span style="font-size: 30px">üö∑</span>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã
        function updateControlsVisibility() {
            const isGoogleSatellite = currentMapType === 'google-satellite';
            
            if (isGoogleSatellite) {
                // –ü–æ–∫–∞–∑–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è Google Satellite
                document.getElementById('google-map-right-controls').style.display = 'flex';
                document.getElementById('google-map-left-controls').style.display = 'flex';
                document.getElementById('basic-map-right-controls').style.display = 'none';
                document.getElementById('basic-map-left-controls').style.display = 'none';
                
                // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ"
                document.getElementById('json-points-btn').style.display = 'flex';
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                document.getElementById('kp-layer-btn-google').classList.toggle('active', kpLayerVisible);
                document.getElementById('lock-btn-google').textContent = routeLocked ? 'üîí' : 'üîì';
                
                // –û–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ undo
                if (selectedPoints.length > 0) {
                    document.getElementById('undo-btn-google').style.display = 'flex';
                } else {
                    document.getElementById('undo-btn-google').style.display = 'none';
                }
            } else {
                // –ü–æ–∫–∞–∑–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç
                document.getElementById('basic-map-right-controls').style.display = 'flex';
                document.getElementById('basic-map-left-controls').style.display = 'flex';
                document.getElementById('google-map-right-controls').style.display = 'none';
                document.getElementById('google-map-left-controls').style.display = 'none';
                
                // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                document.getElementById('kp-layer-btn').classList.toggle('active', kpLayerVisible);
                document.getElementById('lock-btn').textContent = routeLocked ? 'üîí' : 'üîì';
                
                // –û–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ undo
                if (selectedPoints.length > 0) {
                    document.getElementById('undo-btn').style.display = 'flex';
                } else {
                    document.getElementById('undo-btn').style.display = 'none';
                }
            }
        }
        
        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –º–µ—Ç–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã –∏ –∑—É–º–∞
        function updateMarkersVisibilityForCurrentMap() {
            const zoom = map.getZoom();
            const isGoogleSatellite = currentMapType === 'google-satellite';
            
            if (isGoogleSatellite) {
                // –ù–∞ Google Satellite –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç–∫–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ zoom >= 17
                const showLabels = zoom >= 17;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–µ–π –ö–ü
                kpLabels.forEach(label => {
                    const element = label.getElement();
                    if (element) {
                        element.style.display = showLabels ? '' : 'none';
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–µ–π JSON —Ç–æ—á–µ–∫
                jsonPointsLabels.forEach(label => {
                    const element = label.getElement();
                    if (element) {
                        element.style.display = showLabels ? '' : 'none';
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫
                userPointLabels.forEach(label => {
                    const element = label.getElement();
                    if (element) {
                        element.style.display = showLabels ? '' : 'none';
                    }
                });
            } else {
                // –ù–∞ –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç–∞—Ö (byaki.png, map2.png) –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç–∫–∏
                // (–µ—Å–ª–∏ –æ–Ω–∏ –≤–∫–ª—é—á–µ–Ω—ã –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è)
                kpLabels.forEach(label => {
                    const element = label.getElement();
                    if (element) {
                        element.style.display = kpLayerVisible ? '' : 'none';
                    }
                });
                
                jsonPointsLabels.forEach(label => {
                    const element = label.getElement();
                    if (element) {
                        element.style.display = jsonPointsLayerVisible ? '' : 'none';
                    }
                });
                
                userPointLabels.forEach(label => {
                    const element = label.getElement();
                    if (element) {
                        element.style.display = userPointsLayerVisible ? '' : 'none';
                    }
                });
            }
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ====================
        async function loadGeoJsonFile(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${filename}:`, error);
                return { type: "FeatureCollection", features: [] };
            }
        }
        
        async function loadTunnelsData() {
            const data = await loadGeoJsonFile('tunnels_json.geojson');
            processGeoJsonData(data);
        }
        
        async function loadKpData() {
            const data = await loadGeoJsonFile('kp_2025.geojson');
            return data;
        }
        
        async function loadPointsData() {
            const data = await loadGeoJsonFile('points_json.geojson');
            allPointsGeoJson = data;
            return data;
        }
        
        function processGeoJsonData(data) {
            if (!data || data.type !== "FeatureCollection" || !Array.isArray(data.features)) {
                console.error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ GeoJSON —Ñ–∞–π–ª–∞.');
                return;
            }
        
            const allCoords = [];
            segments = [];
            graph = {};
            segmentWeights = {};
        
            data.features.forEach(f => {
                if (!f.geometry) return;
                let lines = [];
                if (f.geometry.type === 'LineString') lines = [f.geometry.coordinates];
                else if (f.geometry.type === 'MultiLineString') lines = f.geometry.coordinates;
                else return;
        
                let weight = f.properties?.weight || 5;
                lines.forEach(coords => {
                    if (!Array.isArray(coords) || coords.length < 2) return;
                    coords.forEach(pt => {
                        if (Array.isArray(pt) && pt.length >= 2) {
                            allCoords.push(pt);
                        }
                    });
                    for (let i = 0; i < coords.length - 1; i++) {
                        const a = coords[i];
                        const b = coords[i + 1];
                        if (!Array.isArray(a) || !Array.isArray(b) || a.length < 2 || b.length < 2) continue;
        
                        segments.push([a, b]);
                        const keyA = a.join(',');
                        const keyB = b.join(',');
                        const baseLength = Math.hypot(a[0] - b[0], a[1] - b[1]);
                        let cost;
                        if (weight === 1) cost = baseLength * 1000; // –ó–∞–≤–∞–ª
                        else if (weight === 2) cost = baseLength * 4; // –®–∫—É—Ä–æ–¥–µ—Ä
                        else if (weight === 3) cost = baseLength * 1.5; // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ
                        else if (weight === 4) cost = baseLength * 5; // –í–æ–¥–∞
                        else cost = baseLength; // –°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥
        
                        if (!graph[keyA]) graph[keyA] = {};
                        if (!graph[keyB]) graph[keyB] = {};
                        if (!graph[keyA][keyB] || cost < graph[keyA][keyB]) {
                            graph[keyA][keyB] = cost;
                            graph[keyB][keyA] = cost;
                            const segmentKey = `${keyA}-${keyB}`;
                            const reverseKey = `${keyB}-${keyA}`;
                            segmentWeights[segmentKey] = weight;
                            segmentWeights[reverseKey] = weight;
                        }
                    }
                });
            });
        
            if (allCoords.length > 0) {
                const xs = allCoords.map(c => c[0]);
                const ys = allCoords.map(c => c[1]);
                const minX = Math.min(...xs);
                const minY = Math.min(...ys);
                const maxX = Math.max(...xs);
                const maxY = Math.max(...ys);
                mapBounds = [[minY, minX], [maxY, maxX]];
            } else {
                mapBounds = [[0, 0], [1000, 1000]];
            }
        }
        
        // ==================== –ê–õ–ì–û–†–ò–¢–ú A* ====================
        class PriorityQueue {
            constructor() {
                this.heap = [];
                this.nodeMap = new Map();
            }
        
            push(node, priority) {
                const item = { node, priority };
                this.heap.push(item);
                this.nodeMap.set(node, this.heap.length - 1);
                this._siftUp(this.heap.length - 1);
            }
        
            pop() {
                if (this.heap.length === 0) return null;
                if (this.heap.length === 1) {
                    const item = this.heap.pop();
                    this.nodeMap.delete(item.node);
                    return item.node;
                }
        
                const top = this.heap[0];
                const last = this.heap.pop();
                this.heap[0] = last;
                this.nodeMap.set(last.node, 0);
                this.nodeMap.delete(top.node);
                this._siftDown(0);
                return top.node;
            }
        
            isEmpty() {
                return this.heap.length === 0;
            }
        
            _siftUp(index) {
                while (index > 0) {
                    const parent = Math.floor((index - 1) / 2);
                    if (this.heap[parent].priority <= this.heap[index].priority) break;
                    this._swap(parent, index);
                    index = parent;
                }
            }
        
            _siftDown(index) {
                const n = this.heap.length;
                while (true) {
                    let left = 2 * index + 1;
                    let right = 2 * index + 2;
                    let smallest = index;
        
                    if (left < n && this.heap[left].priority < this.heap[smallest].priority) {
                        smallest = left;
                    }
                    if (right < n && this.heap[right].priority < this.heap[smallest].priority) {
                        smallest = right;
                    }
                    if (smallest === index) break;
        
                    this._swap(index, smallest);
                    index = smallest;
                }
            }
        
            _swap(i, j) {
                [this.heap[i], this.heap[j]] = [this.heap[j], this.heap[i]];
                this.nodeMap.set(this.heap[i].node, i);
                this.nodeMap.set(this.heap[j].node, j);
            }
        }
        
        function heuristic(a, b) {
            const [ax, ay] = a.split(',').map(Number);
            const [bx, by] = b.split(',').map(Number);
            return Math.sqrt(Math.pow(bx - ax, 2) + Math.pow(by - ay, 2));
        }
        
        function aStar(graph, start, end, segmentWeights) {
            if (start === end) return [start.split(',').map(Number)];
            if (!graph[start] || !graph[end]) return null;
        
            const openSet = new PriorityQueue();
            const cameFrom = new Map();
            const gScore = new Map();
            const fScore = new Map();
        
            gScore.set(start, 0);
            fScore.set(start, heuristic(start, end));
            openSet.push(start, fScore.get(start));
        
            while (!openSet.isEmpty()) {
                const current = openSet.pop();
        
                if (current === end) {
                    const path = [];
                    let node = current;
                    while (node) {
                        path.unshift(node.split(',').map(Number));
                        node = cameFrom.get(node);
                    }
                    return path;
                }
        
                for (const neighbor in graph[current]) {
                    const tentativeGScore = gScore.get(current) + graph[current][neighbor];
        
                    if (!gScore.has(neighbor) || tentativeGScore < gScore.get(neighbor)) {
                        cameFrom.set(neighbor, current);
                        gScore.set(neighbor, tentativeGScore);
                        fScore.set(neighbor, tentativeGScore + heuristic(neighbor, end));
        
                        openSet.push(neighbor, fScore.get(neighbor));
                    }
                }
            }
        
            return null;
        }
        
        // ==================== –†–ê–ë–û–¢–ê –° –ú–ê–†–®–†–£–¢–û–ú ====================
        function calculateRealDistance(coord1, coord2) {
            const dx = coord1[0] - coord2[0];
            const dy = coord1[1] - coord2[1];
            const pixelDistance = Math.sqrt(dx * dx + dy * dy);
            return pixelDistance * SCALE_CORRECTION;
        }
        
        function getColorForSegment(start, end) {
            const startKey = start.join(',');
            const endKey = end.join(',');
            const segmentKey = `${startKey}-${endKey}`;
            const reverseKey = `${endKey}-${startKey}`;
            const weight = segmentWeights[segmentKey] || segmentWeights[reverseKey];
        
            if (weight === 1) return '#000000';      // –ó–∞–≤–∞–ª
            else if (weight === 2) return '#ff0000'; // –®–∫—É—Ä–æ–¥–µ—Ä
            else if (weight === 3) return '#ffa500'; // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ
            else if (weight === 4) return '#0000ff'; // –í–æ–¥–∞
            else return '#00ff00';                   // –°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥
        }
        
        function buildFullRoute() {
            if (selectedPoints.length < 2) {
                showCustomAlert('–î–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≥—Ä–∞—Ñ —Å–æ–∑–¥–∞–Ω
            if (Object.keys(graph).length === 0) {
                showCustomAlert('–ì—Ä–∞—Ñ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª tunnels_json.geojson');
                return;
            }
        
            showLoadingOverlay();
        
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏
            setTimeout(() => {
                try {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä—à—Ä—É—Ç
                    if (routeLayer) {
                        map.removeLayer(routeLayer);
                        routeLayer = null;
                    }
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∏ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞
                    routePointMarkers.forEach(marker => map.removeLayer(marker));
                    routeLabelMarkers.forEach(marker => map.removeLayer(marker));
                    routePointMarkers = [];
                    routeLabelMarkers = [];
            
                    fullRoutePath = [];
                    const routeGroup = L.featureGroup();
                    let totalDistance = 0;
            
                    for (let i = 0; i < selectedPoints.length - 1; i++) {
                        const start = selectedPoints[i];
                        const end = selectedPoints[i + 1];
                        const startKey = start.join(',');
                        const endKey = end.join(',');
            
                        const segmentPath = aStar(graph, startKey, endKey, segmentWeights);
            
                        if (!segmentPath) {
                            showCustomAlert(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø—É—Ç—å –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ ${i+1} –∏ ${i+2}`);
                            hideLoadingOverlay();
                            return;
                        }
            
                        if (i === 0) fullRoutePath.push(...segmentPath);
                        else fullRoutePath.push(...segmentPath.slice(1));
            
                        for (let j = 1; j < segmentPath.length; j++) {
                            const a = segmentPath[j - 1];
                            const b = segmentPath[j];
                            totalDistance += calculateRealDistance(a, b);
            
                            let coords;
                            if (currentMapType === 'google-satellite') continue;
                            else coords = [[a[1], a[0]], [b[1], b[0]]];
            
                            L.polyline(coords, {
                                color: getColorForSegment(a, b),
                                weight: 6,
                                opacity: 0.8
                            }).addTo(routeGroup);
                        }
                    }
            
                    if (currentMapType !== 'google-satellite') {
                        routeLayer = routeGroup.addTo(map);
                        document.getElementById('status').innerHTML = 
                            `–ú–∞—Ä—à—Ä—É—Ç: <span class="route-distance">${totalDistance.toFixed(1)} –º</span>`;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏ –∫ —Ç–æ—á–∫–∞–º –º–∞—Ä—à—Ä—É—Ç–∞ (–°–¢–ê–†–¢/–§–ò–ù–ò–®/–Ω–æ–º–µ—Ä–∞) —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
                        addRoutePointLabels();
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏ –∫ —Ç–æ—á–∫–∞–º –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ (–∏–∑ JSON) —Å –Ω–∏–∑–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
                        addRouteJsonPointLabels();
                    }
            
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∞
                    updateRoutePointsList();
                    
                    updateRouteButtonsVisibility();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                    showCustomAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.');
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    if (selectedPoints.length > 0) {
                        document.getElementById('status').textContent = 
                            `–í—ã–±—Ä–∞–Ω–æ ${selectedPoints.length} —Ç–æ—á–µ–∫. –û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è.`;
                    }
                } finally {
                    // –í—Å–µ–≥–¥–∞ —Å–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏
                    hideLoadingOverlay();
                }
            }, 10); // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ–≤–µ—Ä–ª–µ—è
        }
        
        function addRoutePointLabels() {
			// –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∏
			routeLabelMarkers.forEach(marker => map.removeLayer(marker));
			routeLabelMarkers = [];
			
			// –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∏
			selectedPoints.forEach((pt, idx) => {
				const latlng = [pt[1], pt[0]];
				let labelText;
				if (idx === 0) {
					labelText = '–°–¢–ê–†–¢';
				} else if (idx === selectedPoints.length - 1) {
					labelText = '–§–ò–ù–ò–®';
				} else {
					labelText = String(idx);
				}
				
				const label = L.marker(latlng, {
					icon: L.divIcon({
						className: 'route-point-label',
						html: `<div style="
							background: linear-gradient(135deg, #ff9800, #ffb74d);
							border: 2px solid #0d47a1; /* –°–ò–ù–Ø–Ø –†–ê–ú–ö–ê –¢–û–õ–¨–ö–û –ó–î–ï–°–¨ */
							border-radius: 4px;
							padding: 2px 6px;
							color: #0d47a1;
							font-weight: bold;
							font-size: 12px;
							white-space: nowrap;
							text-shadow: 1px 1px 2px white;
							box-shadow: 0 2px 4px rgba(0,0,0,0.3);
						">${labelText}</div>`,
						iconSize: null,
						iconAnchor: [0, -15]
					}),
					interactive: false,
					zIndexOffset: 1000
				}).addTo(map);
				
				routeLabelMarkers.push(label);
				
				// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –º–∞—Ä–∫–µ—Ä–∞
				updatePointMarkerStyle(idx);
			});
		}
        
        function updatePointMarkerStyle(idx) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ —Ç–æ—á–∫–∏
            if (pointMarkers[idx]) {
                let color, fillColor;
                if (idx === 0) {
                    color = 'white'; // –ë–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞ –¥–ª—è –°–¢–ê–†–¢
                    fillColor = 'green';
                } else if (idx === pointMarkers.length - 1) {
                    color = 'white'; // –ë–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞ –¥–ª—è –§–ò–ù–ò–®
                    fillColor = 'blue';
                } else {
                    color = 'white'; // –ë–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞ –¥–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫
                    fillColor = 'red';
                }
                
                pointMarkers[idx].setStyle({ 
                    color: color,
                    fillColor: fillColor,
                    weight: 2, // –¢–æ–ª—â–∏–Ω–∞ –æ–±–≤–æ–¥–∫–∏
                    className: 'route-point-marker' // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
                });
            }
        }
        
        function addRouteJsonPointLabels() {
            if (!allPointsGeoJson || currentMapType === 'google-satellite') return;
            
            const nearbyPoints = findPointsNearRoute(fullRoutePath, allPointsGeoJson, 2.5);
            
            nearbyPoints.forEach(point => {
                const latlng = [point.coords[1], point.coords[0]];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ –ø–æ–¥–ø–∏—Å–∏ –º–∞—Ä—à—Ä—É—Ç–∞ (–°–¢–ê–†–¢/–§–ò–ù–ò–®/–Ω–æ–º–µ—Ä)
                const hasRouteLabel = routeLabelMarkers.some(label => {
                    const labelLatLng = label.getLatLng();
                    return Math.abs(labelLatLng.lat - latlng[0]) < 0.0001 && 
                           Math.abs(labelLatLng.lng - latlng[1]) < 0.0001;
                });
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å—å –º–∞—Ä—à—Ä—É—Ç–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç—É —Ç–æ—á–∫—É
                if (hasRouteLabel) return;
                
                // –ú–∞—Ä–∫–µ—Ä —Ç–æ—á–∫–∏
                const marker = L.circleMarker(latlng, {
                    radius: 5,
                    color: '#0000FF',
                    fillColor: '#33FFEE',
                    weight: 2,
                    fillOpacity: 2
                }).addTo(map);
                routePointMarkers.push(marker);
                
                // –ü–æ–¥–ø–∏—Å—å —Ç–æ—á–∫–∏ (—Å—Ç–∞—Ä—ã–π —Å—Ç–∏–ª—å - —Å–∏–Ω–∏–π –≤ –≥–æ–ª—É–±–æ–π —Ä–∞–º–∫–µ) —Å –Ω–∏–∑–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
                const label = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'route-point-label-old',
                        html: point.name.length > 15 ? point.name.substring(0, 12) + '...' : point.name,
                        iconSize: null,
                        iconAnchor: [0, -10]
                    }),
                    interactive: false,
                    pane: 'markerPane' // –ò—Å–ø–æ–ª—å–∑—É–µ–º markerPane –¥–ª—è –Ω–∏–∑–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
                }).addTo(map);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∏–∑–∫–∏–π z-index
                if (label.getElement()) {
                    label.getElement().style.zIndex = '100';
                }
                
                routeLabelMarkers.push(label);
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑—É–º–∞
        function updateLabelVisibility() {
            const zoom = map.getZoom();
            
            // –ï—Å–ª–∏ –∑—É–º –º–µ–Ω—å—à–µ 0, —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∏ —Ç–æ—á–µ–∫ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ (–∏–∑ JSON)
            if (zoom < 0) {
                routeLabelMarkers.forEach(label => {
                    const element = label.getElement();
                    if (element && element.classList.contains('route-point-label-old')) {
                        element.classList.add('label-hidden');
                    }
                });
            } else {
                // –ï—Å–ª–∏ –∑—É–º 0 –∏–ª–∏ –±–æ–ª—å—à–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–¥–ø–∏—Å–∏
                routeLabelMarkers.forEach(label => {
                    const element = label.getElement();
                    if (element && element.classList.contains('route-point-label-old')) {
                        element.classList.remove('label-hidden');
                    }
                });
            }
            
            // –ü–æ–¥–ø–∏—Å–∏ –°–¢–ê–†–¢/–§–ò–ù–ò–®/–Ω–æ–º–µ—Ä–æ–≤ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã –Ω–∞ –ª—é–±–æ–º –∑—É–º–µ
            // –ù–æ –æ–Ω–∏ —É–∂–µ –∏–º–µ—é—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–µ—Ç–æ–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç—ã
            updateMarkersVisibilityForCurrentMap();
        }
        
        function findPointsNearRoute(routeCoords, pointsGeoJson, maxDistance = 2.5) {
            if (!pointsGeoJson || !pointsGeoJson.features) return [];
            
            const segments = [];
            let totalLength = 0;
            
            for (let i = 0; i < routeCoords.length - 1; i++) {
                const a = routeCoords[i];
                const b = routeCoords[i + 1];
                const len = Math.hypot(b[0] - a[0], b[1] - a[1]);
                segments.push({ start: a, end: b, length: len, startDist: totalLength });
                totalLength += len;
            }
            
            const nearbyPoints = [];
            const addedPointKeys = new Set();
            
            function getPointKey(coords) {
                return `${coords[0].toFixed(3)},${coords[1].toFixed(3)}`;
            }
            
            for (let segIndex = 0; segIndex < segments.length; segIndex++) {
                const seg = segments[segIndex];
                const { start, end } = seg;
                const dx = end[0] - start[0];
                const dy = end[1] - start[1];
                const l2 = dx * dx + dy * dy;
                
                pointsGeoJson.features.forEach(feature => {
                    if (feature.geometry.type !== "Point") return;
                    const pt = feature.geometry.coordinates;
                    const name = feature.properties?.Name;
                    
                    if (name == null || !Array.isArray(pt) || pt.length < 2) return;
                    const pointKey = getPointKey(pt);
                    if (addedPointKeys.has(pointKey)) return;
                    
                    let dist;
                    if (l2 === 0) dist = Math.hypot(pt[0] - start[0], pt[1] - start[1]);
                    else {
                        const t = Math.max(0, Math.min(1, ((pt[0] - start[0]) * dx + (pt[1] - start[1]) * dy) / l2));
                        const projX = start[0] + t * dx;
                        const projY = start[1] + t * dy;
                        dist = Math.hypot(pt[0] - projX, pt[1] - projY);
                    }
                    
                    if (dist <= maxDistance) {
                        const t = l2 === 0 ? 0 : Math.max(0, Math.min(1, ((pt[0] - start[0]) * dx + (pt[1] - start[1]) * dy) / l2));
                        const alongDist = seg.startDist + t * Math.sqrt(l2);
                        nearbyPoints.push({ name, coords: pt, alongDist });
                        addedPointKeys.add(pointKey);
                    }
                });
            }
            
            nearbyPoints.sort((a, b) => a.alongDist - b.alongDist);
            return nearbyPoints.map(p => ({ name: p.name, coords: p.coords }));
        }
        
        function updateRoutePointsList() {
            if (!allPointsGeoJson || fullRoutePath.length === 0) {
                document.getElementById('show-route-points-btn').style.display = 'none';
                document.getElementById('route-points-popup').style.display = 'none';
                return;
            }
            
            const nearbyPoints = findPointsNearRoute(fullRoutePath, allPointsGeoJson, 2.5);
            
            if (nearbyPoints.length > 0) {
                const listHtml = nearbyPoints.map((p, idx) => {
                    const displayName = p.name.length > 15 ? p.name.substring(0, 12) + '...' : p.name;
                    return `<div class="route-point-item" data-index="${idx}" data-lng="${p.coords[0]}" data-lat="${p.coords[1]}">‚Ä¢ ${displayName}</div>`;
                }).join('');
                
                document.getElementById('route-points-list').innerHTML = listHtml;
                document.getElementById('show-route-points-btn').style.display = 'block';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ —Ç–æ—á–∫–∏
                document.querySelectorAll('.route-point-item').forEach((item, idx) => {
                    item.addEventListener('click', (e) => {
                        const el = e.target.closest('.route-point-item');
                        if (!el) return;
                        const lng = parseFloat(el.getAttribute('data-lng'));
                        const lat = parseFloat(el.getAttribute('data-lat'));
                        if (isNaN(lng) || isNaN(lat)) return;
                        
                        let latlng;
                        if (currentMapType === 'google-satellite') {
                            const wgs84Coords = epsg3857ToWgs84(lng, lat);
                            latlng = [wgs84Coords[0], wgs84Coords[1]];
                        } else {
                            latlng = [lat, lng];
                        }
                        
                        map.setView(latlng, map.getZoom(), {
                            animate: true,
                            duration: 0.3
                        });
                    });
                });
            } else {
                document.getElementById('show-route-points-btn').style.display = 'none';
                document.getElementById('route-points-popup').style.display = 'none';
            }
        }
        
        function toggleRoutePointsPopup() {
            const popup = document.getElementById('route-points-popup');
            const btn = document.getElementById('show-route-points-btn');
            
            if (popup.style.display === 'block') {
                popup.style.display = 'none';
                btn.textContent = 'üìç';
            } else {
                popup.style.display = 'block';
                btn.textContent = 'üëÅÔ∏è';
            }
        }
        
        function clearRoute() {
            if (routeLayer) map.removeLayer(routeLayer);
            pointMarkers.forEach(marker => map.removeLayer(marker));
            routePointMarkers.forEach(marker => map.removeLayer(marker));
            routeLabelMarkers.forEach(marker => map.removeLayer(marker));
        
            routeLayer = null;
            selectedPoints = [];
            pointMarkers = [];
            routePointMarkers = [];
            routeLabelMarkers = [];
            fullRoutePath = [];
            routeLocked = false;
        
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∑–∞–º–∫–∞ –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ä—Ç
            document.getElementById('lock-btn').textContent = 'üîì';
            document.getElementById('lock-btn-google').textContent = 'üîì';
            
            document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞';
            document.getElementById('clear-route-btn').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ undo
            updateRouteButtonsVisibility();
            
            document.getElementById('show-route-points-btn').style.display = 'none';
            document.getElementById('route-points-popup').style.display = 'none';
        }
        
        function handleMapClick(e) {
            console.log('handleMapClick called, isEditMode:', isEditMode, 'isUserPointsMode:', isUserPointsMode);
            
            // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫ –ø–æ –º–µ—Ç–∫–µ
            if (isEditMode) {
                console.log('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω, –∏—â–µ–º –º–µ—Ç–∫—É');
                handleEditModeClick(e);
                return;
            }
            
            // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω
            if (isUserPointsMode) {
                console.log('–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω');
                // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–∞—Ä—Ç
                let coords;
                if (currentMapType === 'google-satellite') {
                    // –î–ª—è Google Satellite: latlng -> EPSG:3857
                    const epsg3857 = wgs84ToEpsg3857(e.latlng.lat, e.latlng.lng);
                    coords = epsg3857;
                } else {
                    // –î–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–∞—Ä—Ç: –º–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ lat –∏ lng
                    coords = [e.latlng.lng, e.latlng.lat];
                }
                pendingPointCoords = coords;
                showAddPointPopup();
                return;
            }
            
            // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –∞–∫—Ç–∏–≤–µ–Ω
            if (menuOpen || segments.length === 0 || routeLocked) return;
            
            const click = [e.latlng.lng, e.latlng.lat];
            const TOLERANCE = 4;
            let nearest = null;
            let minDist = Infinity;
            
            for (const node in graph) {
                const [x, y] = node.split(',').map(Number);
                const d = Math.hypot(x - click[0], y - click[1]);
                if (d < minDist) {
                    minDist = d;
                    nearest = [x, y];
                }
            }
            
            if (!nearest || minDist > TOLERANCE) {
                document.getElementById('status').textContent = '–ö–ª–∏–∫ —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –æ—Ç —Ç–æ–Ω–Ω–µ–ª–µ–π';
                return;
            }

            selectedPoints.push(nearest);
            const pointNumber = selectedPoints.length;
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Å –±–µ–ª–æ–π –æ–±–≤–æ–¥–∫–æ–π
            const marker = L.circle([nearest[1], nearest[0]], {
                radius: 3, // –ù–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–¥–∏—É—Å
                color: 'white', // –ë–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞ –¥–ª—è –≤—Å–µ—Ö —Ç–æ—á–µ–∫
                fillColor: pointNumber === 1 ? 'green' : pointNumber === selectedPoints.length ? 'blue' : 'red',
                weight: 2, // –¢–æ–ª—â–∏–Ω–∞ –æ–±–≤–æ–¥–∫–∏
                fillOpacity: 1,
                className: 'route-point-marker' // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
            }).addTo(map);
            
            pointMarkers.push(marker);
            
            if (selectedPoints.length === 1) {
                document.getElementById('status').textContent = '–í—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é.';
            } else {
                buildFullRoute();
            }
            
            document.getElementById('clear-route-btn').style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ undo
            updateRouteButtonsVisibility();
        }
        
        function handleEditModeClick(e) {
            console.log('handleEditModeClick called, –∏—â–µ–º –º–µ—Ç–∫—É —Ä—è–¥–æ–º —Å –∫–ª–∏–∫–æ–º:', e.latlng);
            
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –º–µ—Ç–∫—É
            let minDist = Infinity;
            let nearestIndex = -1;
            
            userPointMarkers.forEach((marker, index) => {
                const markerLatLng = marker.getLatLng();
                const dist = e.latlng.distanceTo(markerLatLng);
                console.log(`–ú–µ—Ç–∫–∞ ${index}: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ ${dist} –ø–∏–∫—Å–µ–ª–µ–π`);
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–¥–∏—É—Å –∫–ª–∏–∫–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
                if (dist < minDist && dist < 100) { // 100 –ø–∏–∫—Å–µ–ª–µ–π - —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–¥–∏—É—Å –∫–ª–∏–∫–∞
                    minDist = dist;
                    nearestIndex = index;
                }
            });
            
            if (nearestIndex !== -1) {
                console.log('–í—ã–±—Ä–∞–Ω–∞ –º–µ—Ç–∫–∞ —Å –∏–Ω–¥–µ–∫—Å–æ–º:', nearestIndex, '—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ:', minDist);
                selectPointForEditing(nearestIndex);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ø–∞–ø –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                showEditPointPopup(nearestIndex);
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
                if (e.originalEvent) {
                    e.originalEvent.stopPropagation();
                    e.originalEvent.preventDefault();
                }
            } else {
                console.log('–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –º–µ—Ç–∫–∞ —Ä—è–¥–æ–º —Å –∫–ª–∏–∫–æ–º, –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ:', minDist);
            }
        }
        
        function updateRoutePointStyles() {
            pointMarkers.forEach((m, idx) => {
                let color = 'white'; // –ë–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞ –¥–ª—è –≤—Å–µ—Ö —Ç–æ—á–µ–∫
                let fillColor;
                if (idx === 0) {
                    fillColor = 'green';
                } else if (idx === pointMarkers.length - 1) {
                    fillColor = 'blue';
                } else {
                    fillColor = 'red';
                }
                m.setStyle({ 
                    color: color,
                    fillColor: fillColor,
                    weight: 2,
                    className: 'route-point-marker'
                });
            });
            
            // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç —Å –Ω–æ–≤—ã–º–∏ –ø–æ–¥–ø–∏—Å—è–º–∏
            if (selectedPoints.length > 1) {
                buildFullRoute();
            }
        }
        
        // ==================== –û–ë–†–ê–ë–û–¢–ö–ê –ó–£–ú–ê ====================
        function onZoomEnd() {
            updateZoomDisplay();
            updateLabelVisibility(); // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–µ–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑—É–º–∞
        }
        
        function undoLastPoint() {
            if (selectedPoints.length === 0) return;
            
            selectedPoints.pop();
            const lastMarker = pointMarkers.pop();
            if (lastMarker) map.removeLayer(lastMarker);
            
            if (selectedPoints.length === 0) {
                clearRoute();
            } else if (selectedPoints.length === 1) {
                if (routeLayer) map.removeLayer(routeLayer);
                routeLayer = null;
                routePointMarkers.forEach(marker => map.removeLayer(marker));
                routeLabelMarkers.forEach(marker => map.removeLayer(marker));
                routePointMarkers = [];
                routeLabelMarkers = [];
                document.getElementById('status').textContent = '–í—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é.';
                document.getElementById('show-route-points-btn').style.display = 'none';
                document.getElementById('route-points-popup').style.display = 'none';
            } else {
                buildFullRoute();
            }
            updateRouteButtonsVisibility();
        }
        
        function updateRouteButtonsVisibility() {
            const clearBtn = document.getElementById('clear-route-btn');
            
            if (selectedPoints.length > 0) {
                clearBtn.style.display = 'block';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ undo –¥–ª—è –æ–±–µ–∏—Ö –∫–∞—Ä—Ç
                if (currentMapType === 'google-satellite') {
                    document.getElementById('undo-btn-google').style.display = 'flex';
                } else {
                    document.getElementById('undo-btn').style.display = 'flex';
                }
            } else {
                clearBtn.style.display = 'none';
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ undo –¥–ª—è –æ–±–µ–∏—Ö –∫–∞—Ä—Ç
                document.getElementById('undo-btn').style.display = 'none';
                document.getElementById('undo-btn-google').style.display = 'none';
            }
        }
        
        // ==================== –°–õ–û–ô –ö–ü 2025 ====================
        async function toggleKPLayer() {
            const btn = currentMapType === 'google-satellite' 
                ? document.getElementById('kp-layer-btn-google') 
                : document.getElementById('kp-layer-btn');
            
            if (!kpLayerVisible) {
                showLoadingOverlay("–ó–∞–≥—Ä—É–∑–∫–∞ –ö–ü 2025...");
                
                try {
                    const data = await loadKpData();
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª–æ–∏
                    if (kpLayer) map.removeLayer(kpLayer);
                    kpMarkers = [];
                    kpLabels = [];
                    
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ —Å–ª–æ–∏
                    kpLayer = L.layerGroup();
                    
                    data.features.forEach(feature => {
                        if (feature.geometry.type !== 'Point') return;
                        const coords = feature.geometry.coordinates;
                        const name = feature.properties?.Name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                        const type = feature.properties?.type || 'point';
                        
                        if (!coords || coords.length < 2) return;
                        
                        let latlng;
                        if (currentMapType === 'google-satellite') {
                            const wgs84Coords = epsg3857ToWgs84(coords[0], coords[1]);
                            latlng = [wgs84Coords[0], wgs84Coords[1]];
                        } else {
                            latlng = [coords[1], coords[0]];
                        }
                        
                        let markerColor, labelClass;
                        if (type === '—Ç–µ—Ö. —ç—Ç–∞–ø') {
                            markerColor = '#ff0000';
                            labelClass = 'kp-label-tech';
                        } else {
                            markerColor = '#00ff00';
                            labelClass = 'kp-label-point';
                        }
                        
                        // –ú–∞—Ä–∫–µ—Ä
                        const marker = L.circleMarker(latlng, {
                            radius: 4,
                            color: markerColor,
                            fillColor: markerColor,
                            fillOpacity: 0.7,
                            weight: 1
                        }).bindPopup(`<b>${name}</b><br>–¢–∏–ø: ${type}`);
                        
                        // –ü–æ–¥–ø–∏—Å—å
                        const label = L.marker(latlng, {
                            icon: L.divIcon({
                                className: labelClass,
                                html: name.length > 15 ? name.substring(0, 12) + '...' : name,
                                iconSize: null,
                                iconAnchor: [0, -8]
                            }),
                            interactive: false
                        });
                        
                        marker.addTo(kpLayer);
                        label.addTo(kpLayer);
                        kpMarkers.push(marker);
                        kpLabels.push(label);
                    });
                    
                    kpLayer.addTo(map);
                    kpLayerVisible = true;
                    btn.classList.add('active');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–µ—Ç–æ–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç—ã
                    updateMarkersVisibilityForCurrentMap();
                    
                    document.getElementById('status').textContent = `–°–ª–æ–π –ö–ü 2025 –∑–∞–≥—Ä—É–∂–µ–Ω: ${data.features.length} —Ç–æ—á–µ–∫`;
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ö–ü:', error);
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—è –ö–ü 2025');
                }
                
                hideLoadingOverlay();
            } else {
                if (kpLayer) {
                    map.removeLayer(kpLayer);
                    kpLayer = null;
                    kpMarkers = [];
                    kpLabels = [];
                }
                kpLayerVisible = false;
                btn.classList.remove('active');
                document.getElementById('status').textContent = '–°–ª–æ–π –ö–ü 2025 —Å–∫—Ä—ã—Ç';
            }
        }
        
        // ==================== –°–õ–û–ô –í–°–ï–• –ú–ï–¢–û–ö (JSON POINTS) ====================
        async function toggleJsonPointsLayer() {
            const btn = document.getElementById('json-points-btn');
            
            if (!jsonPointsLayerVisible) {
                showLoadingOverlay("–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–µ—Ç–æ–∫...");
                
                try {
                    const data = await loadPointsData();
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª–æ–∏
                    if (jsonPointsLayer) map.removeLayer(jsonPointsLayer);
                    jsonPointsMarkers = [];
                    jsonPointsLabels = [];
                    
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ —Å–ª–æ–∏
                    jsonPointsLayer = L.layerGroup();
                    
                    data.features.forEach(feature => {
                        if (feature.geometry.type !== 'Point') return;
                        const coords = feature.geometry.coordinates;
                        const name = feature.properties?.Name || '';
                        
                        if (!coords || coords.length < 2 || !name) return;
                        
                        let latlng;
                        if (currentMapType === 'google-satellite') {
                            const wgs84Coords = epsg3857ToWgs84(coords[0], coords[1]);
                            latlng = [wgs84Coords[0], wgs84Coords[1]];
                        } else {
                            latlng = [coords[1], coords[0]];
                        }
                        
                        // –ú–∞—Ä–∫–µ—Ä
                        const marker = L.circleMarker(latlng, {
                            radius: 3,
                            color: '#5D4037',
                            fillColor: 'white',
                            weight: 1,
                            fillOpacity: 1
                        }).bindPopup(`<b>${name}</b>`);
                        
                        // –ü–æ–¥–ø–∏—Å—å
                        const label = L.marker(latlng, {
                            icon: L.divIcon({
                                className: 'point-label-from-json',
                                html: name.length > 15 ? name.substring(0, 12) + '...' : name,
                                iconSize: null,
                                iconAnchor: [0, -8]
                            }),
                            interactive: false
                        });
                        
                        marker.addTo(jsonPointsLayer);
                        label.addTo(jsonPointsLayer);
                        jsonPointsMarkers.push(marker);
                        jsonPointsLabels.push(label);
                    });
                    
                    jsonPointsLayer.addTo(map);
                    jsonPointsLayerVisible = true;
                    btn.classList.add('active');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–µ—Ç–æ–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç—ã
                    updateMarkersVisibilityForCurrentMap();
                    
                    document.getElementById('status').textContent = `–°–ª–æ–π –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω: ${data.features.length} —Ç–æ—á–µ–∫`;
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –º–µ—Ç–æ–∫:', error);
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—è –≤—Å–µ—Ö –º–µ—Ç–æ–∫');
                }
                
                hideLoadingOverlay();
            } else {
                if (jsonPointsLayer) {
                    map.removeLayer(jsonPointsLayer);
                    jsonPointsLayer = null;
                    jsonPointsMarkers = [];
                    jsonPointsLabels = [];
                }
                jsonPointsLayerVisible = false;
                btn.classList.remove('active');
                document.getElementById('status').textContent = '–°–ª–æ–π –≤—Å–µ—Ö –º–µ—Ç–æ–∫ —Å–∫—Ä—ã—Ç';
            }
        }
        
        // ==================== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ï –ú–ï–¢–ö–ò ====================
        function loadUserPoints() {
            const saved = localStorage.getItem('userPoints');
            if (saved) {
                try {
                    userPointsData = JSON.parse(saved);
                } catch (e) {
                    userPointsData = { type: "FeatureCollection", features: [] };
                }
            }
            return userPointsData;
        }
        
        function saveUserPoints() {
            localStorage.setItem('userPoints', JSON.stringify(userPointsData));
        }
        
        function toggleUserPointsLayer() {
            const btn = document.getElementById('points-layer-btn');
            
            if (!userPointsLayerVisible) {
                // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫
                userPointsLayerVisible = true;
                isUserPointsMode = false;
                isEditMode = false;
                selectedPointIndex = null;
                btn.classList.add('active');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                document.getElementById('add-point-btn').style.display = 'flex';
                document.getElementById('edit-points-btn').style.display = 'flex';
                document.getElementById('cancel-edit-btn').style.display = 'none';
                document.getElementById('delete-point-btn').style.display = 'none';
                document.getElementById('points-controls-expanded').classList.add('active');
                
                loadUserPoints();
                displayUserPoints();
                
                document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
                
            } else {
                // –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫
                userPointsLayerVisible = false;
                isUserPointsMode = false;
                isEditMode = false;
                selectedPointIndex = null;
                btn.classList.remove('active');
                
                // –°–∫—Ä—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                document.getElementById('add-point-btn').style.display = 'none';
                document.getElementById('edit-points-btn').style.display = 'none';
                document.getElementById('cancel-edit-btn').style.display = 'none';
                document.getElementById('delete-point-btn').style.display = 'none';
                document.getElementById('points-controls-expanded').classList.remove('active');
                
                if (userPointsLayer) {
                    map.removeLayer(userPointsLayer);
                    userPointsLayer = null;
                    userPointMarkers = [];
                    userPointLabels = [];
                }
                
                document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞';
            }
        }
        
        function displayUserPoints() {
            console.log('–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫');
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª–æ–∏
            if (userPointsLayer) {
                map.removeLayer(userPointsLayer);
            }
            userPointMarkers = [];
            userPointLabels = [];
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–ª–æ–π
            userPointsLayer = L.layerGroup();
            
            userPointsData.features.forEach((feature, index) => {
                if (feature.geometry.type !== 'Point') return;
                const coords = feature.geometry.coordinates;
                const name = feature.properties?.name || `–ú–µ—Ç–∫–∞ ${index + 1}`;
                const comment = feature.properties?.comment || '';
                
                if (!coords || coords.length < 2) return;
                
                let latlng;
                if (currentMapType === 'google-satellite') {
                    const wgs84Coords = epsg3857ToWgs84(coords[0], coords[1]);
                    latlng = [wgs84Coords[0], wgs84Coords[1]];
                } else {
                    latlng = [coords[1], coords[0]];
                }
                
                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
                const marker = L.circleMarker(latlng, {
                    radius: 8,
                    color: '#8B008B',
                    fillColor: '#FFB6C1',
                    weight: 2,
                    fillOpacity: 0.9,
                    className: 'user-point-marker'
                }).bindPopup(`<b>${name}</b>${comment ? '<br>' + comment : ''}<br><small><i>ID: ${index + 1}</i></small>`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                marker.on('click', function(e) {
                    console.log('–ö–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É –º–µ—Ç–∫–∏:', index);
                    if (isEditMode) {
                        console.log('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω, –≤—ã–±–∏—Ä–∞–µ–º –º–µ—Ç–∫—É');
                        e.originalEvent.stopPropagation();
                        e.originalEvent.preventDefault();
                        selectPointForEditing(index);
                        showEditPointPopup(index);
                        return false;
                    }
                });
                
                // –ü–æ–¥–ø–∏—Å—å
                const label = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'user-point-label',
                        html: name.length > 15 ? name.substring(0, 12) + '...' : name,
                        iconSize: null,
                        iconAnchor: [0, -15]
                    }),
                    interactive: false
                });
                
                marker.addTo(userPointsLayer);
                label.addTo(userPointsLayer);
                userPointMarkers.push(marker);
                userPointLabels.push(label);
            });
            
            userPointsLayer.addTo(map);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
            if (isEditMode) {
                updateMarkersForEditMode();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–µ—Ç–æ–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç—ã
            updateMarkersVisibilityForCurrentMap();
        }
        
        function startEditMode() {
            console.log('startEditMode called');
            isEditMode = true;
            isUserPointsMode = false;
            
            // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('add-point-btn').style.display = 'none';
            document.getElementById('edit-points-btn').style.display = 'none';
            document.getElementById('cancel-edit-btn').style.display = 'flex';
            document.getElementById('delete-point-btn').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
            updateMarkersForEditMode();
            
            document.getElementById('status').textContent = '–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–∫. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –º–µ—Ç–∫—É –¥–ª—è –≤—ã–±–æ—Ä–∞.';
        }
        
        function cancelEditMode() {
            console.log('cancelEditMode called');
            isEditMode = false;
            isUserPointsMode = false;
            
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                const markerElement = userPointMarkers[selectedPointIndex].getElement();
                if (markerElement) {
                    markerElement.classList.remove('selected');
                }
            }
            selectedPointIndex = null;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('add-point-btn').style.display = 'flex';
            document.getElementById('edit-points-btn').style.display = 'flex';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.getElementById('delete-point-btn').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
            updateMarkersForEditMode();
            
            document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
        }
        
        function updateMarkersForEditMode() {
            console.log('updateMarkersForEditMode called, isEditMode:', isEditMode);
            
            userPointMarkers.forEach((marker, index) => {
                const element = marker.getElement();
                if (element) {
                    if (isEditMode) {
                        element.classList.add('editing');
                        if (index === selectedPointIndex) {
                            element.classList.add('selected');
                        } else {
                            element.classList.remove('selected');
                        }
                    } else {
                        element.classList.remove('editing');
                        element.classList.remove('selected');
                    }
                }
            });
        }
        
        function selectPointForEditing(index) {
            console.log('selectPointForEditing called, index:', index);
            
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –º–µ—Ç–∫–∏
            if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                const prevMarkerElement = userPointMarkers[selectedPointIndex].getElement();
                if (prevMarkerElement) {
                    prevMarkerElement.classList.remove('selected');
                }
            }
            
            // –í—ã–¥–µ–ª—è–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É
            selectedPointIndex = index;
            if (userPointMarkers[index]) {
                const markerElement = userPointMarkers[index].getElement();
                if (markerElement) {
                    markerElement.classList.add('selected');
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
            document.getElementById('delete-point-btn').style.display = 'flex';
        }
        
        function showAddPointPopup() {
            document.getElementById('add-point-overlay').style.display = 'block';
            document.getElementById('add-point-popup').style.display = 'block';
            document.getElementById('point-name').focus();
        }
        
        function hideAddPointPopup() {
            document.getElementById('add-point-overlay').style.display = 'none';
            document.getElementById('add-point-popup').style.display = 'none';
            document.getElementById('point-name').value = '';
            document.getElementById('point-comment').value = '';
            pendingPointCoords = null;
        }
        
        function showEditPointPopup(index) {
            console.log('showEditPointPopup called, index:', index);
            const feature = userPointsData.features[index];
            if (!feature) {
                console.error('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É:', index);
                return;
            }
            
            document.getElementById('edit-point-name').value = feature.properties?.name || '';
            document.getElementById('edit-point-comment').value = feature.properties?.comment || '';
            document.getElementById('edit-point-overlay').style.display = 'flex';
        }
        
        function hideEditPointPopup() {
            document.getElementById('edit-point-overlay').style.display = 'none';
            document.getElementById('edit-point-name').value = '';
            document.getElementById('edit-point-comment').value = '';
        }
        
        function addUserPoint() {
            const name = document.getElementById('point-name').value.trim();
            const comment = document.getElementById('point-comment').value.trim();
            
            if (!name) {
                showCustomAlert('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
                return;
            }
            
            if (!pendingPointCoords) {
                showCustomAlert('–û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã');
                return;
            }
            
            const newFeature = {
                type: "Feature",
                geometry: {
                    type: "Point",
                    coordinates: pendingPointCoords
                },
                properties: {
                    name: name,
                    comment: comment,
                    created: new Date().toISOString()
                }
            };
            
            userPointsData.features.push(newFeature);
            saveUserPoints();
            
            if (userPointsLayerVisible) {
                displayUserPoints();
            }
            
            showCustomAlert(`–ú–µ—Ç–∫–∞ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`);
            hideAddPointPopup();
            isUserPointsMode = false;
            document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
        }
        
        function updateUserPoint() {
            if (selectedPointIndex === null) return;
            
            const name = document.getElementById('edit-point-name').value.trim();
            const comment = document.getElementById('edit-point-comment').value.trim();
            
            if (!name) {
                showCustomAlert('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
                return;
            }
            
            userPointsData.features[selectedPointIndex].properties.name = name;
            userPointsData.features[selectedPointIndex].properties.comment = comment;
            userPointsData.features[selectedPointIndex].properties.updated = new Date().toISOString();
            
            saveUserPoints();
            
            if (userPointsLayerVisible) {
                displayUserPoints();
            }
            
            showCustomAlert(`–ú–µ—Ç–∫–∞ "${name}" –æ–±–Ω–æ–≤–ª–µ–Ω–∞`);
            hideEditPointPopup();
            
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
            if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                userPointMarkers[selectedPointIndex].getElement().classList.remove('selected');
            }
            selectedPointIndex = null;
            document.getElementById('delete-point-btn').style.display = 'none';
        }
        
        function deleteUserPoint() {
            if (selectedPointIndex === null) return;
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–µ—Ç–∫—É?')) {
                return;
            }
            
            const pointName = userPointsData.features[selectedPointIndex].properties?.name || '–ú–µ—Ç–∫–∞';
            userPointsData.features.splice(selectedPointIndex, 1);
            saveUserPoints();
            
            if (userPointsLayerVisible) {
                displayUserPoints();
            }
            
            showCustomAlert(`–ú–µ—Ç–∫–∞ "${pointName}" —É–¥–∞–ª–µ–Ω–∞`);
            hideEditPointPopup();
            
            selectedPointIndex = null;
            document.getElementById('delete-point-btn').style.display = 'none';
        }
        
        function saveUserPointsToFile() {
            const bookmarkName = document.getElementById('bookmark-name').value.trim();
            if (!bookmarkName) {
                showCustomAlert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–æ–∫');
                return;
            }
            
            const dataStr = JSON.stringify(userPointsData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${bookmarkName.replace(/[^\w–∞-—è–ê-–Ø—ë–Å\s.-]/g, '_').replace(/\s+/g, '_')}.geojson`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showCustomAlert(`–ú–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª: ${link.download}`);
            document.getElementById('bookmark-name').value = '';
        }
        
		 // ==================== –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–û–ò–°–ö –¢–û–ß–ï–ö (Android —Å—Ç–∏–ª—å) ====================
		function performSearch(query) {
			const resultsContainer = document.getElementById('search-results-panel');
			resultsContainer.innerHTML = '';
			
			if (query.trim()) {
				lastSearchQuery = query.trim();
				localStorage.setItem('lastSearchQuery', lastSearchQuery);
			}
			
			if (!query.trim() || !allPointsGeoJson) {
				resultsContainer.style.display = 'none';
				return;
			}

			const q = query.trim().toLowerCase();
			const matches = [];

			allPointsGeoJson.features.forEach(feature => {
				if (feature.geometry.type !== "Point") return;
				const name = feature.properties?.Name;
				const coords = feature.geometry.coordinates;
				if (!name || !coords || coords.length < 2) return;
				
				const nameLower = name.toLowerCase();
				if (nameLower.includes(q)) {
					let priority = 2;
					if (nameLower === q) priority = 0;
					else if (nameLower.startsWith(q)) priority = 1;
					matches.push({ name, coords, priority });
				}
			});

			if (matches.length === 0) {
				resultsContainer.style.display = 'none';
				return;
			}

			matches.sort((a, b) => {
				if (a.priority !== b.priority) return a.priority - b.priority;
				return a.name.localeCompare(b.name, 'ru');
			});

			matches.slice(0, 20).forEach(item => {
				const div = document.createElement('div');
				div.className = 'search-result-item-panel';
				div.textContent = item.name;
				div.setAttribute('data-lng', item.coords[0]);
				div.setAttribute('data-lat', item.coords[1]);
				div.addEventListener('click', (e) => {
					const lng = parseFloat(e.target.getAttribute('data-lng'));
					const lat = parseFloat(e.target.getAttribute('data-lat'));
					if (!isNaN(lng) && !isNaN(lat)) {
						let targetLat, targetLng;
						if (currentMapType === 'google-satellite') {
							const wgs84Coords = epsg3857ToWgs84(lng, lat);
							targetLat = wgs84Coords[0];
							targetLng = wgs84Coords[1];
						} else {
							targetLat = lat;
							targetLng = lng;
						}
						
						// –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞
						const targetPoint = L.latLng(targetLat, targetLng);
						const currentCenter = map.getCenter();
						const currentZoom = map.getZoom();
						
						// –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ç–µ–∫—É—â–∏–º —Ü–µ–Ω—Ç—Ä–æ–º –∏ —Ü–µ–ª–µ–≤–æ–π —Ç–æ—á–∫–æ–π
						const distance = currentCenter.distanceTo(targetPoint);
						
						// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑—É–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã
						const targetZoom = currentMapType === 'google-satellite' ? 18 : 2;
						
						// –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –±–æ–ª—å—à–æ–µ (—Ç–æ—á–∫–∞ –¥–∞–ª–µ–∫–æ), —Å–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –∑—É–º 0/10, 
						// —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É, –∑–∞—Ç–µ–º –ø–ª–∞–≤–Ω–æ –ø—Ä–∏–±–ª–∏–∂–∞–µ–º
						if (distance > 1000) { // –ë–æ–ª—å—à–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
							if (currentMapType === 'google-satellite') {
								// –î–ª—è Google Satellite —Å–Ω–∞—á–∞–ª–∞ –∏–¥–µ–º –Ω–∞ 10 –∑—É–º
								map.setView(targetPoint, 10, {
									animate: true,
									duration: 0.5
								});
								
								// –ó–∞—Ç–µ–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –ø–∞—É–∑—É –∏–¥–µ–º –Ω–∞ —Ü–µ–ª–µ–≤–æ–π –∑—É–º
								setTimeout(() => {
									map.setView(targetPoint, targetZoom, {
										animate: true,
										duration: 0.7
									});
								}, 600);
							} else {
								// –î–ª—è –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç —Å–Ω–∞—á–∞–ª–∞ –∏–¥–µ–º –Ω–∞ –∑—É–º -1
								map.setView(targetPoint, -1, {
									animate: true,
									duration: 0.5
								});
								
								// –ó–∞—Ç–µ–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –ø–∞—É–∑—É –∏–¥–µ–º –Ω–∞ –∑—É–º 2
								setTimeout(() => {
									map.setView(targetPoint, 2, {
										animate: true,
										duration: 0.7
									});
								}, 600);
							}
						} else {
							// –ï—Å–ª–∏ —Ç–æ—á–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –±–ª–∏–∑–∫–æ, –ø—Ä–æ—Å—Ç–æ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å —Ü–µ–ª–µ–≤—ã–º –∑—É–º–æ–º
							if (Math.abs(currentZoom - targetZoom) > 2) {
								// –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –∑—É–º–µ –±–æ–ª—å—à–∞—è, –¥–µ–ª–∞–µ–º –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
								map.setView(targetPoint, targetZoom, {
									animate: true,
									duration: 0.7
								});
							} else {
								// –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –∑—É–º–µ –Ω–µ–±–æ–ª—å—à–∞—è, –ø—Ä–æ—Å—Ç–æ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
								map.setView(targetPoint, targetZoom, {
									animate: true,
									duration: 0.5
								});
							}
						}

						// –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∏
						if (searchHighlightMarker) {
							map.removeLayer(searchHighlightMarker);
						}
						if (searchHaloMarker) {
							map.removeLayer(searchHaloMarker);
						}
						
						// –°–æ–∑–¥–∞–µ–º –æ—Ä–µ–æ–ª –≤–æ–∫—Ä—É–≥ —Ç–æ—á–∫–∏
						searchHaloMarker = L.circleMarker([targetLat, targetLng], {
							radius: 20,
							color: '#0066cc',
							fillColor: 'rgba(0, 102, 204, 0.2)',
							weight: 1,
							fillOpacity: 0.5,
							className: 'search-halo'
						}).addTo(map);
						
						// –°–æ–∑–¥–∞–µ–º —Å–∏–Ω–∏–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏
						searchHighlightMarker = L.marker([targetLat, targetLng], {
							icon: L.divIcon({
								className: 'search-highlight-marker',
								html: '<div style="background-color: #0066cc; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(0, 102, 204, 0.8);"></div>',
								iconSize: [24, 24],
								iconAnchor: [12, 12]
							}),
							zIndexOffset: 10000
						}).addTo(map);
						
						// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç–æ—á–∫–∏
						searchHighlightMarker.bindPopup(`<b>${item.name}</b>`).openPopup();

						// –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 6 —Å–µ–∫—É–Ω–¥
						setTimeout(() => {
							if (searchHighlightMarker) {
								map.removeLayer(searchHighlightMarker);
								searchHighlightMarker = null;
							}
							if (searchHaloMarker) {
								map.removeLayer(searchHaloMarker);
								searchHaloMarker = null;
							}
						}, 6000);

						toggleSearchPanel();
					}
				});
				resultsContainer.appendChild(div);
			});

			resultsContainer.style.display = 'block';
		}
		
        function toggleSearchPanel() {
            const searchPanel = document.getElementById('search-panel');
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results-panel');

            if (!searchPanelVisible) {
                if (!allPointsGeoJson) {
                    showCustomAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞");
                    return;
                }

                searchPanel.style.display = 'block';
                searchPanelVisible = true;
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';

                lastSearchQuery = localStorage.getItem('lastSearchQuery') || '';
                searchInput.value = lastSearchQuery;

                setTimeout(() => {
                    searchInput.focus();
                    setTimeout(() => {
                        if (lastSearchQuery) {
                            searchInput.setSelectionRange(0, lastSearchQuery.length);
                        }
                    }, 10);
                }, 50);

                if (lastSearchQuery) {
                    performSearch(lastSearchQuery);
                }
            } else {
                searchPanel.style.display = 'none';
                searchPanelVisible = false;
                searchInput.value = '';
                searchResults.style.display = 'none';
            }
        }

        function showSearchPointsPopup() {
            toggleSearchPanel();
        }

        function hideSearchPointsPopup() {
            toggleSearchPanel();
        }
        
        function goToPoint(point) {
            if (!point) return;
            
            const [x, y] = point.coords;
            let latlng;
            
            if (currentMapType === 'google-satellite') {
                const wgs84Coords = epsg3857ToWgs84(x, y);
                latlng = [wgs84Coords[0], wgs84Coords[1]];
            } else {
                latlng = [y, x];
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑—É–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã
            const zoomLevel = currentMapType === 'google-satellite' ? 18 : 0;
            
            map.setView(latlng, zoomLevel, {
                animate: true,
                duration: 0.5
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç–æ—á–∫–∏
            const marker = L.marker(latlng).addTo(map)
                .bindPopup(`<b>${point.name}</b>`)
                .openPopup();
            
            // –£–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                map.removeLayer(marker);
            }, 5000);
            
            document.getElementById('status').textContent = `–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–æ—á–∫–µ: ${point.name}`;
        }
        
        // ==================== –°–û–•–†–ê–ù–ï–ù–ò–ï/–ó–ê–ì–†–£–ó–ö–ê –ú–ê–†–®–†–£–¢–û–í ====================
        function saveRoute() {
            const routeName = document.getElementById('route-name').value.trim();
            if (!routeName) {
                showCustomAlert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –º–∞—Ä—à—Ä—É—Ç–∞');
                return;
            }
            
            if (selectedPoints.length < 2) {
                showCustomAlert('–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏');
                return;
            }
            
            const routeData = {
                name: routeName,
                points: selectedPoints,
                date: new Date().toISOString(),
                distance: calculateTotalDistance()
            };
            
            let savedRoutes = JSON.parse(localStorage.getItem('userRoutes') || '[]');
            savedRoutes.push(routeData);
            localStorage.setItem('userRoutes', JSON.stringify(savedRoutes));
            
            const dataStr = JSON.stringify(routeData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${routeName.replace(/[^\w–∞-—è–ê-–Ø—ë–Å\s.-]/g, '_').replace(/\s+/g, '_')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showCustomAlert(`–ú–∞—Ä—à—Ä—É—Ç "${routeName}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω`);
            document.getElementById('route-name').value = '';
        }
        
        function calculateTotalDistance() {
            let total = 0;
            for (let i = 0; i < selectedPoints.length - 1; i++) {
                total += calculateRealDistance(selectedPoints[i], selectedPoints[i + 1]);
            }
            return total;
        }
        
        function loadRouteFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.points || !Array.isArray(data.points)) {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    }
                    
                    clearRoute();
                    selectedPoints = data.points.map(pt => [...pt]);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã —Å –±–µ–ª–æ–π –æ–±–≤–æ–¥–∫–æ–π
                    selectedPoints.forEach((pt, idx) => {
                        let fillColor;
                        if (idx === 0) fillColor = 'green';
                        else if (idx === selectedPoints.length - 1) fillColor = 'blue';
                        else fillColor = 'red';
                        
                        const marker = L.circle([pt[1], pt[0]], {
                            radius: 3,
                            color: 'white', // –ë–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞
                            fillColor: fillColor,
                            weight: 2,
                            fillOpacity: 1,
                            className: 'route-point-marker'
                        }).addTo(map);
                        
                        pointMarkers.push(marker);
                    });
                    
                    buildFullRoute();
                    showCustomAlert(`–ú–∞—Ä—à—Ä—É—Ç "${data.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}" –∑–∞–≥—Ä—É–∂–µ–Ω`);
                    
                } catch (error) {
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function loadUserPointsFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.type !== 'FeatureCollection') {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç GeoJSON');
                    }
                    
                    userPointsData = data;
                    saveUserPoints();
                    
                    if (userPointsLayerVisible) {
                        displayUserPoints();
                    }
                    
                    showCustomAlert('–ú–µ—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                    
                } catch (error) {
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // ==================== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ö–ê–†–¢ ====================
        function switchMapLayer(mapType) {
            if (currentMapType === mapType) return;
            currentMapType = mapType;

            showLoadingOverlay("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã...");
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–ª–æ–µ–≤
            const wasKpVisible = kpLayerVisible;
            const wasUserPointsVisible = userPointsLayerVisible;
            const wasJsonPointsVisible = jsonPointsLayerVisible;
            const wasEditMode = isEditMode;
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–ª–æ–∏
            if (entranceMarker) map.removeLayer(entranceMarker);
            if (currentImageOverlay) map.removeLayer(currentImageOverlay);
            if (googleSatelliteLayer) map.removeLayer(googleSatelliteLayer);
            if (kpLayer) map.removeLayer(kpLayer);
            if (userPointsLayer) map.removeLayer(userPointsLayer);
            if (jsonPointsLayer) map.removeLayer(jsonPointsLayer);
            if (routeLayer) map.removeLayer(routeLayer);
            
            entranceMarker = currentImageOverlay = googleSatelliteLayer = null;

            if (mapType === 'google-satellite') {
                map.options.crs = L.CRS.EPSG3857;
                map.options.minZoom = 10;
                map.options.maxZoom = 21;

                googleSatelliteLayer = L.tileLayer('https://mt{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                    maxZoom: 21,
                    minZoom: 10,
                    subdomains: ['0','1','2','3'],
                    attribution: '¬© Google'
                }).addTo(map);

                setTimeout(() => {
                    addEntranceMarker();
                    const [x, y] = ENTRANCE_COORDS_EPSG3857;
                    const [lat, lng] = epsg3857ToWgs84(x, y);
                    map.setView([lat, lng], 17);

                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    updateControlsVisibility();
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª–æ–∏ –¥–ª—è Google Satellite
                    if (wasKpVisible) {
                        // –î–ª—è Google Satellite –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ö–ü —Å –Ω–æ–≤—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                        toggleKPLayer();
                    }
                    if (wasUserPointsVisible && userPointsData.features.length > 0) {
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–µ—Ç–∫–∏ —Å –Ω–æ–≤—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                        displayUserPoints();
                    }
                    if (wasJsonPointsVisible) {
                        // –î–ª—è Google Satellite –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ—á–µ–∫ —Å –Ω–æ–≤—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                        toggleJsonPointsLayer();
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–µ—Ç–æ–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                    setTimeout(() => {
                        updateMarkersVisibilityForCurrentMap();
                    }, 100);
                    
                    hideLoadingOverlay();
                }, 100);
            } else {
                map.options.crs = L.CRS.Simple;
                map.options.minZoom = -2;
                map.options.maxZoom = 4;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                updateControlsVisibility();
                
                // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ mapBounds –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                if (!mapBounds) {
                    mapBounds = [[0, 0], [1000, 1000]];
                }

                currentImageOverlay = L.imageOverlay(mapType, mapBounds, { opacity: 1 }).addTo(map);

                setTimeout(() => {
                    addEntranceMarker();
                    const centerX = (mapBounds[0][1] + mapBounds[1][1]) / 2;
                    const centerY = (mapBounds[0][0] + mapBounds[1][0]) / 2;
                    map.setView([centerY, centerX], -1);

                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª–æ–∏ –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç
                    if (wasKpVisible) {
                        // –î–ª—è –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ö–ü —Å –∏—Å—Ö–æ–¥–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                        toggleKPLayer();
                    }
                    if (wasUserPointsVisible && userPointsData.features.length > 0) {
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–µ—Ç–∫–∏ —Å –∏—Å—Ö–æ–¥–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
                        displayUserPoints();
                    }
                    if (selectedPoints.length > 1) {
                        buildFullRoute();
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
                    if (wasEditMode && wasUserPointsVisible) {
                        startEditMode();
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–µ—Ç–æ–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∞
                    setTimeout(() => {
                        updateMarkersVisibilityForCurrentMap();
                    }, 100);
                    
                    hideLoadingOverlay();
                }, 100);
            }
        }
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        async function initializeMap() {
            document.getElementById('status').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã...';
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤
                const fileChecks = await Promise.allSettled(
                    REQUIRED_FILES.map(file => fetch(file))
                );
                
                const missingFiles = [];
                fileChecks.forEach((result, index) => {
                    if (result.status === 'rejected') {
                        missingFiles.push(REQUIRED_FILES[index]);
                    }
                });
                
                if (missingFiles.length > 0) {
                    console.warn('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ñ–∞–π–ª—ã:', missingFiles);
                    showCustomAlert(`–í–Ω–∏–º–∞–Ω–∏–µ: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã: ${missingFiles.join(', ')}`);
                }
                
                await loadTunnelsData();
                await loadPointsData();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
                if (segments.length === 0) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç—É–Ω–Ω–µ–ª–µ–π');
                }
                
                currentImageOverlay = L.imageOverlay('byaki.png', mapBounds, {
                    opacity: 1
                }).addTo(map);
                
                addEntranceMarker();
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä –∏ –∑—É–º
                const centerX = (mapBounds[0][1] + mapBounds[1][1]) / 2;
                const centerY = (mapBounds[0][0] + mapBounds[1][0]) / 2;
                map.setView([centerY, centerX], -1);
                
                loadUserPoints();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                updateControlsVisibility();
                
                document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å—Ö–µ–º—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ—á–µ–∫.';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã';
                showCustomAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã: ${error.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ.`);
                
                // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
                mapBounds = [[0, 0], [1000, 1000]];
                currentImageOverlay = L.imageOverlay('byaki.png', mapBounds, {
                    opacity: 0.5
                }).addTo(map);
            }
        }
        
        // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ====================
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('dropdown-menu');
                const menuBtn = document.getElementById('menu-button');
                const searchPanel = document.getElementById('search-panel');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
                if (menuOpen && 
                    !dropdown.contains(e.target) && 
                    !menuBtn.contains(e.target)) {
                    menuOpen = false;
                    dropdown.classList.remove('active');
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–µ
                if (searchPanelVisible && 
                    !searchPanel.contains(e.target) && 
                    e.target.id !== 'search-points-btn') {
                    toggleSearchPanel();
                }
            });
            
            document.getElementById('menu-button').addEventListener('click', (e) => {
                e.stopPropagation();
                menuOpen = !menuOpen;
                document.getElementById('dropdown-menu').classList.toggle('active', menuOpen);
            });
            
            document.getElementById('dropdown-menu').addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            document.getElementById('zoom-in').addEventListener('click', () => {
                if (map.getZoom() < map.getMaxZoom()) map.zoomIn();
                updateZoomDisplay();
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                if (map.getZoom() > map.getMinZoom()) map.zoomOut();
                updateZoomDisplay();
            });
            
            map.on('zoomend', onZoomEnd);
            
            document.getElementById('background-select').addEventListener('change', function(e) {
                switchMapLayer(e.target.value);
            });
            
            document.getElementById('save-route').addEventListener('click', (e) => {
                e.stopPropagation();
                saveRoute();
            });
            
            document.getElementById('load-route').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('route-file-input').click();
            });
            
            document.getElementById('route-file-input').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    loadRouteFromFile(e.target.files[0]);
                }
            });
            
            document.getElementById('save-bookmark').addEventListener('click', (e) => {
                e.stopPropagation();
                saveUserPointsToFile();
            });
            
            document.getElementById('load-bookmark').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('bookmark-file-input').click();
            });
            
            document.getElementById('bookmark-file-input').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    loadUserPointsFromFile(e.target.files[0]);
                }
            });
            
            document.getElementById('clear-route-btn').addEventListener('click', clearRoute);
            
            document.getElementById('show-route-points-btn').addEventListener('click', toggleRoutePointsPopup);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ undo –Ω–∞ –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç–∞—Ö
            document.getElementById('undo-btn').addEventListener('click', undoLastPoint);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ undo –Ω–∞ Google –∫–∞—Ä—Ç–µ
            document.getElementById('undo-btn-google').addEventListener('click', undoLastPoint);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–º–∫–∞ –Ω–∞ –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç–∞—Ö
            document.getElementById('lock-btn').addEventListener('click', () => {
                routeLocked = !routeLocked;
                const lockBtn = document.getElementById('lock-btn');
                const lockBtnGoogle = document.getElementById('lock-btn-google');
                
                lockBtn.textContent = routeLocked ? 'üîí' : 'üîì';
                lockBtnGoogle.textContent = routeLocked ? 'üîí' : 'üîì';
                
                if (routeLocked) {
                    map.off('click', handleMapClick);
                    document.getElementById('status').textContent = '–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ';
                } else {
                    map.on('click', handleMapClick);
                    document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞';
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–º–∫–∞ –Ω–∞ Google –∫–∞—Ä—Ç–µ
            document.getElementById('lock-btn-google').addEventListener('click', () => {
                routeLocked = !routeLocked;
                const lockBtn = document.getElementById('lock-btn');
                const lockBtnGoogle = document.getElementById('lock-btn-google');
                
                lockBtn.textContent = routeLocked ? 'üîí' : 'üîì';
                lockBtnGoogle.textContent = routeLocked ? 'üîí' : 'üîì';
                
                if (routeLocked) {
                    map.off('click', handleMapClick);
                    document.getElementById('status').textContent = '–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ';
                } else {
                    map.on('click', handleMapClick);
                    document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞';
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ö–ü 2025 –Ω–∞ –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç–∞—Ö
            document.getElementById('kp-layer-btn').addEventListener('click', toggleKPLayer);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ö–ü 2025 –Ω–∞ Google –∫–∞—Ä—Ç–µ
            document.getElementById('kp-layer-btn-google').addEventListener('click', toggleKPLayer);
            
            document.getElementById('points-layer-btn').addEventListener('click', toggleUserPointsLayer);
            document.getElementById('json-points-btn').addEventListener('click', toggleJsonPointsLayer);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –º–µ—Ç–∫–∞–º–∏
            document.getElementById('add-point-btn').addEventListener('click', () => {
                console.log('–ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫ –Ω–∞–∂–∞—Ç–∞');
                isUserPointsMode = true;
                isEditMode = false;
                document.getElementById('status').textContent = '–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏';
            });
            
            document.getElementById('edit-points-btn').addEventListener('click', () => {
                console.log('–ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–∫ –Ω–∞–∂–∞—Ç–∞');
                startEditMode();
            });
            
            document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                console.log('–ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∂–∞—Ç–∞');
                cancelEditMode();
            });
            
            document.getElementById('delete-point-btn').addEventListener('click', function() {
                console.log('–ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞–∂–∞—Ç–∞, –≤—ã–±—Ä–∞–Ω–Ω–∞—è –º–µ—Ç–∫–∞:', selectedPointIndex);
                deleteUserPoint();
            });
            
            document.getElementById('add-point-cancel').addEventListener('click', () => {
                hideAddPointPopup();
                isUserPointsMode = false;
                document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
            });
            
            document.getElementById('add-point-save').addEventListener('click', addUserPoint);
            
            document.getElementById('add-point-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'add-point-overlay') {
                    hideAddPointPopup();
                    isUserPointsMode = false;
                    document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–∫
            document.getElementById('edit-point-cancel').addEventListener('click', () => {
                hideEditPointPopup();
                if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                    userPointMarkers[selectedPointIndex].getElement().classList.remove('selected');
                }
                selectedPointIndex = null;
                document.getElementById('delete-point-btn').style.display = 'none';
            });
            
            document.getElementById('edit-point-delete').addEventListener('click', deleteUserPoint);
            
            document.getElementById('edit-point-save').addEventListener('click', updateUserPoint);
            
            document.getElementById('edit-point-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'edit-point-overlay') {
                    hideEditPointPopup();
                    if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                        userPointMarkers[selectedPointIndex].getElement().classList.remove('selected');
                    }
                    selectedPointIndex = null;
                    document.getElementById('delete-point-btn').style.display = 'none';
                }
            });
            
            map.on('click', handleMapClick);
            
            document.getElementById('show-disclaimer').addEventListener('click', () => {
                document.getElementById('disclaimer-overlay').style.display = 'flex';
            });
            
            document.getElementById('close-disclaimer').addEventListener('click', () => {
                document.getElementById('disclaimer-overlay').style.display = 'none';
            });
            
            document.getElementById('disclaimer-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'disclaimer-overlay') {
                    document.getElementById('disclaimer-overlay').style.display = 'none';
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ—á–µ–∫ (Android —Å—Ç–∏–ª—å)
            document.getElementById('search-points-btn').addEventListener('click', showSearchPointsPopup);
            
            // –ü–æ–∏—Å–∫ –ø–æ –≤–≤–æ–¥—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            document.getElementById('search-input').addEventListener('input', (e) => {
                performSearch(e.target.value);
            });
            
            // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch(e.target.value);
                }
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∏—Å–∫–∞ –ø–æ Escape
            document.getElementById('search-input').addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    toggleSearchPanel();
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É (–Ω–∞ Google –∫–∞—Ä—Ç–µ)
            document.getElementById('json-points-btn').addEventListener('click', toggleJsonPointsLayer);
        });
    </script>
</body>
</html>
