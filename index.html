<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ë—è–∫–æ–•–æ–¥ ‚Äî –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
		:root {
			--safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
			--safe-area-inset-top: env(safe-area-inset-top, 0px);
			--safe-area-inset-left: env(safe-area-inset-left, 0px);
			--safe-area-inset-right: env(safe-area-inset-right, 0px);
		}
		body {
			margin: 0;
			padding: 0;
			font-family: Calibri, Arial, sans-serif;
			-webkit-tap-highlight-color: transparent;
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			user-select: none;
			overflow: hidden;
		}
		#map {
			width: 100%;
			height: 100vh;
			cursor: default;
			touch-action: pan-x pan-y;
		}
		#menu-button {
			position: absolute;
			top: calc(10px + var(--safe-area-inset-top));
			left: calc(10px + var(--safe-area-inset-left));
			width: 40px;
			height: 40px;
			background: white;
			border: 2px solid #ccc;
			border-radius: 6px;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			cursor: pointer;
			z-index: 1001;
			box-shadow: 0 0 8px rgba(0,0,0,0.3);
		}
		#menu-button span {
			display: block;
			width: 4px;
			height: 4px;
			background: #333;
			border-radius: 50%;
			margin: 1px 0;
		}
		#left-controls {
			position: absolute;
			top: calc(12px + var(--safe-area-inset-top));
			left: calc(60px + var(--safe-area-inset-left));
			display: flex;
			gap: 4px;
			z-index: 1000;
			align-items: center;
		}
		.control-btn {
			width: 40px;
			height: 40px;
			background: white;
			border: 2px solid #ccc;
			border-radius: 6px;
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
			box-shadow: 0 0 8px rgba(0,0,0,0.3);
			font-size: 20px;
			color: #333;
			padding: 0;
			margin: 0;
			font-weight: bold;
			line-height: 1;
		}
		#search-points-btn {
			width: 40px;
			height: 40px;
			background: white;
			border: 2px solid #ccc;
			border-radius: 6px;
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
			box-shadow: 0 0 8px rgba(0,0,0,0.3);
			font-size: 20px;
			color: #333;
			padding: 0;
			margin: 0;
			font-weight: bold;
			line-height: 1;
		}
		#zoom-level-display {
			width: 30px;
			height: 30px;
			display: flex;
			justify-content: center;
			align-items: center;
			font-weight: bold;
			font-size: 14px;
			color: #007bff;
			text-shadow:
				-1px -1px 0 white,
				1px -1px 0 white,
				-1px 1px 0 white,
				1px 1px 0 white;
			pointer-events: none;
		}
		#dropdown-menu {
			display: none;
			position: absolute;
			top: 55px;
			left: 10px;
			background: #e8e8e8;
			padding: 8px;
			border-radius: 6px;
			box-shadow: 0 0 10px rgba(0,0,0,0.4);
			z-index: 2000;
			width: fit-content;
			font-size: 12px;
			max-height: 75vh;
			overflow-y: auto;
		}
		#dropdown-menu.active {
			display: block;
		}
		.menu-section {
			margin-bottom: 8px;
			display: flex;
			flex-direction: column;
			gap: 4px;
		}
		.menu-label {
			display: block;
			font-weight: bold;
			color: #222;
			margin-bottom: 4px;
			font-size: 14px;
		}
		.menu-btn {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			font-weight: bold;
			font-size: 12px;
			background: #dcdcdc;
			border: 1px solid #aaa;
			border-radius: 3px;
			cursor: pointer;
			padding: 8px 10px;
			white-space: nowrap;
			width: 100%;
		}
		.menu-btn:hover {
			background: #ccc;
		}
		#status {
			position: absolute;
			bottom: calc(12px + var(--safe-area-inset-bottom));
			left: calc(12px + var(--safe-area-inset-left));
			background: #e8e8e8;
			padding: 8px 12px;
			border-radius: 4px;
			font-size: 14px;
			color: #222;
			z-index: 1000;
			max-width: calc(300px - var(--safe-area-inset-left));
			line-height: 1.4;
			box-shadow: 0 1px 4px rgba(0,0,0,0.25);
		}
		.route-distance {
			color: red;
			font-weight: bold;
		}
		#clear-route-btn {
			position: absolute;
			bottom: calc(70px + var(--safe-area-inset-bottom));
			left: calc(12px + var(--safe-area-inset-left));
			padding: 8px 12px;
			font-size: 14px;
			background: #dcdcdc;
			border: 1px solid #aaa;
			border-radius: 4px;
			cursor: pointer;
			z-index: 1000;
			box-shadow: 0 1px 4px rgba(0,0,0,0.25);
			font-weight: bold;
			display: none;
		}
		.map-controls {
			position: absolute;
			top: calc(12px + var(--safe-area-inset-top));
			z-index: 1003;
			align-items: center;
		}
		.right-controls {
			right: calc(12px + var(--safe-area-inset-right));
			display: flex;
			gap: 8px;
		}
		.left-controls {
			left: calc(60px + var(--safe-area-inset-left));
			display: flex;
			gap: 8px;
		}
		.map-controls button {
			width: 40px;
			height: 40px;
			background: white;
			border: 2px solid #ccc;
			border-radius: 6px;
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
			box-shadow: 0 0 8px rgba(0,0,0,0.3);
			font-size: 20px;
			color: #333;
			padding: 0;
			margin: 0;
			font-weight: bold;
			line-height: 1;
		}
		#kp-layer-btn, #kp-layer-btn-google, #danger-layer-btn, #danger-layer-btn-google {
			font-size: 13px !important;
			font-weight: bold !important;
		}
		#all-edges-btn {
			font-size: 16px !important;
		}
		.layer-active {
			background-color: #4CAF50 !important;
			border-color: #388E3C !important;
			color: white !important;
		}
		#loading-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			z-index: 2000;
			justify-content: center;
			align-items: center;
		}
		#loading-modal {
			background: white;
			padding: 20px 30px;
			border-radius: 10px;
			font-size: 18px;
			font-weight: bold;
			text-align: center;
			box-shadow: 0 4px 20px rgba(0,0,0,0.6);
		}
		.custom-dialog-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.7);
			z-index: 10000;
			justify-content: center;
			align-items: center;
		}
		.custom-dialog {
			background: white;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 4px 20px rgba(0,0,0,0.8);
			font-family: Calibri, Arial, sans-serif;
			max-width: 90%;
			width: 400px;
			z-index: 10001;
		}
		.custom-dialog-title {
			font-weight: bold;
			font-size: 16px;
			margin-bottom: 15px;
			text-align: center;
			color: #222;
		}
		.custom-dialog-message {
			font-size: 14px;
			line-height: 1.5;
			margin-bottom: 20px;
			text-align: center;
		}
		.custom-dialog-buttons {
			display: flex;
			gap: 10px;
			justify-content: center;
		}
		.custom-dialog-button {
			padding: 8px 20px;
			font-size: 14px;
			border: 1px solid #aaa;
			border-radius: 5px;
			cursor: pointer;
			font-weight: bold;
			min-width: 80px;
		}
		.custom-dialog-button-ok {
			background: #dcdcdc;
		}
		.leaflet-popup-tip {
			display: none !important;
		}
		.leaflet-popup-content-wrapper {
			margin-top: 15px !important;
		}
		.leaflet-popup {
			bottom: 0 !important;
			margin-bottom: 15px !important;
		}
		.route-io-section {
			border: 2px solid #007BFF;
			border-radius: 4px;
			padding: 8px;
			background-color: #f0f8ff;
			margin-bottom: 8px;
			font-size: 13px
		}
		.route-save-row,
		.route-load-row {
			display: flex;
			align-items: center;
			gap: 4px;
			margin-bottom: 4px;
		}
		.menu-label.inline {
			margin: 0;
			font-weight: bold;
			font-size: 11px;
			white-space: nowrap;
			min-width: 60px;
		}
		#route-name,
		#bookmark-name {
			flex: 1;
			min-width: 60px;
			padding: 6px 8px;
			font-size: 11px;
			border: 2px solid #007BFF;
			border-radius: 6px;
			box-sizing: border-box;
			background-color: #fff;
			height: 28px;
		}
		.menu-btn.icon-only {
			width: 26px;
			height: 26px;
			padding: 0;
			display: flex;
			justify-content: center; 
			align-items: center;     
			font-size: 12px;
			background: #dcdcdc;
			border: 1px solid #aaa;
			border-radius: 3px;
			cursor: pointer;
			flex-shrink: 0;
		}
		#route-points-popup {
			position: fixed;
			bottom: calc(140px + var(--safe-area-inset-bottom));
			right: calc(12px + var(--safe-area-inset-right));
			background: white;
			padding: 12px;
			border: 2px solid #aaffaa;
			border-radius: 8px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.4);
			max-height: 30vh;
			overflow-y: auto;
			font-family: Calibri, Arial, sans-serif;
			font-size: 13px;
			z-index: 2000;
			max-width: 130px;
			display: none;
		}
		.route-point-item {
			cursor: pointer;
			padding: 6px 8px;
			border-radius: 4px;
			transition: background-color 0.2s;
			margin: 3px 0;
			background-color: #e6f7ff;
			border-left: 3px solid #b3e0ff;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}
		.route-point-item:hover {
			background-color: #d0ebff;
		}
		.direction-indicator {
			font-size: 16px;
			margin-left: 8px;
			width: 20px;
			text-align: center;
		}
		#show-route-points-btn {
			position: absolute;
			bottom: calc(100px + var(--safe-area-inset-bottom));
			right: calc(12px + var(--safe-area-inset-right));
			padding: 8px 12px;
			background: #dcdcdc;
			border: 1px solid #aaa;
			border-radius: 4px;
			font-size: 14px;
			cursor: pointer;
			z-index: 1000;
			display: none;
			box-shadow: 0 1px 4px rgba(0,0,0,0.25);
		}
		#add-point-popup {
			display: none;
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: white;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 8px 30px rgba(0,0,0,0.8);
			z-index: 10000;
			width: 300px;
			max-width: 90%;
			font-family: Calibri, Arial, sans-serif;
			border: 3px solid #8B008B;
		}
		#add-point-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.7);
			z-index: 9999;
		}
		#add-point-popup h3 {
			margin: 0 0 15px;
			text-align: center;
			font-size: 18px;
			color: #8B008B;
			font-weight: bold;
		}
		#add-point-popup label {
			display: block;
			margin-top: 12px;
			font-size: 14px;
			font-weight: bold;
			color: #333;
		}
		#add-point-popup input,
		#add-point-popup textarea {
			width: 100%;
			padding: 10px;
			margin-top: 5px;
			border: 2px solid #ccc;
			border-radius: 6px;
			font-family: Calibri, Arial, sans-serif;
			font-size: 14px;
			box-sizing: border-box;
		}
		#add-point-popup-buttons {
			display: flex;
			gap: 10px;
			margin-top: 20px;
		}
		#add-point-popup-buttons button {
			flex: 1;
			padding: 10px;
			font-weight: bold;
			border: 2px solid #aaa;
			border-radius: 6px;
			cursor: pointer;
			font-family: Calibri, Arial, sans-serif;
			font-size: 14px;
		}
		.menu-copyright {
			text-align: center;
			margin-top: 8px;
			padding-top: 8px;
			border-top: 1px solid #aaa;
			width: 100%;
		}
		.menu-copyright a {
			text-decoration: none;
			color: #0066cc;
			font-weight: bold;
			font-size: 11px;
			display: inline-block;
			padding: 3px 6px;
			border-radius: 2px;
			transition: all 0.2s;
			text-shadow: 
				0 0 1px white,
				0 0 2px white;
			font-weight: 900;
			letter-spacing: 0.3px;
		}
		.menu-copyright a:hover {
			background-color: #dcdcdc;
			color: #004499;
			text-decoration: underline;
		}
		.kp-label-tech, .kp-label-point, .point-label-from-json, .user-point-label, .route-point-label, .danger-point-label {
			font-family: Calibri, Arial, sans-serif !important;
			font-weight: bold !important;
			background: transparent !important;
			border: none !important;
			white-space: nowrap !important;
		}
		.kp-label-tech {
			font-size: 10px !important;
			color: #ff0000 !important;
			text-shadow:
				-1px -1px 0 white,
				1px -1px 0 white,
				-1px 1px 0 white,
				1px 1px 0 white !important;
		}
		.kp-label-point {
			font-size: 10px !important;
			color: #004524 !important;
			text-shadow:
				-1px -1px 0 white,
				1px -1px 0 white,
				-1px 1px 0 white,
				1px 1px 0 white !important;
		}
		.point-label-from-json {
			font-size: 10px !important;
			color: #5D4037 !important;
			text-shadow:
				-1px -1px 0 white,
				1px -1px 0 white,
				-1px 1px 0 white,
				1px 1px 0 white !important;
		}
		.user-point-label {
			font-size: 12px !important;
			color: #8B008B !important;
			text-shadow:
				-1px -1px 0 white,
				1px -1px 0 white,
				-1px 1px 0 white,
				2px 2px 0 white !important;
		}
		.danger-point-label {
			font-size: 10px !important;
			color: #d32f2f !important;
			text-shadow:
				-1px -1px 0 white,
				1px -1px 0 white,
				-1px 1px 0 white,
				1px 1px 0 white !important;
		}
		.route-point-label-old {
			font-family: Calibri, Arial, sans-serif !important;
			font-size: 11px !important;
			font-weight: bold !important;
			color: #01579b !important;
			background: #e3f2fd !important;
			border: 1px solid #90caf9 !important;
			border-radius: 3px !important;
			padding: 1px 3px !important;
			white-space: nowrap !important;
			z-index: 100 !important;
			text-shadow:
				-1px -1px 0 white,
				1px -1px 0 white,
				-1px 1px 0 white,
				1px 1px 0 white !important;
		}
		.route-point-marker {
			stroke: white !important;
			stroke-width: 2px !important;
		}
		.label-hidden {
			display: none !important;
		}
		#points-controls-container {
			position: absolute;
			top: calc(60px + var(--safe-area-inset-top));
			right: calc(12px + var(--safe-area-inset-right));
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			gap: 8px;
			z-index: 1002;
		}
		#points-controls-main {
			display: flex;
			align-items: center;
			gap: 8px;
		}
		#points-controls-expanded {
			display: none;
			flex-direction: column;
			gap: 8px;
			margin-top: 8px;
			margin-right: 8px;
			transition: all 0.3s ease;
			align-items: flex-end;
		}
		#points-controls-expanded.active {
			display: flex;
			animation: slideInDown 0.3s ease;
		}
		@keyframes slideInDown {
			from {
				opacity: 0;
				transform: translateY(-20px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
		.points-control-btn {
			width: 40px;
			height: 40px;
			background: white;
			border: 2px solid #ccc;
			border-radius: 6px;
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
			box-shadow: 0 0 8px rgba(0,0,0,0.3);
			font-size: 20px;
			color: #333;
			padding: 0;
			margin: 0;
			font-weight: bold;
			line-height: 1;
			transition: all 0.2s;
		}
		#points-layer-btn.active {
			background-color: #8B008B !important;
			border-color: #6A006A !important;
			color: white !important;
		}
		#add-point-btn {
			background-color: white !important;
			border-color: #ccc !important;
			color: #333 !important;
			display: none;
		}
		#add-point-btn.active {
			background-color: #4CAF50 !important;
			border-color: #388E3C !important;
			color: white !important;
		}
		#edit-points-btn.active {
			background-color: #4CAF50 !important;
			border-color: #388E3C !important;
			color: white !important;
		}
		#edit-points-btn {
			background-color: white !important;
			border-color: #ccc !important;
			color: #333 !important;
			display: none;
		}
		#delete-point-btn {
			background-color: white !important;
			border-color: #ccc !important;
			color: #333 !important;
			display: none;
		}
		#delete-all-points-btn {
			background-color: white !important;
			border-color: #ccc !important;
			color: #333 !important;
			display: none;
		}
		.user-point-marker.editing {
			animation: pulse 1.5s infinite;
			cursor: pointer;
		}
		@keyframes pulse {
			0% {
				box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7);
			}
			70% {
				box-shadow: 0 0 0 10px rgba(255, 152, 0, 0);
			}
			100% {
				box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
			}
		}
		.user-point-marker.selected {
			animation: selected-pulse 1s infinite;
			box-shadow: 0 0 0 5px rgba(255, 152, 0, 0.7) !important;
		}
		@keyframes selected-pulse {
			0% {
				box-shadow: 0 0 0 5px rgba(255, 152, 0, 0.7);
			}
			70% {
				box-shadow: 0 0 0 15px rgba(255, 152, 0, 0);
			}
			100% {
				box-shadow: 0 0 0 5px rgba(255, 152, 0, 0.7);
			}
		}
		#edit-point-popup .custom-dialog {
			background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
			border: 3px solid #ff9800;
			border-radius: 12px;
			padding: 25px;
			box-shadow: 0 8px 25px rgba(0,0,0,0.3);
			width: 320px;
			max-width: 90vw;
		}
		#edit-point-popup .custom-dialog-title {
			font-size: 18px;
			font-weight: bold;
			color: #333;
			margin-bottom: 20px;
			text-align: center;
			padding-bottom: 10px;
			border-bottom: 2px solid #eee;
		}
		#edit-point-popup .custom-dialog-message {
			display: flex;
			flex-direction: column;
			gap: 15px;
		}
		#edit-point-popup label {
			display: block;
			font-weight: bold;
			color: #333;
			margin-bottom: 5px;
			font-size: 14px;
		}
		#edit-point-popup input,
		#edit-point-popup textarea {
			width: 100%;
			padding: 10px;
			border: 2px solid #ddd;
			border-radius: 6px;
			font-family: Calibri, Arial, sans-serif;
			font-size: 14px;
			box-sizing: border-box;
			transition: border-color 0.3s;
		}
		#edit-point-popup input:focus,
		#edit-point-popup textarea:focus {
			outline: none;
			border-color: #ff9800;
			box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.2);
		}
		#edit-point-popup input {
			height: 40px;
		}
		#edit-point-popup textarea {
			min-height: 80px;
			resize: vertical;
		}
		#edit-point-popup .custom-dialog-buttons {
			display: flex;
			gap: 10px;
			justify-content: space-between;
			margin-top: 20px;
		}
		#edit-point-popup .custom-dialog-button {
			padding: 10px 20px;
			font-size: 14px;
			font-weight: bold;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			transition: all 0.3s;
			flex: 1;
			min-width: 80px;
			display: flex;
			align-items: center;
			justify-content: center;
			text-align: center;
		}
		#edit-point-cancel {
			background: #e0e0e0;
			color: #333;
		}
		#edit-point-delete {
			background: #f44336;
			color: white;
		}
		#edit-point-save {
			background: #4CAF50;
			color: white;
		}
		#search-panel {
			position: absolute;
			top: calc(58px + var(--safe-area-inset-top));
			left: calc(60px + var(--safe-area-inset-left));
			width: 220px;
			display: none;
			z-index: 1003;
			transition: all 0.3s ease;
		}
		#search-input {
			width: 100%;
			padding: 8px 12px;
			border: 2px solid #aaa;
			border-radius: 4px;
			font-size: 14px;
			font-family: Calibri, Arial, sans-serif;
			box-shadow: 0 2px 6px rgba(0,0,0,0.3);
		}
		#search-input:focus {
			outline: none;
			border-color: #007bff;
			box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
		}
		#search-results-panel {
			max-height: 200px;
			overflow-y: auto;
			background: white;
			border: 2px solid #aaa;
			border-top: none;
			border-radius: 0 0 6px 6px;
			box-shadow: 0 2px 6px rgba(0,0,0,0.3);
			display: none;
		}
		.search-result-item-panel {
			padding: 6px 12px;
			cursor: pointer;
			font-size: 14px;
			font-family: Calibri, Arial, sans-serif;
			border-bottom: 1px solid #eee;
			-webkit-tap-highlight-color: transparent;
		}
		.search-result-item-panel:hover {
			background-color: #f0f8ff;
		}
		.search-highlight-marker {
			z-index: 10000 !important;
		}
		.search-highlight-marker .leaflet-marker-icon {
			filter: drop-shadow(0 0 8px rgba(0, 102, 204, 0.8));
		}
		.search-halo {
			animation: halo-pulse 2s infinite;
			z-index: 500 !important;
		}
		@keyframes halo-pulse {
			0% {
				opacity: 0.7;
				transform: scale(1);
			}
			50% {
				opacity: 0.9;
				transform: scale(1.1);
			}
			100% {
				opacity: 0.7;
				transform: scale(1);
			}
		}
		.smooth-pan {
			transition: transform 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
		}
		.route-point-item strong {
			color: #0066cc !important;
			font-weight: bold !important;
		}
		.legend-item {
			display: flex;
			align-items: center;
			margin: 4px 0;
			font-size: 12px;
		}
		.legend-color {
			width: 16px;
			height: 16px;
			margin-right: 8px;
			border-radius: 2px;
			border: 1px solid #aaa;
		}
		.tunnel-legend {
			margin-top: 8px;
			padding: 8px;
			background: #f8f9fa;
			border-radius: 4px;
			border: 1px solid #ddd;
			font-size: 12px;
		}
		.tunnel-legend-title {
			font-weight: bold;
			margin-bottom: 6px;
			color: #333;
			text-align: center;
		}
		.leaflet-control-attribution {
			display: none !important;
		}

		#basic-map-controls {
			position: absolute;
			top: calc(12px + var(--safe-area-inset-top));
			right: calc(12px + var(--safe-area-inset-right));
			display: none;
			flex-direction: row;
			gap: 8px;
			z-index: 1003;
			align-items: center;
		}

		#basic-map-controls-2 {
			position: absolute;
			top: calc(70px + var(--safe-area-inset-top));
			right: calc(12px + var(--safe-area-inset-right));
			display: none;
			flex-direction: row;
			gap: 8px;
			z-index: 1003;
			align-items: center;
		}

		#google-map-controls {
			position: absolute;
			top: calc(12px + var(--safe-area-inset-top));
			right: calc(12px + var(--safe-area-inset-right));
			display: none;
			flex-direction: row;
			gap: 8px;
			z-index: 1003;
			align-items: center;
		}

		#google-map-controls-2 {
			position: absolute;
			top: calc(70px + var(--safe-area-inset-top));
			right: calc(12px + var(--safe-area-inset-right));
			display: none;
			flex-direction: row;
			gap: 8px;
			z-index: 1003;
			align-items: center;
		}

		#basic-map-controls button,
		#basic-map-controls-2 button,
		#google-map-controls button,
		#google-map-controls-2 button {
			width: 40px;
			height: 40px;
			background: white;
			border: 2px solid #ccc;
			border-radius: 6px;
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
			box-shadow: 0 0 8px rgba(0,0,0,0.3);
			font-size: 20px;
			color: #333;
			padding: 0;
			margin: 0;
			font-weight: bold;
			line-height: 1;
		}

		#kp-layer-btn, #kp-layer-btn-google, #danger-layer-btn, #danger-layer-btn-google {
			font-size: 13px !important;
			font-weight: bold !important;
		}

		#all-edges-btn {
			font-size: 16px !important;
		}

		#basic-map-controls,
		#google-map-controls {
			display: none;
			flex-direction: row;
			gap: 8px;
		}

		#undo-btn,
		#undo-btn-google {
			order: 1;
		}

		#lock-btn,
		#lock-btn-google {
			order: 2;
		}

		#kp-layer-btn,
		#kp-layer-btn-google {
			order: 3;
		}

		#danger-layer-btn,
		#danger-layer-btn-google {
			order: 4;
		}

		#all-edges-btn {
			order: 5;
		}

		.route-point-item.selected {
			background-color: #ff9800 !important;
			border-left: 3px solid #ff5722 !important;
			font-weight: bold;
			color: white !important;
		}

		.route-point-item.selected strong {
			color: white !important;
			font-weight: bold;
		}

		.route-point-item.selected .direction-indicator {
			color: white !important;
			font-weight: bold;
		}

		.add-point-cursor {
			cursor: crosshair !important;
		}

		#danger-layer-btn::after,
		#danger-layer-btn-google::after {
			content: "üö∑";
			font-size: 26px;
			display: flex;
			align-items: center;
			justify-content: center;
			width: 100%;
			height: 100%;
		}

		#danger-layer-btn,
		#danger-layer-btn-google {
			font-size: 0 !important;
			padding: 0 !important;
		}

		#danger-layer-btn.layer-active::after,
		#danger-layer-btn-google.layer-active::after {
			color: white !important;
		}

		#user-points-panel {
			position: fixed;
			bottom: calc(200px + var(--safe-area-inset-bottom));
			left: calc(12px + var(--safe-area-inset-left));
			background: white;
			padding: 12px;
			border: 2px solid #8B008B;
			border-radius: 8px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.3);
			max-height: 50vh;
			overflow-y: auto;
			font-family: Calibri, Arial, sans-serif;
			font-size: 13px;
			z-index: 1500;
			width: 220px;
			display: none;
		}

		#user-points-panel h3 {
			margin: 0 0 10px 0;
			text-align: center;
			font-size: 14px;
			color: #8B008B;
			font-weight: bold;
			padding-bottom: 6px;
			border-bottom: 1px solid #ddd;
		}

		#user-points-list {
			display: flex;
			flex-direction: column;
			gap: 6px;
			max-height: 40vh;
			overflow-y: auto;
			margin-bottom: 10px;
		}

		.user-point-list-item {
			cursor: pointer;
			padding: 8px 10px;
			border-radius: 6px;
			transition: all 0.2s;
			background: #f9f9f9;
			border: 1px solid #ddd;
			border-left: 3px solid #8B008B;
		}

		.user-point-list-item:hover {
			background: #f0f0f0;
			border-color: #ccc;
		}

		.user-point-list-item.selected {
			background: #8B008B;
			border-color: #6A006A;
			color: white;
		}

		.user-point-list-item.selected .point-name {
			color: white;
		}

		.point-info {
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.point-index {
			background: #8B008B;
			color: white;
			width: 20px;
			height: 20px;
			border-radius: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 11px;
			font-weight: bold;
			flex-shrink: 0;
		}

		.point-name {
			font-weight: bold;
			color: #333;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			max-width: 140px;
		}

		.point-comment {
			font-size: 11px;
			color: #666;
			margin-top: 2px;
		}

		.user-points-stats {
			background: #f5f5f5;
			border-radius: 4px;
			padding: 6px 8px;
			margin-top: 8px;
			border: 1px solid #ddd;
			font-size: 11px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.user-points-stats .count {
			color: #8B008B;
			font-weight: bold;
		}

		.point-actions {
			margin-top: 4px;
			display: flex;
			gap: 4px;
		}

		.point-actions button {
			padding: 2px 6px;
			font-size: 11px;
			border: 1px solid #ccc;
			border-radius: 3px;
			background: #f0f0f0;
			cursor: pointer;
		}

		.point-actions button:hover {
			background: #e0e0e0;
		}

		.point-actions .delete-btn {
			color: #c00;
			border-color: #f99;
		}

		.point-actions .edit-btn {
			color: #090;
			border-color: #9f9;
		}

		.dragging-point {
			cursor: grabbing !important;
			z-index: 10000 !important;
		}

		.dragging-mode {
			cursor: grab !important;
		}

		.dragging-mode .point-marker {
			cursor: grab !important;
		}

		.dragging-mode .point-marker:hover {
			cursor: grab !important;
		}

		.dragging-mode-active {
			cursor: grabbing !important;
		}

		.route-point-marker {
			cursor: pointer;
		}

		.route-point-marker:hover {
			cursor: grab;
		}

		.route-point-marker.dragging {
			cursor: grabbing !important;
			z-index: 10000 !important;
		}

		.drag-guide-line {
			stroke-dasharray: 5, 5;
			stroke-width: 2;
			stroke: #ff9800;
			fill: none;
			pointer-events: none;
		}

		.drag-target-circle {
			stroke: #4CAF50;
			stroke-width: 3;
			fill: rgba(76, 175, 80, 0.2);
			pointer-events: none;
		}

		.nearest-node-marker {
			stroke: #2196F3;
			stroke-width: 2;
			fill: rgba(33, 150, 243, 0.3);
			pointer-events: none;
		}

		.route-segment-hover {
			pointer-events: none !important;
			z-index: 500 !important;
		}

		.route-add-point-cursor {
			cursor: pointer !important;
		}

		.route-length-label {
			font-family: Calibri, Arial, sans-serif !important;
			font-size: 12px !important;
			font-weight: bold !important;
			color: red !important;
			background: white !important;
			border: 2px solid #0d47a1 !important;
			border-radius: 4px !important;
			padding: 2px 6px !important;
			white-space: nowrap !important;
			z-index: 1002 !important;
			text-shadow: none !important;
			box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
			pointer-events: none !important;
		}
		 
		.route-point-marker {
			pointer-events: auto !important;
		}

		.route-point-marker-enlarged {
			stroke-width: 3px !important;
			filter: drop-shadow(0 0 2px rgba(0,0,0,0.3));
		}

		.route-point-hit-area {
			pointer-events: auto !important;
			fill: transparent !important;
			stroke: transparent !important;
		}

		#mobile-warning {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.85);
			z-index: 100000;
			justify-content: center;
			align-items: center;
			color: white;
			text-align: center;
			padding: 20px;
			font-family: Calibri, Arial, sans-serif;
		}

		#mobile-warning-content {
			background: #1a1a1a;
			border-radius: 12px;
			padding: 30px;
			max-width: 90%;
			border: 2px solid #ff9800;
			box-shadow: 0 0 30px rgba(255, 152, 0, 0.5);
		}

		#mobile-warning h2 {
			color: #ff9800;
			margin-top: 0;
			font-size: 22px;
		}

		#mobile-warning p {
			font-size: 16px;
			line-height: 1.5;
			margin: 15px 0;
		}

		#mobile-warning-timer {
			font-size: 18px;
			color: #4CAF50;
			font-weight: bold;
			margin: 20px 0;
		}

		#mobile-warning-close {
			background: #ff9800;
			color: white;
			border: none;
			padding: 12px 24px;
			font-size: 16px;
			border-radius: 6px;
			cursor: pointer;
			font-weight: bold;
			margin-top: 10px;
		}

		#mobile-warning-close:hover {
			background: #ffb74d;
		}

		.user-points-panel-fixed {
			position: fixed !important;
		}
    </style>
</head>
<body>
    <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ -->
    <div id="mobile-warning">
        <div id="mobile-warning-content">
            <h2>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</h2>
            <p>–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –ü–ö.</p>
            <p>–ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –æ–Ω–æ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ: –º–µ–ª–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, —Å–ª–æ–∂–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è, –≤–æ–∑–º–æ–∂–Ω—ã –ª–∞–≥–∏.</p>
            <p>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ —Å –º—ã—à—å—é –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–ø—ã—Ç–∞.</p>
            <div id="mobile-warning-timer">–ó–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑: <span id="timer-count">10</span> —Å–µ–∫.</div>
            <button id="mobile-warning-close">–ü–æ–Ω—è—Ç–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>
    
    <div id="menu-button" title="–ú–µ–Ω—é">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div id="left-controls">
        <button class="control-btn" id="zoom-in" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
        <button class="control-btn" id="zoom-out" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
        <div id="zoom-level-display">0</div>
        <button id="search-points-btn" title="–ü–æ–∏—Å–∫ —Ç–æ—á–µ–∫">üîç</button>
    </div>
    
    <div id="search-panel">
        <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ—á–µ–∫...">
        <div id="search-results-panel"></div>
    </div>
    
    <!-- –ë–∞–∑–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–¥–ª—è –∫–∞—Ä—Ç byaki.png –∏ map2.png) - –ü–ï–†–ï–ú–ï–©–ï–ù–´ –í–ü–†–ê–í–û -->
    <div id="basic-map-controls" style="display: none;">
        <!-- –ö–Ω–æ–ø–∫–∞ undo —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–≤–æ–π (–∫—Ä–∞–π–Ω—è—è –ª–µ–≤–∞—è) -->
        <button id="undo-btn" style="display: none;" title="–®–∞–≥ –Ω–∞–∑–∞–¥">‚Ü©Ô∏è</button>
        <button id="lock-btn" title="–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞">üîì</button>
        <button id="kp-layer-btn" title="–ö–ü —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π 2025 –≥.">–ö–ü 2025</button>
        <!-- –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –¥–ª—è –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç -->
        <button id="danger-layer-btn" title="–û–ø–∞—Å–Ω—ã–µ –º–µ—Å—Ç–∞"></button>
    </div>

    <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è Google –∫–∞—Ä—Ç - –ü–ï–†–ï–ú–ï–©–ï–ù–´ –í–ü–†–ê–í–û -->
    <div id="google-map-controls" style="display: none;">
        <!-- –ö–Ω–æ–ø–∫–∞ undo —Å–∫—Ä—ã—Ç–∞ –Ω–∞ Google –∫–∞—Ä—Ç–∞—Ö -->
        <button id="undo-btn-google" style="display: none;" title="–®–∞–≥ –Ω–∞–∑–∞–¥">‚Ü©Ô∏è</button>
        <!-- –ö–Ω–æ–ø–∫–∞ lock —Å–∫—Ä—ã—Ç–∞ –Ω–∞ Google –∫–∞—Ä—Ç–∞—Ö -->
        <button id="lock-btn-google" title="–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞" style="display: none;">üîì</button>
        <button id="kp-layer-btn-google" title="–ö–ü —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π 2025 –≥.">–ö–ü 2025</button>
        <!-- –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –¥–ª—è –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç -->
        <button id="danger-layer-btn-google" title="–û–ø–∞—Å–Ω—ã–µ –º–µ—Å—Ç–∞"></button>
        <button id="all-edges-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏ –∏ —Ä–µ–±—Ä–∞">üìç</button>
    </div>
    
    <div id="points-controls-container">
        <div id="points-controls-main">
            <button id="points-layer-btn" class="points-control-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –º–µ—Ç–∫–∏">üìå</button>
        </div>
        <div id="points-controls-expanded">
            <button id="add-point-btn" class="points-control-btn" title="–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É">‚ûï</button>
            <button id="edit-points-btn" class="points-control-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∫–∏">‚úèÔ∏è</button>
            <button id="delete-point-btn" class="points-control-btn" title="–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–µ—Ç–∫—É">üóëÔ∏è</button>
            <button id="delete-all-points-btn" class="points-control-btn" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏">üóëÔ∏è</button>
        </div>
    </div>
    
    <div id="dropdown-menu">
        <div class="menu-section">
            <span class="menu-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É:</span>
            <select id="background-select">
                <option value="byaki.png">–ë–∞–∑–æ–≤–∞—è –∫–∞—Ä—Ç–∞</option>
                <option value="map2.png">–ö–∞—Ä—Ç–∞ —Å –∑–∞–ª–∏–≤–∫–æ–π</option>
                <option value="google-satellite">Google Satellite</option>
            </select>
        </div>
        
        <div class="menu-section route-io-section">
            <div style="text-align: center; font-weight: bold; margin-bottom: 8px; font-size: 13px;">–ú–∞—Ä—à—Ä—É—Ç</div>
            <div class="route-save-row">
                <span class="menu-label inline">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å:</span>
                <input type="text" id="route-name" placeholder="–ò–º—è –º–∞—Ä—à—Ä—É—Ç–∞">
                <button class="menu-btn icon-only" id="save-route" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –≤ —Ñ–∞–π–ª">üíæ</button>
            </div>
            <div class="route-load-row">
                <span class="menu-label inline">–ó–∞–≥—Ä—É–∑–∏—Ç—å:</span>
                <button class="menu-btn icon-only" id="load-route" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –∏–∑ —Ñ–∞–π–ª–∞">üìÅ</button>
                <input type="file" id="route-file-input" accept=".json" style="display: none;">
            </div>
        </div>
        
        <div class="menu-section route-io-section">
            <div style="text-align: center; font-weight: bold; margin-bottom: 8px; font-size: 13px;">–ú–µ—Ç–∫–∏</div>
            <div class="route-save-row">
                <span class="menu-label inline">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å:</span>
                <input type="text" id="bookmark-name" placeholder="–ò–º—è –º–µ—Ç–æ–∫">
                <button class="menu-btn icon-only" id="save-bookmark" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∫–∏ –≤ —Ñ–∞–π–ª">üíæ</button>
            </div>
            <div class="route-load-row">
                <span class="menu-label inline">–ó–∞–≥—Ä—É–∑–∏—Ç—å:</span>
                <button class="menu-btn icon-only" id="load-bookmark" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ç–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞">üìÅ</button>
                <input type="file" id="bookmark-file-input" accept=".geojson" style="display: none;">
            </div>
        </div>
        
        <!-- –î–û–ë–ê–í–õ–ï–ù –ë–õ–û–ö –°–¢–ê–¢–ò–°–¢–ò–ö–ò -->
        <div class="menu-section route-io-section">
            <div style="text-align: center; font-weight: bold; margin-bottom: 8px; font-size: 13px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            <div style="
				font-size: 11px;
				padding: 5px;
				background: white;
				border-radius: 3px;
				border: 1px solid #ddd;
				text-align: center;
				line-height: 1.2;
				margin: 3px 0;
			">
                –ü–æ—Å—á–∏—Ç–∞–Ω–Ω–∞—è –ø—Ä–æ—Ç—è–∂–µ–Ω–Ω–æ—Å—Ç—å –≤—Å–µ—Ö —à—Ç—Ä–µ–∫–æ–≤:<br>
                <span id="total-tunnel-length" style="
                    font-weight: bold;
                    color: #007bff;
                    font-size: 13px;
                ">–∑–∞–≥—Ä—É–∑–∫–∞...</span> –º–µ—Ç—Ä–æ–≤
            </div>
        </div>
        
        <div class="menu-section">
            <button class="menu-btn" id="show-disclaimer">‚ÑπÔ∏è –û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</button>
        </div>
        <div class="menu-copyright">
            <a href="https://t.me/Aleks_Donor" target="_blank" rel="noopener noreferrer">
                ¬© by Alex Donor
            </a>
        </div>
    </div>
    
    <button id="clear-route-btn" title="–£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –º–∞—Ä—à—Ä—É—Ç">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
    
    <!-- –û–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫ -->
    <div id="user-points-panel">
        <h3>–ú–æ–∏ –º–µ—Ç–∫–∏</h3>
        <div id="user-points-list"></div>
        <div class="user-points-stats">
            <span>–í—Å–µ–≥–æ: <span class="count">0</span></span>
            <button id="close-points-panel">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <button id="show-route-points-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –Ω–∏—Ç–∫—É –º–∞—Ä—à—Ä—É—Ç–∞">üìç</button>
    
    <div id="route-points-popup">
        <div style="font-weight: bold; margin-bottom: 8px; text-align: center;">
            <div style="font-size: 13px;">–ù–∏—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞</div>
            <div style="font-size: 11px; font-weight: normal; margin-top: -2px;">
                (—Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–∫–∞–∑–∞–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–µ–≤–µ—Ä–∞)
            </div>
        </div>
        <div id="route-points-list"></div>
    </div>
    
    <div id="map"></div>
    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    
    <div id="loading-overlay">
        <div id="loading-modal">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ‚Ä¶<br>–ú–∞—Ä—à—Ä—É—Ç —Å—Ç—Ä–æ–∏—Ç—Å—è</div>
    </div>
    
    <div id="add-point-overlay"></div>
    <div id="add-point-popup">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –º–µ—Ç–∫—É</h3>
        <label for="point-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" id="point-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
        <label for="point-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea id="point-comment" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" rows="3"></textarea>
        <div id="add-point-popup-buttons">
            <button id="add-point-cancel">–û—Ç–º–µ–Ω–∞</button>
            <button id="add-point-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <div id="edit-point-overlay" class="custom-dialog-overlay">
        <div id="edit-point-popup" class="custom-dialog" style="width: 300px;">
            <div class="custom-dialog-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–∫—É</div>
            <div class="custom-dialog-message">
                <label for="edit-point-name">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" id="edit-point-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                <label for="edit-point-comment" style="margin-top: 10px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="edit-point-comment" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ" rows="3"></textarea>
            </div>
            <div class="custom-dialog-buttons">
                <button id="edit-point-cancel" class="custom-dialog-button">–û—Ç–º–µ–Ω–∞</button>
                <button id="edit-point-delete" class="custom-dialog-button" style="background: #f44336; color: white;">–£–¥–∞–ª–∏—Ç—å</button>
                <button id="edit-point-save" class="custom-dialog-button" style="background: #4CAF50; color: white;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div id="custom-alert-overlay" class="custom-dialog-overlay">
        <div class="custom-dialog">
            <div class="custom-dialog-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div class="custom-dialog-message" id="custom-alert-message"></div>
            <div class="custom-dialog-buttons">
                <button id="custom-alert-ok" class="custom-dialog-button custom-dialog-button-ok">OK</button>
            </div>
        </div>
    </div>
    
    <div id="disclaimer-overlay" class="custom-dialog-overlay">
        <div style="
            background: white;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            font-family: Calibri, Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        ">
            <h3 style="margin-top: 0; margin-bottom: 15px; color: #222; text-align: center;">–û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏</h3>
            <div style="text-align: justify;">
                <p style="margin-top: 0; margin-bottom: 12px;">–ù–∞—Å—Ç–æ—è—â–µ–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ (–¥–∞–ª–µ–µ ‚Äî –ü—Ä–æ–¥—É–∫—Ç) —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –∏ —Ä–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö –∏ –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–∞–∫–æ–π-–ª–∏–±–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏–ª–∏ –Ω–µ–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å –ø—Ä–µ–±—ã–≤–∞–Ω–∏–µ–º –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Ä–∞–±–æ—Ç –ø–æ–¥ –∑–µ–º–ª—ë–π, –≤–∫–ª—é—á–∞—è, –Ω–æ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—è—Å—å: —Å–ø–µ–ª–µ–æ–ª–æ–≥–∏–µ–π, –ø–æ–¥–∑–µ–º–Ω—ã–º —Ç—É—Ä–∏–∑–º–æ–º, –≥–æ—Ä–Ω—ã–º–∏, —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–º–∏, –∞–≤–∞—Ä–∏–π–Ω–æ-—Å–ø–∞—Å–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∏ –∏–Ω—ã–º–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º–∏ –≤–∏–¥–∞–º–∏ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.</p>
                <p style="margin-top: 0; margin-bottom: 12px;">–ê–≤—Ç–æ—Ä –ü—Ä–æ–¥—É–∫—Ç–∞ –Ω–µ –¥–∞—ë—Ç –Ω–∏–∫–∞–∫–∏—Ö –≥–∞—Ä–∞–Ω—Ç–∏–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–æ—á–Ω–æ—Å—Ç–∏, –ø–æ–ª–Ω–æ—Ç—ã, –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –∏–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤, –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∏–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–æ—Å—è—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏.</p>
                <p style="margin-top: 0; margin-bottom: 12px;">–ê–≤—Ç–æ—Ä –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ª—é–±–æ–π —É—â–µ—Ä–±, —É–±—ã—Ç–∫–∏, —Ç—Ä–∞–≤–º—ã –∏–ª–∏ –∏–Ω—ã–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è, –≤–æ–∑–Ω–∏–∫—à–∏–µ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ü—Ä–æ–¥—É–∫—Ç–∞, –≤ —Ç–æ–º —á–∏—Å–ª–µ –ø—Ä–∏ –µ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –≤ —É—Å–ª–æ–≤–∏—è—Ö, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —Ä–∏—Å–∫–æ–º –¥–ª—è –∂–∏–∑–Ω–∏ –∏ –∑–¥–æ—Ä–æ–≤—å—è.</p>
                <p style="margin-top: 0; margin-bottom: 12px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ü—Ä–æ–¥—É–∫—Ç –Ω–∞ —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ –∏ –æ—Å–æ–∑–Ω–∞—ë—Ç, —á—Ç–æ –æ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≤ –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∏–ª–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏–ª–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–∑–µ–º–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤.</p>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="close-disclaimer" style="
                    padding: 8px 20px;
                    font-size: 14px;
                    background: #dcdcdc;
                    border: 1px solid #aaa;
                    border-radius: 5px;
                    cursor: pointer;
                    font-weight: bold;
                    min-width: 100px;
                ">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 4,
            zoomControl: false,
            tap: false,
            touchZoom: true,
            scrollWheelZoom: true,
            dragging: true,
            wheelPxPerZoomLevel: 60,
            attributionControl: false // –û—Ç–∫–ª—é—á–∞–µ–º –∞—Ç—Ç—Ä–∏–±—É—Ü–∏—é
        });
        
        // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        let selectedRoutePointIndex = null; // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏ –≤ –Ω–∏—Ç–∫–µ –º–∞—Ä—à—Ä—É—Ç–∞
        
        const SCALE_CORRECTION = 84 / 145.9;
        const ENTRANCE_COORDS_EPSG3857 = [4252305.4, 7245838.4];
        const REQUIRED_FILES = [
            'tunnels_json.geojson',
            'kp_2025.geojson', 
            'points_json.geojson',
            'danger_points.geojson',
            'byaki.png',
            'map2.png'
        ];
        
        let currentImageOverlay = null, googleSatelliteLayer = null;
        let currentMapType = 'byaki.png', entranceMarker = null, routeLocked = false;
        let menuOpen = false, isUserPointsMode = false, isEditMode = false;
        let pendingPointCoords = null, selectedPointIndex = null;
        let kpLayer = null, kpLayerVisible = false;
        let userPointsLayer = null, userPointsLayerVisible = false;
        let jsonPointsLayer = null, jsonPointsLayerVisible = false;
        let dangerLayer = null, dangerLayerVisible = false;
        let allEdgesLayer = null, allEdgesLayerVisible = false; // –ù–æ–≤—ã–π —Å–ª–æ–π –¥–ª—è –≤—Å–µ—Ö —Ä–µ–±–µ—Ä
        let segments = [], graph = {}, segmentWeights = {};
        let selectedPoints = [], pointMarkers = [], routeLayer = null;
        let routePointMarkers = [], routeLabelMarkers = [];
        let mapBounds = null, fullRoutePath = [], allPointsGeoJson = null;
        let userPointsData = { type: "FeatureCollection", features: [] };
        let userPointMarkers = [], userPointLabels = [];
        let searchPanelVisible = false, searchHighlightMarker = null, searchHaloMarker = null;
        let lastSearchQuery = '';
        let routeLengthLabelMarker = null; // –î–ª—è –º–µ—Ç–∫–∏ —Å –¥–ª–∏–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∞
        let userPointsPanelFixed = false; // –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ –º–µ—Ç–æ–∫
        let mobileWarningShown = false; // –§–ª–∞–≥ –ø–æ–∫–∞–∑–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö

        // ==================== –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø –¢–û–ß–ï–ö ====================
        let isDraggingPoint = false;
        let draggedPointIndex = -1;
        let dragStartPoint = null;
        let dragGuideLine = null;
        let dragTargetCircle = null;
        let nearestNodeMarker = null;
        let originalPointPosition = null;
        let isDragModeEnabled = false;

        // ==================== –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –¢–û–ß–ï–ö –ù–ê –°–ï–ì–ú–ï–ù–¢–´ ====================
        let hoverSegmentLine = null; // –î–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å–µ–≥–º–µ–Ω—Ç–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function updateZoomDisplay() {
            document.getElementById('zoom-level-display').textContent = Math.round(map.getZoom());
        }
        
        function showCustomAlert(message) {
            const overlay = document.getElementById('custom-alert-overlay');
            document.getElementById('custom-alert-message').textContent = message;
            overlay.style.display = 'flex';
            document.getElementById('custom-alert-ok').onclick = () => overlay.style.display = 'none';
            overlay.onclick = (e) => { if (e.target === overlay) overlay.style.display = 'none'; };
        }
        
        function hideLoadingOverlay() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        function showLoadingOverlay(message = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ‚Ä¶<br>–ú–∞—Ä—à—Ä—É—Ç —Å—Ç—Ä–æ–∏—Ç—Å—è") {
            document.getElementById('loading-modal').innerHTML = message;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        
        function wgs84ToEpsg3857(lat, lng) {
            const R = 6378137;
            const x = (lng * Math.PI / 180) * R;
            const y = Math.log(Math.tan((90 + lat) * Math.PI / 360)) * R;
            return [x, y];
        }
        
        function epsg3857ToWgs84(x, y) {
            const R = 6378137;
            const lng = (x / R) * (180 / Math.PI);
            const lat = (Math.PI / 2 - 2 * Math.atan(Math.exp(-y / R))) * (180 / Math.PI);
            return [lat, lng];
        }
        
        function addEntranceMarker() {
            if (entranceMarker) map.removeLayer(entranceMarker);
            
            let latlng;
            if (currentMapType === 'google-satellite') {
                const [x, y] = ENTRANCE_COORDS_EPSG3857;
                latlng = epsg3857ToWgs84(x, y);
            } else {
                latlng = [ENTRANCE_COORDS_EPSG3857[1], ENTRANCE_COORDS_EPSG3857[0]];
            }
            
            entranceMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'entrance-marker-large',
                    html: '<span style="font-size: 30px">‚õî</span>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map).bindPopup("–í—Ö–æ–¥ –≤ –ì—É—Ä—å–µ–≤—Å–∫–∏–µ –∫–∞–º–µ–Ω–æ–ª–æ–º–Ω–∏");
        }
        
        // ==================== –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ö–û–ù–¢–†–û–õ–û–í ====================
        function updateControlsVisibility() {
            const isGoogle = currentMapType === 'google-satellite';
            
            // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–º
            document.getElementById('clear-route-btn').style.display = isGoogle ? 'none' : (selectedPoints.length > 0 ? 'block' : 'none');
            document.getElementById('show-route-points-btn').style.display = isGoogle ? 'none' : 'none';
            document.getElementById('route-points-popup').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –±–ª–æ–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if (isGoogle) {
                document.getElementById('google-map-controls').style.display = 'flex';
                document.getElementById('basic-map-controls').style.display = 'none';
                
                // –ù–∞ Google –∫–∞—Ä—Ç–∞—Ö —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –º–∞—Ä—à—Ä—É—Ç–æ–º
                document.getElementById('undo-btn-google').style.display = 'none';
                document.getElementById('lock-btn-google').style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                document.getElementById('kp-layer-btn-google').classList.toggle('layer-active', kpLayerVisible);
                document.getElementById('danger-layer-btn-google').classList.toggle('layer-active', dangerLayerVisible);
                document.getElementById('all-edges-btn').classList.toggle('layer-active', allEdgesLayerVisible);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è Google –∫–∞—Ä—Ç
                if (kpLayerVisible) {
                    document.getElementById('status').textContent = `–°–ª–æ–π –ö–ü 2025 –∑–∞–≥—Ä—É–∂–µ–Ω`;
                } else if (dangerLayerVisible) {
                    document.getElementById('status').textContent = `–°–ª–æ–π –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω`;
                } else if (allEdgesLayerVisible) {
                    document.getElementById('status').textContent = `–°–ª–æ–π –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –∏ —Ä–µ–±–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω`;
                } else {
                    document.getElementById('status').textContent = '–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ—è–º–∏.';
                }
            } else {
                document.getElementById('basic-map-controls').style.display = 'flex';
                document.getElementById('google-map-controls').style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                document.getElementById('kp-layer-btn').classList.toggle('layer-active', kpLayerVisible);
                document.getElementById('danger-layer-btn').classList.toggle('layer-active', dangerLayerVisible);
                document.getElementById('lock-btn').textContent = routeLocked ? 'üîí' : 'üîì';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ undo
                document.getElementById('undo-btn').style.display = selectedPoints.length > 0 ? 'flex' : 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç
                if (selectedPoints.length === 0) {
                    document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å—Ö–µ–º—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ—á–µ–∫.';
                } else if (selectedPoints.length === 1) {
                    document.getElementById('status').textContent = '–í—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é.';
                } else {
                    document.getElementById('status').textContent = '–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω';
                }
            }
        }
        
        function updateMarkersVisibilityForCurrentMap() {
            const zoom = map.getZoom();
            const isGoogle = currentMapType === 'google-satellite';
            const showLabels = isGoogle ? zoom >= 17 : true;
            
            [kpLayer, jsonPointsLayer, userPointsLayer, dangerLayer, allEdgesLayer].forEach((layer, idx) => {
                if (layer) {
                    layer.eachLayer(l => {
                        const element = l.getElement ? l.getElement() : null;
                        if (element && element.classList.contains('leaflet-marker-icon')) {
                            element.style.display = showLabels ? '' : 'none';
                        }
                    });
                }
            });
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ====================
        async function loadGeoJsonFile(filename) {
            try {
                const response = await fetch(filename);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${filename}:`, error);
                return { type: "FeatureCollection", features: [] };
            }
        }
        
        // ==================== –†–ê–°–ß–ï–¢ –û–ë–©–ï–ô –î–õ–ò–ù–´ –®–¢–†–ï–ö–û–í ====================
        async function calculateTotalTunnelLength() {
            try {
                const data = await loadGeoJsonFile('tunnels_json.geojson');
                if (!data || data.type !== "FeatureCollection" || !Array.isArray(data.features)) {
                    document.getElementById('total-tunnel-length').textContent = '–æ—à–∏–±–∫–∞';
                    return;
                }
                
                let totalLength = 0;
                
                data.features.forEach(f => {
                    if (!f.geometry) return;
                    
                    let lines = [];
                    if (f.geometry.type === 'LineString') {
                        lines = [f.geometry.coordinates];
                    } else if (f.geometry.type === 'MultiLineString') {
                        lines = f.geometry.coordinates;
                    } else {
                        return;
                    }
                    
                    lines.forEach(coords => {
                        if (!Array.isArray(coords) || coords.length < 2) return;
                        
                        for (let i = 0; i < coords.length - 1; i++) {
                            const a = coords[i];
                            const b = coords[i + 1];
                            
                            if (!Array.isArray(a) || !Array.isArray(b) || a.length < 2 || b.length < 2) continue;
                            
                            const dx = a[0] - b[0];
                            const dy = a[1] - b[1];
                            const segmentLength = Math.sqrt(dx * dx + dy * dy);
                            totalLength += segmentLength;
                        }
                    });
                });
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–ø—Ä–∞–≤–æ—á–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∞
                const correctedLength = totalLength * SCALE_CORRECTION;
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á
                const formattedLength = Math.round(correctedLength).toLocaleString('ru-RU');
                document.getElementById('total-tunnel-length').textContent = formattedLength;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –¥–ª–∏–Ω—ã —à—Ç—Ä–µ–∫–æ–≤:', error);
                document.getElementById('total-tunnel-length').textContent = '–æ—à–∏–±–∫–∞';
            }
        }
        
        // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–°–ß–ï–¢–ê –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ô ====================
        function calculateSegmentDirection(start, end) {
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö (0-360)
            const dx = end[0] - start[0];
            const dy = end[1] - start[1];
            let angle = Math.atan2(dy, dx) * (180 / Math.PI);
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É–≥–æ–ª –æ—Ç 0 –¥–æ 360
            if (angle < 0) angle += 360;
            
            return angle;
        }
        
        function getDirectionArrow(angle) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–≥–ª–∞ (0¬∞ = –≤–æ—Å—Ç–æ–∫, 90¬∞ = —Å–µ–≤–µ—Ä, 180¬∞ = –∑–∞–ø–∞–¥, 270¬∞ = —é–≥)
            if (angle >= 337.5 || angle < 22.5) return '‚Üí'; // –í–ø—Ä–∞–≤–æ (–≤–æ—Å—Ç–æ–∫)
            if (angle >= 22.5 && angle < 67.5) return '‚Üó'; // –í–ø—Ä–∞–≤–æ-–≤–≤–µ—Ä—Ö (—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫)
            if (angle >= 67.5 && angle < 112.5) return '‚Üë'; // –í–≤–µ—Ä—Ö (—Å–µ–≤–µ—Ä)
            if (angle >= 112.5 && angle < 157.5) return '‚Üñ'; // –í–ª–µ–≤–æ-–≤–≤–µ—Ä—Ö (—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥)
            if (angle >= 157.5 && angle < 202.5) return '‚Üê'; // –í–ª–µ–≤–æ (–∑–∞–ø–∞–¥)
            if (angle >= 202.5 && angle < 247.5) return '‚Üô'; // –í–ª–µ–≤–æ‚Äì–≤–Ω–∏–∑ (—é–≥–æ-–∑–∞–ø–∞–¥)
            if (angle >= 247.5 && angle < 292.5) return '‚Üì'; // –í–Ω–∏–∑ (—é–≥)
            if (angle >= 292.5 && angle < 337.5) return '‚Üò'; // –í–ø—Ä–∞–≤–æ-–≤–Ω–∏–∑ (—é–≥–æ-–≤–æ—Å—Ç–æ–∫)
            return '‚Üí';
        }
        
        // ==================== –ù–ê–•–û–ñ–î–ï–ù–ò–ï –¢–û–ß–ï–ö –í–ë–õ–ò–ó–ò –ú–ê–†–®–†–£–¢–ê (–° –ü–†–û–í–ï–†–ö–û–ô –î–£–ë–õ–ï–ô) ====================
        function findPointsNearRoute(routeCoords, pointsGeoJson, maxDistance = 2.5) {
            if (!pointsGeoJson || !pointsGeoJson.features) return [];
            
            const nearbyPoints = [];
            const visitedPointKeys = new Set();
            
            function getPointKey(coords) {
                return `${coords[0].toFixed(3)},${coords[1].toFixed(3)}`;
            }
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å–µ–≥–º–µ–Ω—Ç–∞–º –º–∞—Ä—à—Ä—É—Ç–∞ –∏ –Ω–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫–∏ –≤ –ø–æ—Ä—è–¥–∫–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
            for (let segmentIndex = 0; segmentIndex < routeCoords.length - 1; segmentIndex++) {
                const a = routeCoords[segmentIndex];
                const b = routeCoords[segmentIndex + 1];
                
                // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Ç–æ—á–∫–∏
                pointsGeoJson.features.forEach(feature => {
                    if (feature.geometry.type !== "Point") return;
                    
                    const pt = feature.geometry.coordinates;
                    const name = feature.properties?.Name;
                    
                    if (name == null || !Array.isArray(pt) || pt.length < 2) return;
                    
                    const pointKey = getPointKey(pt);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ –¥–æ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
                    const distanceToSegment = pointToSegmentDistance(pt, a, b);
                    
                    if (distanceToSegment <= maxDistance) {
                        // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ–µ–∫—Ü–∏—é —Ç–æ—á–∫–∏ –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç
                        const t = getProjectionFactor(pt, a, b);
                        
                        // –ü–æ–∑–∏—Ü–∏—è —Ç–æ—á–∫–∏ –≤–¥–æ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞
                        const positionAlongRoute = segmentIndex + Math.max(0, Math.min(1, t));
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∞ –ª–∏ —ç—Ç–∞ —Ç–æ—á–∫–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞ —ç—Ç–æ–º —É—á–∞—Å—Ç–∫–µ –º–∞—Ä—à—Ä—É—Ç–∞
                        // –ï—Å–ª–∏ —Ç–æ—á–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä—è–¥–æ–º —Å –∫–æ–Ω—Ü–æ–º —Å–µ–≥–º–µ–Ω—Ç–∞, –æ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ —Å–ª–µ–¥—É—é—â–∏–º —Å–µ–≥–º–µ–Ω—Ç–æ–º
                        if (t < 0.9 || segmentIndex === routeCoords.length - 2) {
                            // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á —Å —É—á–µ—Ç–æ–º –ø–æ–∑–∏—Ü–∏–∏ –≤–¥–æ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞
                            const routeKey = `${pointKey}_${positionAlongRoute.toFixed(2)}`;
                            
                            if (!visitedPointKeys.has(routeKey)) {
                                // –ù–∞—Ö–æ–¥–∏–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ
                                let directionSegment = getDirectionSegmentForPoint(pt, routeCoords, segmentIndex);
                                
                                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å–µ–≥–º–µ–Ω—Ç –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π
                                if (!directionSegment) {
                                    directionSegment = {
                                        start: a,
                                        end: b,
                                        direction: calculateSegmentDirection(a, b)
                                    };
                                }
                                
                                nearbyPoints.push({
                                    name,
                                    coords: pt,
                                    directionAngle: directionSegment.direction,
                                    segmentIndex: segmentIndex,
                                    t: t,
                                    positionAlongRoute: positionAlongRoute,
                                    distanceToSegment: distanceToSegment,
                                    pointKey: pointKey
                                });
                                
                                visitedPointKeys.add(routeKey);
                            }
                        }
                    }
                });
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ —Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
            nearbyPoints.sort((a, b) => {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É —Å–µ–≥–º–µ–Ω—Ç–∞
                if (a.segmentIndex !== b.segmentIndex) {
                    return a.segmentIndex - b.segmentIndex;
                }
                // –ï—Å–ª–∏ –Ω–∞ –æ–¥–Ω–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ - –ø–æ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç–µ
                return a.t - b.t;
            });
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Ç–æ—á–∫–∏ (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–¥—Ä—è–¥)
            const filteredPoints = [];
            
            for (let i = 0; i < nearbyPoints.length; i++) {
                const currentPoint = nearbyPoints[i];
                
                // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –µ–µ
                if (i === 0) {
                    filteredPoints.push(currentPoint);
                    continue;
                }
                
                const previousPoint = nearbyPoints[i - 1];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∞—è —Ç–æ—á–∫–∞ –¥—É–±–ª–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–π
                if (!isSamePoint(currentPoint.coords, previousPoint.coords, 0.001)) {
                    filteredPoints.push(currentPoint);
                }
                // –ï—Å–ª–∏ —Ç–æ—á–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ–∫—É—â—É—é (–Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º)
            }
            
            return filteredPoints.map(p => ({
                name: p.name,
                coords: p.coords,
                directionAngle: p.directionAngle
            }));
        }

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function isSamePoint(coords1, coords2, tolerance = 0.001) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–≤–ø–∞–¥–∞—é—Ç –ª–∏ –¥–≤–µ —Ç–æ—á–∫–∏ —Å –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
            if (!coords1 || !coords2 || !Array.isArray(coords1) || !Array.isArray(coords2)) return false;
            if (coords1.length < 2 || coords2.length < 2) return false;
            
            return Math.abs(coords1[0] - coords2[0]) < tolerance && Math.abs(coords1[1] - coords2[1]) < tolerance;
        }

        function pointToSegmentDistance(p, a, b) {
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ p –¥–æ –æ—Ç—Ä–µ–∑–∫–∞ ab
            const dx = b[0] - a[0];
            const dy = b[1] - a[1];
            const l2 = dx * dx + dy * dy;
            
            if (l2 === 0) {
                // –ï—Å–ª–∏ a –∏ b —Å–æ–≤–ø–∞–¥–∞—é—Ç
                return Math.hypot(p[0] - a[0], p[1] - a[1]);
            }
            
            const t = Math.max(0, Math.min(1, ((p[0] - a[0]) * dx + (p[1] - a[1]) * dy) / l2));
            const projX = a[0] + t * dx;
            const projY = a[1] + t * dy;
            
            return Math.hypot(p[0] - projX, p[1] - projY);
        }

        function getProjectionFactor(p, a, b) {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä t ‚àà [0,1] –ø—Ä–æ–µ–∫—Ü–∏–∏ —Ç–æ—á–∫–∏ p –Ω–∞ –æ—Ç—Ä–µ–∑–æ–∫ ab
            const dx = b[0] - a[0];
            const dy = b[1] - a[1];
            const l2 = dx * dx + dy * dy;
            
            if (l2 === 0) return 0;
            
            return ((p[0] - a[0]) * dx + (p[1] - a[1]) * dy) / l2;
        }

        function getDirectionSegmentForPoint(pointCoords, routeCoords, currentSegmentIndex) {
            // –ù–∞—Ö–æ–¥–∏—Ç —Å–µ–≥–º–µ–Ω—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è –≤ —Ç–æ—á–∫–µ
            // –ò—â–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∑–Ω–∞—á–∏–º—ã–π —Å–µ–≥–º–µ–Ω—Ç (–Ω–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π)
            const maxLookAhead = Math.min(3, routeCoords.length - currentSegmentIndex - 2);
            
            for (let i = 0; i <= maxLookAhead; i++) {
                const idx = currentSegmentIndex + i;
                if (idx >= routeCoords.length - 1) break;
                
                const start = routeCoords[idx];
                const end = routeCoords[idx + 1];
                const length = Math.hypot(end[0] - start[0], end[1] - start[1]);
                
                if (length > 0.1) { // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã
                    return {
                        start: start,
                        end: end,
                        direction: calculateSegmentDirection(start, end)
                    };
                }
            }
            
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∑–Ω–∞—á–∏–º—ã–π —Å–µ–≥–º–µ–Ω—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π
            if (currentSegmentIndex < routeCoords.length - 1) {
                const start = routeCoords[currentSegmentIndex];
                const end = routeCoords[currentSegmentIndex + 1];
                return {
                    start: start,
                    end: end,
                    direction: calculateSegmentDirection(start, end)
                };
            }
            
            return null;
        }
        
        async function loadTunnelsData() {
            const data = await loadGeoJsonFile('tunnels_json.geojson');
            if (!data || data.type !== "FeatureCollection" || !Array.isArray(data.features)) return;
            
            const allCoords = [];
            segments = [];
            graph = {};
            segmentWeights = {};
            
            data.features.forEach(f => {
                if (!f.geometry) return;
                let lines = [];
                if (f.geometry.type === 'LineString') lines = [f.geometry.coordinates];
                else if (f.geometry.type === 'MultiLineString') lines = f.geometry.coordinates;
                else return;
                
                let weight = f.properties?.weight || 5;
                lines.forEach(coords => {
                    if (!Array.isArray(coords) || coords.length < 2) return;
                    coords.forEach(pt => Array.isArray(pt) && pt.length >= 2 && allCoords.push(pt));
                    
                    for (let i = 0; i < coords.length - 1; i++) {
                        const a = coords[i], b = coords[i + 1];
                        if (!Array.isArray(a) || !Array.isArray(b) || a.length < 2 || b.length < 2) continue;
                        
                        segments.push([a, b]);
                        const keyA = a.join(','), keyB = b.join(',');
                        const baseLength = Math.hypot(a[0] - b[0], a[1] - b[1]);
                        let cost;
                        if (weight === 1) cost = baseLength * 1000;
                        else if (weight === 2) cost = baseLength * 4;
                        else if (weight === 3) cost = baseLength * 1.5;
                        else if (weight === 4) cost = baseLength * 5;
                        else cost = baseLength;
                        
                        if (!graph[keyA]) graph[keyA] = {};
                        if (!graph[keyB]) graph[keyB] = {};
                        if (!graph[keyA][keyB] || cost < graph[keyA][keyB]) {
                            graph[keyA][keyB] = graph[keyB][keyA] = cost;
                            const segmentKey = `${keyA}-${keyB}`;
                            segmentWeights[segmentKey] = segmentWeights[`${keyB}-${keyA}`] = weight;
                        }
                    }
                });
            });
            
            if (allCoords.length > 0) {
                const xs = allCoords.map(c => c[0]), ys = allCoords.map(c => c[1]);
                const minX = Math.min(...xs), minY = Math.min(...ys);
                const maxX = Math.max(...xs), maxY = Math.max(...ys);
                mapBounds = [[minY, minX], [maxY, maxX]];
            } else {
                mapBounds = [[0, 0], [1000, 1000]];
            }
        }
        
        // ==================== –ê–õ–ì–û–†–ò–¢–ú A* ====================
        class PriorityQueue {
            constructor() {
                this.heap = [];
                this.nodeMap = new Map();
            }
        
            push(node, priority) {
                const item = { node, priority };
                this.heap.push(item);
                this.nodeMap.set(node, this.heap.length - 1);
                this._siftUp(this.heap.length - 1);
            }
        
            pop() {
                if (this.heap.length === 0) return null;
                if (this.heap.length === 1) {
                    const item = this.heap.pop();
                    this.nodeMap.delete(item.node);
                    return item.node;
                }
        
                const top = this.heap[0];
                const last = this.heap.pop();
                this.heap[0] = last;
                this.nodeMap.set(last.node, 0);
                this.nodeMap.delete(top.node);
                this._siftDown(0);
                return top.node;
            }
        
            isEmpty() {
                return this.heap.length === 0;
            }
        
            _siftUp(index) {
                while (index > 0) {
                    const parent = Math.floor((index - 1) / 2);
                    if (this.heap[parent].priority <= this.heap[index].priority) break;
                    this._swap(parent, index);
                    index = parent;
                }
            }
        
            _siftDown(index) {
                const n = this.heap.length;
                while (true) {
                    let left = 2 * index + 1;
                    let right = 2 * index + 2;
                    let smallest = index;
        
                    if (left < n && this.heap[left].priority < this.heap[smallest].priority) smallest = left;
                    if (right < n && this.heap[right].priority < this.heap[smallest].priority) smallest = right;
                    if (smallest === index) break;
        
                    this._swap(index, smallest);
                    index = smallest;
                }
            }
        
            _swap(i, j) {
                [this.heap[i], this.heap[j]] = [this.heap[j], this.heap[i]];
                this.nodeMap.set(this.heap[i].node, i);
                this.nodeMap.set(this.heap[j].node, j);
            }
        }
        
        function heuristic(a, b) {
            const [ax, ay] = a.split(',').map(Number);
            const [bx, by] = b.split(',').map(Number);
            return Math.sqrt(Math.pow(bx - ax, 2) + Math.pow(by - ay, 2));
        }
        
        function aStar(graph, start, end) {
            if (start === end) return [start.split(',').map(Number)];
            if (!graph[start] || !graph[end]) return null;
        
            const openSet = new PriorityQueue();
            const cameFrom = new Map();
            const gScore = new Map();
            const fScore = new Map();
        
            gScore.set(start, 0);
            fScore.set(start, heuristic(start, end));
            openSet.push(start, fScore.get(start));
        
            while (!openSet.isEmpty()) {
                const current = openSet.pop();
        
                if (current === end) {
                    const path = [];
                    let node = current;
                    while (node) {
                        path.unshift(node.split(',').map(Number));
                        node = cameFrom.get(node);
                    }
                    return path;
                }
        
                for (const neighbor in graph[current]) {
                    const tentativeGScore = gScore.get(current) + graph[current][neighbor];
        
                    if (!gScore.has(neighbor) || tentativeGScore < gScore.get(neighbor)) {
                        cameFrom.set(neighbor, current);
                        gScore.set(neighbor, tentativeGScore);
                        fScore.set(neighbor, tentativeGScore + heuristic(neighbor, end));
                        openSet.push(neighbor, fScore.get(neighbor));
                    }
                }
            }
        
            return null;
        }
        
        // ==================== –†–ê–ë–û–¢–ê –° –ú–ê–†–®–†–£–¢–û–ú ====================
        function calculateRealDistance(coord1, coord2) {
            const dx = coord1[0] - coord2[0];
            const dy = coord1[1] - coord2[1];
            return Math.sqrt(dx * dx + dy * dy) * SCALE_CORRECTION;
        }
        
        function getColorForSegment(start, end) {
            const segmentKey = `${start.join(',')}-${end.join(',')}`;
            const reverseKey = `${end.join(',')}-${start.join(',')}`;
            const weight = segmentWeights[segmentKey] || segmentWeights[reverseKey];
            
            const colors = {
                1: '#000000',      // –ó–∞–≤–∞–ª
                2: '#ff0000',      // –®–∫—É—Ä–æ–¥–µ—Ä
                3: '#ffa500',      // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ
                4: '#0000ff',      // –í–æ–¥–∞
                default: '#00ff00' // –°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥
            };
            return colors[weight] || colors.default;
        }
        
        function buildFullRoute() {
            if (selectedPoints.length < 2) {
                showCustomAlert('–î–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏');
                return;
            }
            
            if (Object.keys(graph).length === 0) {
                showCustomAlert('–ì—Ä–∞—Ñ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª tunnels_json.geojson');
                return;
            }
        
            showLoadingOverlay();
        
            setTimeout(() => {
                try {
                    if (routeLayer) map.removeLayer(routeLayer);
                    routeLayer = null;
                    
                    routePointMarkers.forEach(marker => map.removeLayer(marker));
                    routeLabelMarkers.forEach(marker => map.removeLayer(marker));
                    routePointMarkers = [];
                    routeLabelMarkers = [];
                    
                    // –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É –¥–ª–∏–Ω—ã –º–∞—Ä—à—Ä—É—Ç–∞
                    if (routeLengthLabelMarker) {
                        map.removeLayer(routeLengthLabelMarker);
                        routeLengthLabelMarker = null;
                    }
            
                    fullRoutePath = [];
                    const routeGroup = L.featureGroup();
                    let totalDistance = 0;
            
                    for (let i = 0; i < selectedPoints.length - 1; i++) {
                        const start = selectedPoints[i], end = selectedPoints[i + 1];
                        const startKey = start.join(','), endKey = end.join(',');
            
                        const segmentPath = aStar(graph, startKey, endKey);
            
                        if (!segmentPath) {
                            showCustomAlert(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø—É—Ç—å –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ ${i+1} –∏ ${i+2}`);
                            hideLoadingOverlay();
                            return;
                        }
            
                        fullRoutePath.push(...(i === 0 ? segmentPath : segmentPath.slice(1)));
            
                        for (let j = 1; j < segmentPath.length; j++) {
                            const a = segmentPath[j - 1], b = segmentPath[j];
                            totalDistance += calculateRealDistance(a, b);
            
                            if (currentMapType !== 'google-satellite') {
                                L.polyline([[a[1], a[0]], [b[1], b[0]]], {
                                    color: getColorForSegment(a, b),
                                    weight: 6,
                                    opacity: 0.8
                                }).addTo(routeGroup);
                            }
                        }
                    }
            
                    if (currentMapType !== 'google-satellite') {
                        routeLayer = routeGroup.addTo(map);
                        
                        // –£–±–∏—Ä–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –º–∞—Ä—à—Ä—É—Ç–∞ –≤ —Å—Ç–∞—Ç—É—Å–µ
                        document.getElementById('status').innerHTML = 
                            `–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω`;
                        
                        addRoutePointLabels(totalDistance);
                        addRouteJsonPointLabels();
                        setupDragAndDropForRoutePoints();
                    }
                    
                    updateRoutePointsList();
                    updateRouteButtonsVisibility();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                    showCustomAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.');
                    
                    if (selectedPoints.length > 0) {
                        document.getElementById('status').textContent = 
                            `–í—ã–±—Ä–∞–Ω–æ ${selectedPoints.length} —Ç–æ—á–µ–∫. –û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è.`;
                    }
                } finally {
                    hideLoadingOverlay();
                    // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–¢–ö–†–´–¢–ò–ï –û–ö–ù–ê "–ù–ò–¢–ö–ê –ú–ê–†–®–†–£–¢–ê" - –¢–û–õ–¨–ö–û –î–õ–Ø –ë–ê–ó–û–í–´–• –ö–ê–†–¢
                    setTimeout(() => {
                        if (currentMapType !== 'google-satellite' && fullRoutePath.length > 0 && allPointsGeoJson) {
                            const nearbyPoints = findPointsNearRoute(fullRoutePath, allPointsGeoJson, 2.5);
                            if (nearbyPoints.length > 0) {
                                document.getElementById('route-points-popup').style.display = 'block';
                                document.getElementById('show-route-points-btn').textContent = 'üëÅÔ∏è';
                                document.getElementById('show-route-points-btn').style.display = 'block';
                            }
                        }
                    }, 500);
                }
            }, 10);
        }
        
        // ==================== –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ü–û–î–ü–ò–°–ï–ô –ö –¢–û–ß–ö–ê–ú ====================
		function addRoutePointLabels(totalDistance) {
			routeLabelMarkers.forEach(marker => map.removeLayer(marker));
			routeLabelMarkers = [];
			
			// –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –º–µ—Ç–∫—É –¥–ª–∏–Ω—ã –º–∞—Ä—à—Ä—É—Ç–∞
			if (routeLengthLabelMarker) {
				map.removeLayer(routeLengthLabelMarker);
				routeLengthLabelMarker = null;
			}
			
			selectedPoints.forEach((pt, idx) => {
				const latlng = [pt[1], pt[0]];
				
				// –î–ª—è –≤—Å–µ—Ö —Ç–æ—á–µ–∫, –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π, —Å–æ–∑–¥–∞–µ–º –æ–±—ã—á–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏
				if (idx < selectedPoints.length - 1) {
					const labelText = idx === 0 ? '–°–¢–ê–†–¢' : String(idx);
					
					const label = L.marker(latlng, {
						icon: L.divIcon({
							className: 'route-point-label',
							html: `<div style="
								background: linear-gradient(135deg, #ff9800, #ffb74d);
								border: 2px solid #0d47a1;
								border-radius: 4px;
								padding: 2px 6px;
								color: #0d47a1;
								font-weight: bold;
								font-size: 12px;
								white-space: nowrap;
								box-shadow: 0 2px 4px rgba(0,0,0,0.3);
								transform: translateY(-8px);
							">${labelText}</div>`,
							iconSize: null,
							iconAnchor: [10, 22]
						}),
						interactive: false,
						zIndexOffset: 1000
					}).addTo(map);
					
					routeLabelMarkers.push(label);
				}
				updatePointMarkerStyle(idx);
			});
			
			// –û–°–û–ë–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –î–õ–Ø –¢–û–ß–ö–ò "–§–ò–ù–ò–®" - —Å–æ–∑–¥–∞–µ–º –µ—ë –≤–º–µ—Å—Ç–µ —Å –º–µ—Ç–∫–æ–π –¥–ª–∏–Ω—ã
			if (selectedPoints.length > 1 && totalDistance) {
				const finishPoint = selectedPoints[selectedPoints.length - 1];
				const latlng = [finishPoint[1], finishPoint[0]];
				
				// –°–æ–∑–¥–∞–µ–º –û–î–ò–ù –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –¥–≤—É–º—è –º–µ—Ç–∫–∞–º–∏: "–§–ò–ù–ò–®" –∏ "L = X –º"
				const combinedHtml = `
					<div style="
						display: flex;
						align-items: center;
						gap: 3px; /* 3 –ø–∏–∫—Å–µ–ª—è –º–µ–∂–¥—É –º–µ—Ç–∫–∞–º–∏ */
						transform: translateY(-8px);
					">
						<div style="
							background: linear-gradient(135deg, #ff9800, #ffb74d);
							border: 2px solid #0d47a1;
							border-radius: 4px;
							padding: 2px 6px;
							color: #0d47a1;
							font-weight: bold;
							font-size: 12px;
							white-space: nowrap;
							box-shadow: 0 2px 4px rgba(0,0,0,0.3);
						">–§–ò–ù–ò–®</div>
						<div style="
							background: white;
							border: 2px solid red;
							border-radius: 4px;
							padding: 2px 6px;
							color: red;
							font-weight: bold;
							font-size: 12px;
							white-space: nowrap;
							box-shadow: 0 2px 4px rgba(0,0,0,0.3);
						">L = ${totalDistance.toFixed(1)} –º</div>
					</div>
				`;
				
				const finishLabel = L.marker(latlng, {
					icon: L.divIcon({
						className: 'route-point-label',
						html: combinedHtml,
						iconSize: null,
						iconAnchor: [70, 25] // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤–µ—Å—å –±–ª–æ–∫
					}),
					interactive: false,
					zIndexOffset: 1000
				}).addTo(map);
				
				routeLabelMarkers.push(finishLabel);
			}
		}
        
        // ==================== –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–¢–ò–õ–Ø –ú–ê–†–ö–ï–†–û–í ====================
        function updatePointMarkerStyle(idx) {
            if (pointMarkers[idx]) {
                const fillColor = idx === 0 ? 'green' : idx === pointMarkers.length - 1 ? 'blue' : 'red';
                pointMarkers[idx].setStyle({ 
                    color: 'white',
                    fillColor: fillColor,
                    weight: 2,
                    className: 'route-point-marker route-point-marker-enlarged'
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏
                const latlng = pointMarkers[idx].getLatLng();
                const hitArea = L.circleMarker(latlng, {
                    radius: 15, // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–¥–∏—É—Å –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏
                    color: 'transparent',
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    weight: 0,
                    className: 'route-point-hit-area',
                    interactive: true
                }).addTo(map);
                
                // –°–≤—è–∑—ã–≤–∞–µ–º hit area —Å –º–∞—Ä–∫–µ—Ä–æ–º
                hitArea.on('mousedown', function(e) {
                    // –ü—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ä–∫–µ—Ä
                    const originalEvent = e.originalEvent || e;
                    pointMarkers[idx].fire('mousedown', { latlng: e.latlng, originalEvent: originalEvent });
                });
            }
        }
        
        function addRouteJsonPointLabels() {
            if (!allPointsGeoJson || currentMapType === 'google-satellite') return;
            
            const nearbyPoints = findPointsNearRoute(fullRoutePath, allPointsGeoJson, 2.5);
            
            nearbyPoints.forEach(point => {
                const latlng = [point.coords[1], point.coords[0]];
                
                const hasRouteLabel = routeLabelMarkers.some(label => {
                    const labelLatLng = label.getLatLng();
                    return Math.abs(labelLatLng.lat - latlng[0]) < 0.0001 && 
                           Math.abs(labelLatLng.lng - latlng[1]) < 0.0001;
                });
                
                if (hasRouteLabel) return;
                
                const marker = L.circleMarker(latlng, {
                    radius: 5,
                    color: '#0000FF',
                    fillColor: '#33FFEE',
                    weight: 2,
                    fillOpacity: 2
                }).addTo(map);
                routePointMarkers.push(marker);
                
                const label = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'route-point-label-old',
                        html: point.name.length > 15 ? point.name.substring(0, 12) + '...' : point.name,
                        iconSize: null,
                        iconAnchor: [0, -10]
                    }),
                    interactive: false,
                    pane: 'markerPane'
                }).addTo(map);
                
                if (label.getElement()) label.getElement().style.zIndex = '100';
                routeLabelMarkers.push(label);
            });
        }
        
        function updateLabelVisibility() {
            const zoom = map.getZoom();
            const hide = zoom < 0;
            
            routeLabelMarkers.forEach(label => {
                const element = label.getElement();
                if (element && element.classList.contains('route-point-label-old')) {
                    element.classList.toggle('label-hidden', hide);
                }
            });
            
            updateMarkersVisibilityForCurrentMap();
        }
        
        // ==================== –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–ü–ò–°–ö–ê –¢–û–ß–ï–ö ====================
        function updateRoutePointsList() {
            // –ù–∞ Google –∫–∞—Ä—Ç–∞—Ö –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ "–ù–∏—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞"
            if (currentMapType === 'google-satellite') {
                document.getElementById('show-route-points-btn').style.display = 'none';
                document.getElementById('route-points-popup').style.display = 'none';
                return;
            }
            
            if (!allPointsGeoJson || fullRoutePath.length === 0) {
                document.getElementById('show-route-points-btn').style.display = 'none';
                document.getElementById('route-points-popup').style.display = 'none';
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫–∏, –±–ª–∏–∑–∫–∏–µ –∫ –º–∞—Ä—à—Ä—É—Ç—É
            const nearbyPoints = findPointsNearRoute(fullRoutePath, allPointsGeoJson, 2.5);
            
            if (nearbyPoints.length > 0) {
                const listHtml = nearbyPoints.map((p, idx) => {
                    const displayName = p.name.length > 15 ? p.name.substring(0, 12) + '...' : p.name;
                    const directionArrow = getDirectionArrow(p.directionAngle);
                    
                    // –û–¢–ú–ï–ù–ê –í–´–î–ï–õ–ï–ù–ò–Ø –¢–û–ß–ï–ö –ü–†–ò –ù–ê–ß–ê–õ–¨–ù–û–ú –ü–û–°–¢–†–û–ï–ù–ò–ò
                    // –¢–æ—á–∫–∏ –Ω–µ –≤—ã–¥–µ–ª—è—é—Ç—Å—è –æ—Ä–∞–Ω–∂–µ–≤—ã–º —Ü–≤–µ—Ç–æ–º –ø—Ä–∏ –Ω–∞—á–∞–ª—å–Ω–æ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏
                    const isSelected = false; // –í—Å–µ–≥–¥–∞ false –ø—Ä–∏ –Ω–∞—á–∞–ª—å–Ω–æ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏
                    
                    return `<div class="route-point-item${isSelected ? ' selected' : ''}" data-index="${idx}" data-lng="${p.coords[0]}" data-lat="${p.coords[1]}" data-name="${p.name}">
                        <span><strong>${idx + 1}.</strong> ${displayName}</span>
                        <span class="direction-indicator" title="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏">${directionArrow}</span>
                    </div>`;
                }).join('');
                
                document.getElementById('route-points-list').innerHTML = listHtml;
                document.getElementById('show-route-points-btn').style.display = 'block';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–æ—á–µ–∫
                const titleElement = document.querySelector('#route-points-popup > div:first-child');
                if (titleElement) {
                    const originalTitle = titleElement.innerHTML;
                    titleElement.innerHTML = `<div style="font-size: 13px;">–ù–∏—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ (${nearbyPoints.length} —Ç–æ—á–µ–∫)</div>
                                             <div style="font-size: 11px; font-weight: normal; margin-top: -2px;">
                                                 (—Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–∫–∞–∑–∞–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–µ–≤–µ—Ä–∞)
                                             </div>`;
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–æ—á–∫—É
                selectedRoutePointIndex = null;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
                document.querySelectorAll('.route-point-item').forEach((item, idx) => {
                    item.addEventListener('click', (e) => {
                        const el = e.target.closest('.route-point-item');
                        if (!el) return;
                        
                        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Ç–æ—á–µ–∫
                        document.querySelectorAll('.route-point-item').forEach(point => {
                            point.classList.remove('selected');
                        });
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–µ
                        el.classList.add('selected');
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏
                        selectedRoutePointIndex = idx;
                        
                        const lng = parseFloat(el.getAttribute('data-lng'));
                        const lat = parseFloat(el.getAttribute('data-lat'));
                        const name = el.getAttribute('data-name');
                        
                        if (isNaN(lng) || isNaN(lat)) return;
                        
                        let latlng;
                        if (currentMapType === 'google-satellite') {
                            latlng = epsg3857ToWgs84(lng, lat);
                        } else {
                            latlng = [lat, lng];
                        }
                        
                        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                        clearSearchHighlight();
                        
                        // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–æ—á–∫–µ
                        map.flyTo(latlng, 3, {
                            duration: 1.5,
                            easeLinearity: 0.25
                        });
                        
                        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
                        setTimeout(() => {
                            // –°–æ–∑–¥–∞–µ–º –æ—Ä–∞–Ω–∂–µ–≤—ã–π –æ—Ä–µ–æ–ª
                            const highlightMarker = L.circleMarker(latlng, {
                                radius: 15,
                                color: '#FF9800',
                                fillColor: 'rgba(255, 152, 0, 0.3)',
                                weight: 3,
                                fillOpacity: 0.5,
                                className: 'search-halo',
                                pane: 'markerPane',
                                zIndexOffset: 500
                            }).addTo(map);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º popup —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç–æ—á–∫–∏ –∏ –ø–æ—Ä—è–¥–∫–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º
                            const popupMarker = L.marker(latlng, {
                                icon: L.divIcon({
                                    className: 'search-highlight-marker',
                                    html: '<div style="background-color: #FF9800; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(255, 152, 0, 0.8);"></div>',
                                    iconSize: [20, 20],
                                    iconAnchor: [10, 10]
                                }),
                                zIndexOffset: 1000
                            }).bindPopup(`<b>${idx + 1}. ${name}</b><br>–ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –≤ –º–∞—Ä—à—Ä—É—Ç–µ: ${idx + 1}`).openPopup().addTo(map);
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä—ã
                            if (!window.highlightMarkers) window.highlightMarkers = [];
                            window.highlightMarkers.push(highlightMarker, popupMarker);
                            
                            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ
                            setTimeout(() => {
                                clearSearchHighlight();
                            }, 10000);
                        }, 1500);
                    });
                });
            } else {
                document.getElementById('show-route-points-btn').style.display = 'none';
                document.getElementById('route-points-popup').style.display = 'none';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        function clearSearchHighlight() {
            if (window.highlightMarkers) {
                window.highlightMarkers.forEach(marker => {
                    if (marker && map.hasLayer(marker)) {
                        if (marker.closePopup) marker.closePopup();
                        map.removeLayer(marker);
                    }
                });
                window.highlightMarkers = [];
            }
        }
        
        function toggleRoutePointsPopup() {
            // –ù–∞ Google –∫–∞—Ä—Ç–∞—Ö –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ "–ù–∏—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞"
            if (currentMapType === 'google-satellite') {
                return;
            }
            
            const popup = document.getElementById('route-points-popup');
            const btn = document.getElementById('show-route-points-btn');
            
            if (popup.style.display === 'block') {
                popup.style.display = 'none';
                btn.textContent = 'üìç';
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–∫–Ω–∞
                selectedRoutePointIndex = null;
            } else {
                popup.style.display = 'block';
                btn.textContent = 'üëÅÔ∏è';
            }
        }
        
        function clearRoute() {
			clearAllRouteMarkers();
			
			selectedPoints = [];
			fullRoutePath = [];
			routeLocked = false;
			
			document.getElementById('lock-btn').textContent = 'üîì';
			document.getElementById('lock-btn-google').textContent = 'üîì';
			
			// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã
			if (currentMapType === 'google-satellite') {
				document.getElementById('status').textContent = '–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ—è–º–∏.';
			} else {
				document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞';
			}
			
			document.getElementById('clear-route-btn').style.display = 'none';
			
			// –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ "–ù–∏—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞"
			document.getElementById('route-points-popup').style.display = 'none';
			document.getElementById('show-route-points-btn').style.display = 'none';
			document.getElementById('show-route-points-btn').textContent = 'üìç';
			
			updateRouteButtonsVisibility();
		}
        
        // ==================== –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø UNDO ====================
        function undoLastPoint() {
			if (selectedPoints.length === 0) return;
			
			// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–∞–∫–∞—è —Ç–æ—á–∫–∞ —É–¥–∞–ª—è–µ—Ç—Å—è
			const pointToRemoveIndex = selectedPoints.length - 2; // –ü—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω—è—è —Ç–æ—á–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
			const isRemovingMiddlePoint = (selectedPoints.length > 2);
			
			if (selectedPoints.length > 2) {
				// –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É (—Ç–æ—á–∫—É –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ)
				selectedPoints.splice(pointToRemoveIndex, 1);
				
				// –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä —É–¥–∞–ª—è–µ–º–æ–π —Ç–æ—á–∫–∏
				if (pointMarkers[pointToRemoveIndex]) {
					map.removeLayer(pointMarkers[pointToRemoveIndex]);
					pointMarkers.splice(pointToRemoveIndex, 1);
				}
				
				// –£–¥–∞–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å —É–¥–∞–ª—è–µ–º–æ–π —Ç–æ—á–∫–∏
				if (routeLabelMarkers[pointToRemoveIndex]) {
					map.removeLayer(routeLabelMarkers[pointToRemoveIndex]);
					routeLabelMarkers.splice(pointToRemoveIndex, 1);
				}
				
				// –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –º–∞—Ä–∫–µ—Ä—ã –∏ –ø–æ–¥–ø–∏—Å–∏
				updateRemainingMarkersAfterUndo(pointToRemoveIndex);
				
				// –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç —Å –æ—Å—Ç–∞–≤—à–∏–º–∏—Å—è —Ç–æ—á–∫–∞–º–∏
				buildFullRoute();
				
				document.getElementById('status').textContent = `–£–¥–∞–ª–µ–Ω–∞ —Ç–æ—á–∫–∞ ${pointToRemoveIndex + 1}. –ú–∞—Ä—à—Ä—É—Ç –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω.`;
				
			} else if (selectedPoints.length === 2) {
				// –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ 2 —Ç–æ—á–∫–∏ (–°—Ç–∞—Ä—Ç –∏ –§–∏–Ω–∏—à), —É–¥–∞–ª—è–µ–º –§–∏–Ω–∏—à
				selectedPoints.pop();
				
				// –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –§–∏–Ω–∏—à–∞
				const lastMarker = pointMarkers.pop();
				if (lastMarker) map.removeLayer(lastMarker);
				
				// –£–¥–∞–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –§–∏–Ω–∏—à–∞
				const lastLabel = routeLabelMarkers.pop();
				if (lastLabel) map.removeLayer(lastLabel);
				
				// –£–¥–∞–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
				if (routeLayer) map.removeLayer(routeLayer);
				routeLayer = null;
				
				routePointMarkers.forEach(marker => map.removeLayer(marker));
				routePointMarkers = [];
				
				// –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É –¥–ª–∏–Ω—ã –º–∞—Ä—à—Ä—É—Ç–∞
				if (routeLengthLabelMarker) {
					map.removeLayer(routeLengthLabelMarker);
					routeLengthLabelMarker = null;
				}
				
				// –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å—å –°—Ç–∞—Ä—Ç–∞ (–µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å)
				if (routeLabelMarkers.length > 1) {
					// –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø–æ–¥–ø–∏—Å–∏, –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π
					for (let i = 1; i < routeLabelMarkers.length; i++) {
						if (routeLabelMarkers[i]) {
							map.removeLayer(routeLabelMarkers[i]);
						}
					}
					routeLabelMarkers = routeLabelMarkers.slice(0, 1);
				}
				
				document.getElementById('status').textContent = '–í—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é.';
				document.getElementById('show-route-points-btn').style.display = 'none';
				document.getElementById('route-points-popup').style.display = 'none';
				
			} else if (selectedPoints.length === 1) {
				// –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ 1 —Ç–æ—á–∫–∞ (–°—Ç–∞—Ä—Ç), —É–¥–∞–ª—è–µ–º –≤—Å—ë
				clearRoute();
				document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞';
			}
			
			updateRouteButtonsVisibility();
		}
		
		// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—Å–µ—Ö —Ç–æ—á–µ–∫
		function clearAllRouteMarkers() {
			// –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞
			pointMarkers.forEach(marker => {
				if (marker && map.hasLayer(marker)) {
					map.removeLayer(marker);
				}
			});
			pointMarkers = [];
			
			// –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø–æ–¥–ø–∏—Å–∏
			routeLabelMarkers.forEach(marker => {
				if (marker && map.hasLayer(marker)) {
					map.removeLayer(marker);
				}
			});
			routeLabelMarkers = [];
			
			// –£–¥–∞–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç
			if (routeLayer && map.hasLayer(routeLayer)) {
				map.removeLayer(routeLayer);
				routeLayer = null;
			}
			
			// –£–¥–∞–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
			routePointMarkers.forEach(marker => {
				if (marker && map.hasLayer(marker)) {
					map.removeLayer(marker);
				}
			});
			routePointMarkers = [];
			
			// –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É –¥–ª–∏–Ω—ã –º–∞—Ä—à—Ä—É—Ç–∞
			if (routeLengthLabelMarker && map.hasLayer(routeLengthLabelMarker)) {
				map.removeLayer(routeLengthLabelMarker);
				routeLengthLabelMarker = null;
			}
		}

		// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
		function updateRemainingMarkersAfterUndo(removedIndex) {
			// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Ç–æ—á–µ–∫
			for (let i = removedIndex; i < routeLabelMarkers.length; i++) {
				if (routeLabelMarkers[i]) {
					map.removeLayer(routeLabelMarkers[i]);
				}
			}
			routeLabelMarkers = routeLabelMarkers.slice(0, removedIndex);
			
			// –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ (–æ–Ω–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω—ã –≤ buildFullRoute)
			routePointMarkers.forEach(marker => {
				if (marker && map.hasLayer(marker)) {
					map.removeLayer(marker);
				}
			});
			routePointMarkers = [];
			
			// –£–¥–∞–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç
			if (routeLayer) {
				map.removeLayer(routeLayer);
				routeLayer = null;
			}
			
			// –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É –¥–ª–∏–Ω—ã –º–∞—Ä—à—Ä—É—Ç–∞
			if (routeLengthLabelMarker) {
				map.removeLayer(routeLengthLabelMarker);
				routeLengthLabelMarker = null;
			}
		}
        
        function updateRouteButtonsVisibility() {
            const clearBtn = document.getElementById('clear-route-btn');
            const showBtn = selectedPoints.length > 0;
            
            clearBtn.style.display = showBtn ? 'block' : 'none';
            
            const isGoogle = currentMapType === 'google-satellite';
            document.getElementById(isGoogle ? 'undo-btn-google' : 'undo-btn').style.display = showBtn ? 'flex' : 'none';
        }
        
        // ==================== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ù–ê–•–û–ñ–î–ï–ù–ò–Ø –ë–õ–ò–ñ–ê–ô–®–ï–ì–û –°–ï–ì–ú–ï–ù–¢–ê –ú–ê–†–®–†–£–¢–ê ====================
        function findNearestRouteSegment(clickCoords, maxDistance = 10) {
            if (fullRoutePath.length < 2) return null;
            
            let nearestSegment = null;
            let minDistance = Infinity;
            let segmentIndex = -1;
            let projectionPoint = null;
            let projectionT = 0;
            
            for (let i = 0; i < fullRoutePath.length - 1; i++) {
                const a = fullRoutePath[i];
                const b = fullRoutePath[i + 1];
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ –¥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
                const distance = pointToSegmentDistance(clickCoords, a, b);
                
                if (distance < minDistance && distance <= maxDistance) {
                    minDistance = distance;
                    segmentIndex = i;
                    
                    // –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫—É –ø—Ä–æ–µ–∫—Ü–∏–∏ –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç
                    const t = getProjectionFactor(clickCoords, a, b);
                    projectionT = Math.max(0, Math.min(1, t));
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–æ–µ–∫—Ü–∏–∏
                    projectionPoint = [
                        a[0] + (b[0] - a[0]) * projectionT,
                        a[1] + (b[1] - a[1]) * projectionT
                    ];
                    
                    nearestSegment = {
                        start: a,
                        end: b,
                        index: i,
                        projection: projectionPoint,
                        t: projectionT,
                        distance: distance
                    };
                }
            }
            
            return nearestSegment;
        }
        
        // ==================== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –í–°–¢–ê–í–ö–ò –¢–û–ß–ö–ò –í –ú–ê–†–®–†–£–¢ ====================
        function insertPointInRoute(segment, clickCoords) {
            if (!segment || selectedPoints.length < 2) return;
            
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π —É–∑–µ–ª –≥—Ä–∞—Ñ–∞ –∫ —Ç–æ—á–∫–µ –∫–ª–∏–∫–∞
            const nearestNode = findNearestGraphNode(clickCoords, 10);
            if (!nearestNode) {
                showCustomAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–∏–π —É–∑–µ–ª –≥—Ä–∞—Ñ–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–ª–∏–∫–Ω—É—Ç—å –±–ª–∏–∂–µ –∫ —Ç–æ–Ω–Ω–µ–ª—è–º.');
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º, –º–µ–∂–¥—É –∫–∞–∫–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Ç–æ—á–∫–∞–º–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —ç—Ç–æ—Ç —Å–µ–≥–º–µ–Ω—Ç
            // –î–ª—è —ç—Ç–æ–≥–æ –∏—â–µ–º —Å–µ–≥–º–µ–Ω—Ç –≤ –ø–æ–ª–Ω–æ–º –ø—É—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–∞
            let startIndexInFullPath = -1;
            let endIndexInFullPath = -1;
            
            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ –ø–æ–ª–Ω–æ–º –ø—É—Ç–∏
            for (let i = 0; i < fullRoutePath.length; i++) {
                const point = fullRoutePath[i];
                if (isSamePoint(point, segment.start, 0.001)) {
                    startIndexInFullPath = i;
                }
                if (isSamePoint(point, segment.end, 0.001)) {
                    endIndexInFullPath = i;
                }
            }
            
            if (startIndexInFullPath === -1 || endIndexInFullPath === -1) {
                showCustomAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ –º–∞—Ä—à—Ä—É—Ç–µ');
                return;
            }
            
            // –¢–µ–ø–µ—Ä—å –Ω–∞—Ö–æ–¥–∏–º, –º–µ–∂–¥—É –∫–∞–∫–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Ç–æ—á–∫–∞–º–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —ç—Ç–æ—Ç —Å–µ–≥–º–µ–Ω—Ç
            let startPointIndex = -1;
            let endPointIndex = -1;
            let insertIndex = -1;
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Ç–æ—á–∫–∞–º –∏ —Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫–∏–µ –∏–∑ –Ω–∏—Ö –Ω–∞—Ö–æ–¥—è—Ç—Å—è –¥–æ –∏ –ø–æ—Å–ª–µ —Å–µ–≥–º–µ–Ω—Ç–∞
            for (let i = 0; i < selectedPoints.length; i++) {
                const pointKey = selectedPoints[i].join(',');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —ç—Ç–∞ —Ç–æ—á–∫–∞ –∫–∞–∫–æ–º—É-–ª–∏–±–æ —É–∑–ª—É –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ –¥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
                for (let j = 0; j <= startIndexInFullPath; j++) {
                    const routePointKey = fullRoutePath[j].join(',');
                    if (pointKey === routePointKey) {
                        startPointIndex = i;
                        break;
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —ç—Ç–∞ —Ç–æ—á–∫–∞ –∫–∞–∫–æ–º—É-–ª–∏–±–æ —É–∑–ª—É –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ –ø–æ—Å–ª–µ —Å–µ–≥–º–µ–Ω—Ç–∞
                for (let j = endIndexInFullPath; j < fullRoutePath.length; j++) {
                    const routePointKey = fullRoutePath[j].join(',');
                    if (pointKey === routePointKey) {
                        if (endPointIndex === -1 || i < endPointIndex) {
                            endPointIndex = i;
                        }
                        break;
                    }
                }
            }
            
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —è–≤–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ –ø–æ—Ä—è–¥–∫—É —Å–µ–≥–º–µ–Ω—Ç–æ–≤
            if (startPointIndex === -1 || endPointIndex === -1) {
                // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–∏–º–µ—Ä–Ω—É—é –ø–æ–∑–∏—Ü–∏—é —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ –º–∞—Ä—à—Ä—É—Ç–µ (–æ—Ç 0 –¥–æ 1)
                const segmentPosition = (startIndexInFullPath + endIndexInFullPath) / 2 / fullRoutePath.length;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –ø–æ—Å–ª–µ –∫–∞–∫–æ–π —Ç–æ—á–∫–∏ –≤—Å—Ç–∞–≤–ª—è—Ç—å –Ω–æ–≤—É—é —Ç–æ—á–∫—É
                insertIndex = Math.floor(segmentPosition * selectedPoints.length);
                insertIndex = Math.max(1, Math.min(selectedPoints.length - 1, insertIndex));
            } else if (endPointIndex > startPointIndex) {
                // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –æ–±–µ —Ç–æ—á–∫–∏ –∏ –æ–Ω–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                insertIndex = endPointIndex;
            } else {
                // –ï—Å–ª–∏ –ø–æ—Ä—è–¥–æ–∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ startPointIndex
                insertIndex = startPointIndex + 1;
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º insertIndex –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –º–∞—Å—Å–∏–≤–∞
            insertIndex = Math.max(1, Math.min(selectedPoints.length - 1, insertIndex));
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Ç–æ—á–∫—É –≤ –º–∞—Å—Å–∏–≤ selectedPoints
            selectedPoints.splice(insertIndex, 0, nearestNode);
            
            // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã
            rebuildPointMarkers();
            
            // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
            buildFullRoute();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const newPointNumber = insertIndex + 1;
            document.getElementById('status').textContent = 
                `–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–æ—á–∫–∞ ${newPointNumber}. –¢–æ—á–∫–∏ —Å –Ω–æ–º–µ—Ä–∞–º–∏ ${newPointNumber + 1} –∏ –¥–∞–ª–µ–µ —Å–º–µ—â–µ–Ω—ã.`;
        }

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–†–ê–í–ù–ï–ù–ò–Ø –¢–û–ß–ï–ö ====================
        function isSamePoint(a, b, tolerance = 0.001) {
            if (!a || !b || !Array.isArray(a) || !Array.isArray(b)) return false;
            if (a.length < 2 || b.length < 2) return false;
            
            return Math.abs(a[0] - b[0]) < tolerance && Math.abs(a[1] - b[1]) < tolerance;
        }
        
        // ==================== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–ï–†–ï–°–¢–†–û–ô–ö–ò –ú–ê–†–ö–ï–†–û–í ====================
        function rebuildPointMarkers() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            pointMarkers.forEach(marker => map.removeLayer(marker));
            pointMarkers = [];
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∏
            routeLabelMarkers.forEach(marker => map.removeLayer(marker));
            routeLabelMarkers = [];
            
            // –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É –¥–ª–∏–Ω—ã –º–∞—Ä—à—Ä—É—Ç–∞
            if (routeLengthLabelMarker) {
                map.removeLayer(routeLengthLabelMarker);
                routeLengthLabelMarker = null;
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –≤—Å–µ—Ö —Ç–æ—á–µ–∫
            selectedPoints.forEach((pt, idx) => {
                const fillColor = idx === 0 ? 'green' : idx === selectedPoints.length - 1 ? 'blue' : 'red';
                const marker = L.circle([pt[1], pt[0]], {
                    radius: 3,
                    color: 'white',
                    fillColor: fillColor,
                    weight: 2,
                    fillOpacity: 1,
                    className: 'route-point-marker route-point-marker-enlarged'
                }).addTo(map);
                pointMarkers.push(marker);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏
            addRoutePointLabels();
        }
        
        function handleMapClick(e) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫
            if (isUserPointsMode) {
                console.log('–ö–ª–∏–∫ –≤ —Ä–µ–∂–∏–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏');
                let coords;
                if (currentMapType === 'google-satellite') {
                    // –î–ª—è Google –∫–∞—Ä—Ç –∏—Å–ø–æ–ª—å–∑—É–µ–º WGS84 –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    coords = wgs84ToEpsg3857(e.latlng.lat, e.latlng.lng);
                } else {
                    coords = [e.latlng.lng, e.latlng.lat];
                }
                pendingPointCoords = coords;
                showAddPointPopup();
                return;
            }
            
            if (menuOpen || segments.length === 0 || routeLocked) return;
            
            // –ù–∞ Google –∫–∞—Ä—Ç–∞—Ö –Ω–µ —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç—ã
            if (currentMapType === 'google-satellite') {
                return;
            }
            
            const click = [e.latlng.lng, e.latlng.lat];
            
            // –ï—Å–ª–∏ —É–∂–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω –º–∞—Ä—à—Ä—É—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫ –ø–æ —Å–µ–≥–º–µ–Ω—Ç—É –º–∞—Ä—à—Ä—É—Ç–∞
            if (fullRoutePath.length > 1) {
                const nearestSegment = findNearestRouteSegment(click, 5);
                
                if (nearestSegment && nearestSegment.distance <= 5) {
                    // –ö–ª–∏–∫ –ø–æ —Å–µ–≥–º–µ–Ω—Ç—É –º–∞—Ä—à—Ä—É—Ç–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Ç–æ—á–∫—É
                    insertPointInRoute(nearestSegment, click);
                    return;
                }
            }
            
            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
            // –£–í–ï–õ–ò–ß–ï–ù–ù–´–ô –¢–û–õ–ï–†–ê–ù–° –î–õ–Ø –õ–£–ß–®–ï–ô –ö–õ–ò–ö–ê–ë–ï–õ–¨–ù–û–°–¢–ò
            const TOLERANCE = 8; // –£–≤–µ–ª–∏—á–µ–Ω —Å 4 –¥–æ 8
            
            let nearest = null;
            let minDist = Infinity;
            
            for (const node in graph) {
                const [x, y] = node.split(',').map(Number);
                const d = Math.hypot(x - click[0], y - click[1]);
                if (d < minDist) {
                    minDist = d;
                    nearest = [x, y];
                }
            }
            
            if (!nearest || minDist > TOLERANCE) {
                document.getElementById('status').textContent = '–ö–ª–∏–∫ —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –æ—Ç —Ç–æ–Ω–Ω–µ–ª–µ–π';
                return;
            }

            selectedPoints.push(nearest);
            const pointNumber = selectedPoints.length;
            
            const marker = L.circle([nearest[1], nearest[0]], {
                radius: 3,
                color: 'white',
                fillColor: pointNumber === 1 ? 'green' : pointNumber === selectedPoints.length ? 'blue' : 'red',
                weight: 2,
                fillOpacity: 1,
                className: 'route-point-marker route-point-marker-enlarged'
            }).addTo(map);
            
            pointMarkers.push(marker);
            
            if (selectedPoints.length === 1) {
                document.getElementById('status').textContent = '–í—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é.';
            } else {
                buildFullRoute();
            }
            
            document.getElementById('clear-route-btn').style.display = 'block';
            updateRouteButtonsVisibility();
        }
        
        function handleEditModeClick(e) {
            console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            
            // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –º–µ—Ç–∫—É
            let minDist = Infinity;
            let nearestIndex = -1;
            
            userPointMarkers.forEach((marker, index) => {
                const markerLatLng = marker.getLatLng();
                const dist = e.latlng.distanceTo(markerLatLng);
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–¥–∏—É—Å –∫–ª–∏–∫–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ (100 –ø–∏–∫—Å–µ–ª–µ–π)
                if (dist < minDist && dist < 100) {
                    minDist = dist;
                    nearestIndex = index;
                }
            });
            
            if (nearestIndex !== -1) {
                console.log('–ù–∞–π–¥–µ–Ω–∞ –º–µ—Ç–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', nearestIndex);
                selectPointForEditing(nearestIndex);
                showEditPointPopup(nearestIndex);
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
                if (e.originalEvent) {
                    e.originalEvent.stopPropagation();
                    e.originalEvent.preventDefault();
                }
            }
        }
        
        function updateRoutePointStyles() {
            pointMarkers.forEach((m, idx) => {
                let fillColor;
                if (idx === 0) fillColor = 'green';
                else if (idx === pointMarkers.length - 1) fillColor = 'blue';
                else fillColor = 'red';
                m.setStyle({ 
                    color: 'white',
                    fillColor: fillColor,
                    weight: 2,
                    className: 'route-point-marker route-point-marker-enlarged'
                });
            });
            
            if (selectedPoints.length > 1) buildFullRoute();
        }
        
        function onZoomEnd() {
            updateZoomDisplay();
            updateLabelVisibility();
        }
        
        // ==================== –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–Ø –¢–û–ß–ï–ö ====================
        function setupDragAndDropForRoutePoints() {
            // –°–Ω–∏–º–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            pointMarkers.forEach((marker, index) => {
                marker.off('mousedown');
                marker.off('mouseup');
                marker.off('mousemove');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä "—Ä—É–∫–∞" –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
                const element = marker.getElement();
                if (element) element.style.cursor = 'grab';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                marker.on('mousedown', function(e) {
                    startDraggingPoint(index, e);
                });
            });
        }
        
        function startDraggingPoint(index, e) {
            if (routeLocked || currentMapType === 'google-satellite') return;
            
            isDraggingPoint = true;
            draggedPointIndex = index;
            dragStartPoint = [e.latlng.lng, e.latlng.lat];
            originalPointPosition = [...selectedPoints[index]];
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–π –æ—Ç–º–µ–Ω—ã
            saveUndoState();
            
            // –ò–∑–º–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä –Ω–∞ "–∑–∞—Ö–≤–∞—Ç" (–∫—É–ª–∞–∫)
            document.getElementById('map').style.cursor = 'grabbing';
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—É—é —Ç–æ—á–∫—É
            pointMarkers[index].setStyle({
                color: '#FF9800',
                fillColor: '#FF9800',
                weight: 3
            });
            
            // –°–æ–∑–¥–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª—è—é—â—É—é –ª–∏–Ω–∏—é
            if (!dragGuideLine) {
                dragGuideLine = L.polyline([], {
                    color: '#FF9800',
                    weight: 2,
                    dashArray: '5, 5',
                    className: 'drag-guide-line'
                }).addTo(map);
            }
            
            // –°–æ–∑–¥–∞–µ–º –∫—Ä—É–≥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±–ª–∞—Å—Ç–∏ –ø—Ä–∏–≤—è–∑–∫–∏
            if (!dragTargetCircle) {
                dragTargetCircle = L.circle([e.latlng.lat, e.latlng.lng], {
                    radius: 5,
                    color: '#4CAF50',
                    fillColor: 'rgba(76, 175, 80, 0.2)',
                    weight: 3,
                    className: 'drag-target-circle'
                }).addTo(map);
            }
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä –¥–ª—è –±–ª–∏–∂–∞–π—à–µ–≥–æ —É–∑–ª–∞
            if (!nearestNodeMarker) {
                nearestNodeMarker = L.circle([e.latlng.lat, e.latlng.lng], {
                    radius: 3,
                    color: '#2196F3',
                    fillColor: 'rgba(33, 150, 243, 0.3)',
                    weight: 2,
                    className: 'nearest-node-marker'
                }).addTo(map);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∫–∞—Ä—Ç—ã –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            map.dragging.disable();
            
            document.getElementById('status').textContent = `–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ ${index + 1}. –û—Ç–ø—É—Å—Ç–∏—Ç–µ –∫–Ω–æ–ø–∫—É –º—ã—à–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è.`;
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
            e.originalEvent.stopPropagation();
        }
        
        function handleMouseMove(e) {
            if (!isDraggingPoint) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—É—Ä—Å–æ—Ä–∞
            const point = map.containerPointToLatLng(L.point(e.clientX, e.clientY));
            const mouseCoords = [point.lng, point.lat];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ç–æ—á–∫–∏-–º–∞—Ä–∫–µ—Ä–∞
            pointMarkers[draggedPointIndex].setLatLng([point.lat, point.lng]);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏
            if (routeLabelMarkers[draggedPointIndex]) {
                routeLabelMarkers[draggedPointIndex].setLatLng([point.lat, point.lng]);
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π —É–∑–µ–ª –≥—Ä–∞—Ñ–∞
            const nearestNode = findNearestGraphNode(mouseCoords, 15); // –£–≤–µ–ª–∏—á–µ–Ω —Ä–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞
            
            if (nearestNode) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª—è—é—â—É—é –ª–∏–Ω–∏—é
                dragGuideLine.setLatLngs([
                    [point.lat, point.lng],
                    [nearestNode[1], nearestNode[0]]
                ]);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä—É–≥ –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è
                dragTargetCircle.setLatLng([nearestNode[1], nearestNode[0]]);
                dragTargetCircle.setRadius(calculateDragRadius());
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –±–ª–∏–∂–∞–π—à–µ–≥–æ —É–∑–ª–∞
                nearestNodeMarker.setLatLng([nearestNode[1], nearestNode[0]]);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±–ª–∏–∂–∞–π—à–µ–≥–æ —É–∑–ª–∞ –≤ —Å—Ç–∞—Ç—É—Å–µ
                document.getElementById('status').textContent = 
                    `–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ ${draggedPointIndex + 1}. –ë–ª–∏–∂–∞–π—à–∏–π —É–∑–µ–ª: ${nearestNode[0].toFixed(1)}, ${nearestNode[1].toFixed(1)}`;
            } else {
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —É–∑–µ–ª, —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                if (dragGuideLine) dragGuideLine.setLatLngs([]);
                if (dragTargetCircle) dragTargetCircle.setRadius(0);
                if (nearestNodeMarker) nearestNodeMarker.setRadius(0);
                
                document.getElementById('status').textContent = 
                    `–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ ${draggedPointIndex + 1}. –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–∑–ª–æ–≤ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏.`;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä
            document.getElementById('map').style.cursor = 'grabbing';
        }
        
        function handleMouseUp(e) {
            if (!isDraggingPoint) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—É—Ä—Å–æ—Ä–∞
            const point = map.containerPointToLatLng(L.point(e.clientX, e.clientY));
            const mouseCoords = [point.lng, point.lat];
            
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π —É–∑–µ–ª –≥—Ä–∞—Ñ–∞
            const nearestNode = findNearestGraphNode(mouseCoords, 15); // –£–≤–µ–ª–∏—á–µ–Ω —Ä–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞
            
            if (nearestNode) {
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Ç–æ—á–∫—É –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π —É–∑–µ–ª
                selectedPoints[draggedPointIndex] = nearestNode;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
                pointMarkers[draggedPointIndex].setLatLng([nearestNode[1], nearestNode[0]]);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å
                if (routeLabelMarkers[draggedPointIndex]) {
                    routeLabelMarkers[draggedPointIndex].setLatLng([nearestNode[1], nearestNode[0]]);
                }
                
                // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
                buildFullRoute();
                
                document.getElementById('status').textContent = 
                    `–¢–æ—á–∫–∞ ${draggedPointIndex + 1} –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞. –ú–∞—Ä—à—Ä—É—Ç –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω.`;
            } else {
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —É–∑–µ–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ—á–∫—É –Ω–∞ –∏—Å—Ö–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
                selectedPoints[draggedPointIndex] = originalPointPosition;
                pointMarkers[draggedPointIndex].setLatLng([originalPointPosition[1], originalPointPosition[0]]);
                
                if (routeLabelMarkers[draggedPointIndex]) {
                    routeLabelMarkers[draggedPointIndex].setLatLng([originalPointPosition[1], originalPointPosition[0]]);
                }
                
                document.getElementById('status').textContent = 
                    `–¢–æ—á–∫–∞ ${draggedPointIndex + 1} –Ω–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞. –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–∑–ª–æ–≤ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏.`;
            }
            
            // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
            finishDragging();
        }
        
        function findNearestGraphNode(coords, maxDistance = 15) { // –£–≤–µ–ª–∏—á–µ–Ω –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–¥–∏—É—Å
            let nearest = null;
            let minDist = Infinity;
            
            for (const node in graph) {
                const [x, y] = node.split(',').map(Number);
                const d = Math.hypot(x - coords[0], y - coords[1]);
                
                if (d < minDist && d <= maxDistance) {
                    minDist = d;
                    nearest = [x, y];
                }
            }
            
            return nearest;
        }
        
        function calculateDragRadius() {
            // –†–∞–¥–∏—É—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∑—É–º–∞
            const zoom = map.getZoom();
            return Math.max(3, 15 - zoom); // –ë–æ–ª—å—à–µ –∑—É–º - –º–µ–Ω—å—à–µ —Ä–∞–¥–∏—É—Å
        }
        
        function finishDragging() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            isDraggingPoint = false;
            draggedPointIndex = -1;
            dragStartPoint = null;
            originalPointPosition = null;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä
            document.getElementById('map').style.cursor = '';
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            if (dragGuideLine) {
                map.removeLayer(dragGuideLine);
                dragGuideLine = null;
            }
            
            if (dragTargetCircle) {
                map.removeLayer(dragTargetCircle);
                dragTargetCircle = null;
            }
            
            if (nearestNodeMarker) {
                map.removeLayer(nearestNodeMarker);
                nearestNodeMarker = null;
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª—å —Ç–æ—á–∫–∏
            if (draggedPointIndex >= 0 && pointMarkers[draggedPointIndex]) {
                updatePointMarkerStyle(draggedPointIndex);
            }
            
            // –£–¥–∞–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
            
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –∫–∞—Ä—Ç—ã
            map.dragging.enable();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
            setupDragAndDropForRoutePoints();
        }
        
        function saveUndoState() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–π –æ—Ç–º–µ–Ω—ã
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Å—Ç–µ–∫ –æ—Ç–º–µ–Ω—ã
            console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è –æ—Ç–º–µ–Ω—ã');
        }
        
        // ==================== –°–õ–û–ô –ö–ü 2025 ====================
        async function toggleKPLayer() {
            const isGoogle = currentMapType === 'google-satellite';
            const btn = document.getElementById(isGoogle ? 'kp-layer-btn-google' : 'kp-layer-btn');
            
            if (!kpLayerVisible) {
                showLoadingOverlay("–ó–∞–≥—Ä—É–∑–∫–∞ –ö–ü 2025...");
                
                try {
                    const data = await loadGeoJsonFile('kp_2025.geojson');
                    
                    if (kpLayer) map.removeLayer(kpLayer);
                    kpLayer = L.layerGroup();
                    
                    data.features.forEach(feature => {
                        if (feature.geometry.type !== 'Point') return;
                        const coords = feature.geometry.coordinates;
                        const name = feature.properties?.Name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                        const type = feature.properties?.type || 'point';
                        
                        if (!coords || coords.length < 2) return;
                        
                        let latlng;
                        if (currentMapType === 'google-satellite') {
                            latlng = epsg3857ToWgs84(coords[0], coords[1]);
                        } else {
                            latlng = [coords[1], coords[0]];
                        }
                        
                        const markerColor = type === '—Ç–µ—Ö. —ç—Ç–∞–ø' ? '#ff0000' : '#00ff00';
                        const labelClass = type === '—Ç–µ—Ö. —ç—Ç–∞–ø' ? 'kp-label-tech' : 'kp-label-point';
                        
                        const marker = L.circleMarker(latlng, {
                            radius: 4,
                            color: markerColor,
                            fillColor: markerColor,
                            fillOpacity: 0.7,
                            weight: 1
                        }).bindPopup(`<b>${name}</b><br>–¢–∏–ø: ${type}`);
                        
                        const label = L.marker(latlng, {
                            icon: L.divIcon({
                                className: labelClass,
                                html: name.length > 15 ? name.substring(0, 12) + '...' : name,
                                iconSize: null,
                                iconAnchor: [0, -8]
                            }),
                            interactive: false
                        });
                        
                        marker.addTo(kpLayer);
                        label.addTo(kpLayer);
                    });
                    
                    kpLayer.addTo(map);
                    kpLayerVisible = true;
                    btn.classList.add('layer-active');
                    
                    updateMarkersVisibilityForCurrentMap();
                    document.getElementById('status').textContent = `–°–ª–æ–π –ö–ü 2025 –∑–∞–≥—Ä—É–∂–µ–Ω: ${data.features.length} —Ç–æ—á–µ–∫`;
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ö–ü:', error);
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—è –ö–ü 2025');
                }
                
                hideLoadingOverlay();
            } else {
                if (kpLayer) map.removeLayer(kpLayer);
                kpLayer = null;
                kpLayerVisible = false;
                btn.classList.remove('layer-active');
                document.getElementById('status').textContent = '–°–ª–æ–π –ö–ü 2025 —Å–∫—Ä—ã—Ç';
            }
        }
        
        // ==================== –°–õ–û–ô –í–°–ï–• –ú–ï–¢–û–ö –ò –†–ï–ë–ï–† ====================
        async function toggleAllEdgesLayer() {
            const isGoogle = currentMapType === 'google-satellite';
            const btn = document.getElementById('all-edges-btn');
            
            if (!allEdgesLayerVisible) {
                showLoadingOverlay("–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –∏ —Ä–µ–±–µ—Ä...");
                
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ—á–∫–∏
                    const pointsData = await loadGeoJsonFile('points_json.geojson');
                    const tunnelsData = await loadGeoJsonFile('tunnels_json.geojson');
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª–æ–π, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (allEdgesLayer) map.removeLayer(allEdgesLayer);
                    allEdgesLayer = L.layerGroup();
                    
                    let edgeCount = 0;
                    let pointCount = 0;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–∞ (—Ç—É–Ω–Ω–µ–ª–∏)
                    tunnelsData.features.forEach(f => {
                        if (!f.geometry) return;
                        
                        let lines = [];
                        if (f.geometry.type === 'LineString') lines = [f.geometry.coordinates];
                        else if (f.geometry.type === 'MultiLineString') lines = f.geometry.coordinates;
                        else return;
                        
                        let weight = f.properties?.weight || 5;
                        
                        lines.forEach(coords => {
                            if (!Array.isArray(coords) || coords.length < 2) return;
                            
                            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è Google Maps
                            const latlngs = [];
                            for (let i = 0; i < coords.length; i++) {
                                const pt = coords[i];
                                if (!Array.isArray(pt) || pt.length < 2) continue;
                                
                                let latlng;
                                if (currentMapType === 'google-satellite') {
                                    latlng = epsg3857ToWgs84(pt[0], pt[1]);
                                } else {
                                    latlng = [pt[1], pt[0]];
                                }
                                latlngs.push(latlng);
                            }
                            
                            if (latlngs.length < 2) return;
                            
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Å–∞
                            let color;
                            switch(weight) {
                                case 1: color = '#000000'; break; // –ó–∞–≤–∞–ª
                                case 2: color = '#ff0000'; break; // –®–∫—É—Ä–æ–¥–µ—Ä
                                case 3: color = '#ffa500'; break; // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ
                                case 4: color = '#0000ff'; break; // –í–æ–¥–∞
                                default: color = '#00ff00'; // –°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥
                            }
                            
                            // –°–æ–∑–¥–∞–µ–º –ª–∏–Ω–∏—é
                            const polyline = L.polyline(latlngs, {
                                color: color,
                                weight: 3,
                                opacity: 0.7
                            }).addTo(allEdgesLayer);
                            edgeCount++;
                        });
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫–∏
                    pointsData.features.forEach(feature => {
                        if (feature.geometry.type !== 'Point') return;
                        const coords = feature.geometry.coordinates;
                        const name = feature.properties?.Name || '';
                        
                        if (!coords || coords.length < 2 || !name) return;
                        
                        let latlng;
                        if (currentMapType === 'google-satellite') {
                            latlng = epsg3857ToWgs84(coords[0], coords[1]);
                        } else {
                            latlng = [coords[1], coords[0]];
                        }
                        
                        const marker = L.circleMarker(latlng, {
                            radius: 4,
                            color: '#5D4037',
                            fillColor: 'white',
                            weight: 1,
                            fillOpacity: 1
                        }).bindPopup(`<b>${name}</b>`);
                        
                        const label = L.marker(latlng, {
                            icon: L.divIcon({
                                className: 'point-label-from-json',
                                html: name.length > 15 ? name.substring(0, 12) + '...' : name,
                                iconSize: null,
                                iconAnchor: [0, -8]
                            }),
                            interactive: false
                        });
                        
                        marker.addTo(allEdgesLayer);
                        label.addTo(allEdgesLayer);
                        pointCount++;
                    });
                    
                    allEdgesLayer.addTo(map);
                    allEdgesLayerVisible = true;
                    btn.classList.add('layer-active');
                    
                    updateMarkersVisibilityForCurrentMap();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–µ–≥–µ–Ω–¥—É
                    const legendHtml = `
                        <div class="tunnel-legend">
                            <div class="tunnel-legend-title">–õ–µ–≥–µ–Ω–¥–∞ –ø—Ä–æ—Ö–æ–¥–∏–º–æ—Å—Ç–∏:</div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #00ff00;"></div>
                                <span>–°–≤–æ–±–æ–¥–Ω—ã–π –ø—Ä–æ—Ö–æ–¥</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #ffa500;"></div>
                                <span>–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #ff0000;"></div>
                                <span>–®–∫—É—Ä–æ–¥–µ—Ä</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #0000ff;"></div>
                                <span>–í–æ–¥–∞</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #000000;"></div>
                                <span>–ó–∞–≤–∞–ª</span>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('status').innerHTML = 
                        `–°–ª–æ–π –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –∏ —Ä–µ–±–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω: ${pointCount} —Ç–æ—á–µ–∫ –∏ ${edgeCount} —Ä–µ–±–µ—Ä. ${legendHtml}`;
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –∏ —Ä–µ–±–µ—Ä:', error);
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—è –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –∏ —Ä–µ–±–µ—Ä');
                }
                
                hideLoadingOverlay();
            } else {
                if (allEdgesLayer) map.removeLayer(allEdgesLayer);
                allEdgesLayer = null;
                allEdgesLayerVisible = false;
                btn.classList.remove('layer-active');
                document.getElementById('status').textContent = '–°–ª–æ–π –≤—Å–µ—Ö –º–µ—Ç–æ–∫ –∏ —Ä–µ–±–µ—Ä —Å–∫—Ä—ã—Ç';
            }
        }
        
        // ==================== –°–õ–û–ô –û–ü–ê–°–ù–´–• –ú–ï–°–¢ ====================
        async function toggleDangerLayer() {
            const isGoogle = currentMapType === 'google-satellite';
            const btn = document.getElementById(isGoogle ? 'danger-layer-btn-google' : 'danger-layer-btn');
            
            if (!dangerLayerVisible) {
                showLoadingOverlay("–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç...");
                
                try {
                    const data = await loadGeoJsonFile('danger_points.geojson');
                    
                    if (dangerLayer) map.removeLayer(dangerLayer);
                    dangerLayer = L.layerGroup();
                    
                    data.features.forEach(feature => {
                        if (feature.geometry.type !== 'Point') return;
                        const coords = feature.geometry.coordinates;
                        const name = feature.properties?.Name || '–û–ø–∞—Å–Ω–æ–µ –º–µ—Å—Ç–æ';
                        const description = feature.properties?.description || '';
                        
                        if (!coords || coords.length < 2) return;
                        
                        let latlng;
                        if (currentMapType === 'google-satellite') {
                            latlng = epsg3857ToWgs84(coords[0], coords[1]);
                        } else {
                            latlng = [coords[1], coords[0]];
                        }
                        
                        const marker = L.marker(latlng, {
                            icon: L.divIcon({
                                className: 'danger-marker',
                                html: '<span style="font-size: 24px">üö∑</span>',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        }).bindPopup(`<b>${name}</b>${description ? '<br>' + description : ''}`);
                        
                        const label = L.marker(latlng, {
                            icon: L.divIcon({
                                className: 'danger-point-label',
                                html: name.length > 15 ? name.substring(0, 12) + '...' : name,
                                iconSize: null,
                                iconAnchor: [0, -15]
                            }),
                            interactive: false
                        });
                        
                        marker.addTo(dangerLayer);
                        label.addTo(dangerLayer);
                    });
                    
                    dangerLayer.addTo(map);
                    dangerLayerVisible = true;
                    btn.classList.add('layer-active');
                    
                    updateMarkersVisibilityForCurrentMap();
                    document.getElementById('status').textContent = `–°–ª–æ–π –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω: ${data.features.length} —Ç–æ—á–µ–∫`;
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç:', error);
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—è –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç');
                }
                
                hideLoadingOverlay();
            } else {
                if (dangerLayer) map.removeLayer(dangerLayer);
                dangerLayer = null;
                dangerLayerVisible = false;
                btn.classList.remove('layer-active');
                document.getElementById('status').textContent = '–°–ª–æ–π –æ–ø–∞—Å–Ω—ã—Ö –º–µ—Å—Ç —Å–∫—Ä—ã—Ç';
            }
        }
        
        // ==================== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ï –ú–ï–¢–ö–ò ====================
        function loadUserPoints() {
            const saved = localStorage.getItem('userPoints');
            if (saved) {
                try {
                    userPointsData = JSON.parse(saved);
                } catch (e) {
                    userPointsData = { type: "FeatureCollection", features: [] };
                }
            }
            return userPointsData;
        }
        
        function saveUserPoints() {
            localStorage.setItem('userPoints', JSON.stringify(userPointsData));
        }
        
        // ==================== –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –†–ï–ñ–ò–ú–ê –ú–ï–¢–û–ö ====================
        function toggleUserPointsLayer() {
            const btn = document.getElementById('points-layer-btn');
            const userPointsPanel = document.getElementById('user-points-panel');
            
            if (!userPointsLayerVisible) {
                // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫
                userPointsLayerVisible = true;
                isUserPointsMode = false;
                isEditMode = false;
                selectedPointIndex = null;
                btn.classList.add('active');
                
                // –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –§–õ–ê–ì –ß–¢–û –û–ö–ù–û –ù–ï –î–û–õ–ñ–ù–û –ó–ê–ö–†–´–í–ê–¢–¨–°–Ø –ü–†–ò –°–î–í–ò–ì–ï –ö–ê–†–¢–´
                userPointsPanelFixed = true;
                userPointsPanel.classList.add('user-points-panel-fixed');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ —Å –º–µ—Ç–∫–∞–º–∏
                userPointsPanel.style.display = 'block';
                
                // –û–¢–ö–õ–Æ–ß–ê–ï–ú –í–û–ó–ú–û–ñ–ù–û–°–¢–¨ –ü–û–°–¢–†–û–ï–ù–ò–Ø –ú–ê–†–®–†–£–¢–ê
                map.off('click', handleMapClick);
                document.getElementById('lock-btn').disabled = true;
                document.getElementById('lock-btn-google').disabled = true;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–∫
                const addPointBtn = document.getElementById('add-point-btn');
                const editBtn = document.getElementById('edit-points-btn');
                addPointBtn.classList.remove('active');
                editBtn.classList.remove('active');
                document.getElementById('map').classList.remove('add-point-cursor');
                
                // –ü–û–ö–ê–ó–´–í–ê–ï–ú –≤—Å–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                document.getElementById('add-point-btn').style.display = 'flex';
                document.getElementById('edit-points-btn').style.display = 'flex';
                document.getElementById('delete-point-btn').style.display = 'none';
                document.getElementById('delete-all-points-btn').style.display = 'flex';
                document.getElementById('points-controls-expanded').classList.add('active');
                
                loadUserPoints();
                displayUserPoints();
                
                document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
                
            } else {
                // –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫
                userPointsLayerVisible = false;
                isUserPointsMode = false;
                isEditMode = false;
                selectedPointIndex = null;
                btn.classList.remove('active');
                
                // –°–ù–ò–ú–ê–ï–ú –§–õ–ê–ì –§–ò–ö–°–ê–¶–ò–ò
                userPointsPanelFixed = false;
                userPointsPanel.classList.remove('user-points-panel-fixed');
                
                // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —Å –º–µ—Ç–∫–∞–º–∏
                userPointsPanel.style.display = 'none';
                
                // –í–ö–õ–Æ–ß–ê–ï–ú –í–û–ó–ú–û–ñ–ù–û–°–¢–¨ –ü–û–°–¢–†–û–ï–ù–ò–Ø –ú–ê–†–®–†–£–¢–ê (–µ—Å–ª–∏ –Ω–µ Google –∫–∞—Ä—Ç—ã –∏ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ)
                if (currentMapType !== 'google-satellite' && !routeLocked) {
                    map.on('click', handleMapClick);
                    document.getElementById('lock-btn').disabled = false;
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–∫
                const addPointBtn = document.getElementById('add-point-btn');
                const editBtn = document.getElementById('edit-points-btn');
                addPointBtn.classList.remove('active');
                editBtn.classList.remove('active');
                document.getElementById('map').classList.remove('add-point-cursor');
                
                // –°–ö–†–´–í–ê–ï–ú –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                document.getElementById('add-point-btn').style.display = 'none';
                document.getElementById('edit-points-btn').style.display = 'none';
                document.getElementById('delete-point-btn').style.display = 'none';
                document.getElementById('delete-all-points-btn').style.display = 'none';
                document.getElementById('points-controls-expanded').classList.remove('active');
                
                if (userPointsLayer) {
                    map.removeLayer(userPointsLayer);
                    userPointsLayer = null;
                    userPointMarkers = [];
                    userPointLabels = [];
                }
                
                document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞';
            }
        }
        
        // ==================== –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ê–ö–¢–ò–í–ê–¶–ò–ò –†–ï–ñ–ò–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ú–ï–¢–û–ö ====================
        function startAddPointMode() {
            console.log('–ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏');
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
            isUserPointsMode = !isUserPointsMode;
            
            const addPointBtn = document.getElementById('add-point-btn');
            
            if (isUserPointsMode) {
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º
                addPointBtn.classList.add('active');
                document.getElementById('map').classList.add('add-point-cursor');
                document.getElementById('status').textContent = '–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏ (–∫—É—Ä—Å–æ—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∏–µ)';
                
                // –î–ï–õ–ê–ï–ú –ö–õ–ò–ö–ò –ü–û –ö–ê–†–¢–ï –î–û–°–¢–£–ü–ù–´–ú–ò –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ú–ï–¢–û–ö
                // –°–Ω–∏–º–∞–µ–º –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ (–µ—Å–ª–∏ –±—ã–ª–∏)
                map.off('click', handleMapClick);
                
                // –í–∫–ª—é—á–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–ª–∏–∫–æ–≤ –ø–æ –∫–∞—Ä—Ç–µ –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ
                map.on('click', handleMapClick);
                
            } else {
                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º
                addPointBtn.classList.remove('active');
                document.getElementById('map').classList.remove('add-point-cursor');
                document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
                
                // –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –°–¢–ê–ù–î–ê–†–¢–ù–´–ô –†–ï–ñ–ò–ú –ö–õ–ò–ö–û–í
                // –°–Ω–∏–º–∞–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                map.off('click', handleMapClick);
                
                // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –º–µ—Ç–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω –∏ –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –≤–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                if (userPointsLayerVisible && !routeLocked && currentMapType !== 'google-satellite') {
                    map.on('click', handleMapClick);
                }
            }
        }
        
        // ==================== –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –†–ï–ñ–ò–ú–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ====================
        function startEditMode() {
            console.log('–ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            isEditMode = !isEditMode;
            
            const editBtn = document.getElementById('edit-points-btn');
            
            if (isEditMode) {
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                editBtn.classList.add('active');
                document.getElementById('map').classList.add('add-point-cursor');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫ (–µ—Å–ª–∏ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω)
                const addPointBtn = document.getElementById('add-point-btn');
                addPointBtn.classList.remove('active');
                isUserPointsMode = false;
                
                // –ù–ï –°–ö–†–´–í–ê–ï–ú –¥—Ä—É–≥–∏–µ –∫–Ω–æ–ø–∫–∏! –í—Å–µ –∫–Ω–æ–ø–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏
                // –í—Å–µ –∫–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ —Å–≤–æ–µ–º —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                document.getElementById('delete-point-btn').style.display = 'none'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –º–µ—Ç–∫–∏
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
                updateMarkersForEditMode();
                
                document.getElementById('status').textContent = '–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–∫: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –º–µ—Ç–∫—É –¥–ª—è –≤—ã–±–æ—Ä–∞ (–∫—É—Ä—Å–æ—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∏–µ)';
            } else {
                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                editBtn.classList.remove('active');
                document.getElementById('map').classList.remove('add-point-cursor');
                
                // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –º–µ—Ç–∫–∏
                if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                    const markerElement = userPointMarkers[selectedPointIndex].getElement();
                    if (markerElement) {
                        markerElement.classList.remove('selected');
                    }
                }
                selectedPointIndex = null;
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–µ—Ç–∫–∏
                document.getElementById('delete-point-btn').style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
                updateMarkersForEditMode();
                
                document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
            }
        }
        
        function displayUserPoints() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª–æ–∏
            if (userPointsLayer) {
                map.removeLayer(userPointsLayer);
            }
            userPointMarkers = [];
            userPointLabels = [];
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–ª–æ–π
            userPointsLayer = L.layerGroup();
            
            userPointsData.features.forEach((feature, index) => {
                if (feature.geometry.type !== 'Point') return;
                const coords = feature.geometry.coordinates;
                const name = feature.properties?.name || `–ú–µ—Ç–∫–∞ ${index + 1}`;
                const comment = feature.properties?.comment || '';
                
                if (!coords || coords.length < 2) return;
                
                let latlng;
                if (currentMapType === 'google-satellite') {
                    latlng = epsg3857ToWgs84(coords[0], coords[1]);
                } else {
                    latlng = [coords[1], coords[0]];
                }
                
                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
                const marker = L.circleMarker(latlng, {
                    radius: 8,
                    color: '#8B008B',
                    fillColor: '#FFB6C1',
                    weight: 2,
                    fillOpacity: 0.9,
                    className: 'user-point-marker'
                }).bindPopup(`<b>${name}</b>${comment ? '<br>' + comment : ''}<br><small><i>ID: ${index + 1}</i></small>`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                marker.on('click', function(e) {
                    console.log('–ö–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É –º–µ—Ç–∫–∏:', index);
                    if (isEditMode) {
                        console.log('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω, –≤—ã–±–∏—Ä–∞–µ–º –º–µ—Ç–∫—É');
                        e.originalEvent.stopPropagation();
                        e.originalEvent.preventDefault();
                        selectPointForEditing(index);
                        showEditPointPopup(index);
                        return false;
                    }
                });
                
                // –ü–æ–¥–ø–∏—Å—å
                const label = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'user-point-label',
                        html: name.length > 15 ? name.substring(0, 12) + '...' : name,
                        iconSize: null,
                        iconAnchor: [0, -15]
                    }),
                    interactive: false
                });
                
                marker.addTo(userPointsLayer);
                label.addTo(userPointsLayer);
                userPointMarkers.push(marker);
                userPointLabels.push(label);
            });
            
            userPointsLayer.addTo(map);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
            if (isEditMode) {
                updateMarkersForEditMode();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–µ—Ç–æ–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç—ã
            updateMarkersVisibilityForCurrentMap();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–µ—Ç–æ–∫ –≤ –æ–∫–Ω–µ
            updateUserPointsList();
        }
        
        function updateMarkersForEditMode() {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –º–∞—Ä–∫–µ—Ä–æ–≤, —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', isEditMode);
            
            userPointMarkers.forEach((marker, index) => {
                const element = marker.getElement();
                if (element) {
                    if (isEditMode) {
                        element.classList.add('editing');
                        if (index === selectedPointIndex) {
                            element.classList.add('selected');
                        } else {
                            element.classList.remove('selected');
                        }
                    } else {
                        element.classList.remove('editing');
                        element.classList.remove('selected');
                    }
                }
            });
        }
        
        function selectPointForEditing(index) {
            console.log('–í—ã–±–æ—Ä –º–µ—Ç–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', index);
            
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –º–µ—Ç–∫–∏
            if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                const prevMarkerElement = userPointMarkers[selectedPointIndex].getElement();
                if (prevMarkerElement) {
                    prevMarkerElement.classList.remove('selected');
                }
            }
            
            // –í—ã–¥–µ–ª—è–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É
            selectedPointIndex = index;
            if (userPointMarkers[index]) {
                const markerElement = userPointMarkers[index].getElement();
                if (markerElement) {
                    markerElement.classList.add('selected');
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–µ—Ç–∫–∏
            document.getElementById('delete-point-btn').style.display = 'flex';
        }
        
        function showAddPointPopup() {
            document.getElementById('add-point-overlay').style.display = 'block';
            document.getElementById('add-point-popup').style.display = 'block';
            document.getElementById('point-name').focus();
        }
        
        function hideAddPointPopup() {
            document.getElementById('add-point-overlay').style.display = 'none';
            document.getElementById('add-point-popup').style.display = 'none';
            document.getElementById('point-name').value = '';
            document.getElementById('point-comment').value = '';
            pendingPointCoords = null;
            
            // –ù–ï –°–ë–†–ê–°–´–í–ê–ï–ú –†–ï–ñ–ò–ú –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ú–ï–¢–û–ö - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ –º–µ—Ç–∫–∏
            // isUserPointsMode –æ—Å—Ç–∞–µ—Ç—Å—è true
            document.getElementById('status').textContent = '–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π –º–µ—Ç–∫–∏ (–∫—É—Ä—Å–æ—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∏–µ)';
        }
        
        function showEditPointPopup(index) {
            console.log('–ü–æ–∫–∞–∑ –ø–æ–ø–∞–ø–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –º–µ—Ç–∫–∏:', index);
            const feature = userPointsData.features[index];
            if (!feature) {
                console.error('–ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É:', index);
                return;
            }
            
            document.getElementById('edit-point-name').value = feature.properties?.name || '';
            document.getElementById('edit-point-comment').value = feature.properties?.comment || '';
            document.getElementById('edit-point-overlay').style.display = 'flex';
        }
        
        function hideEditPointPopup() {
            document.getElementById('edit-point-overlay').style.display = 'none';
            document.getElementById('edit-point-name').value = '';
            document.getElementById('edit-point-comment').value = '';
        }
        
        function addUserPoint() {
            const name = document.getElementById('point-name').value.trim();
            const comment = document.getElementById('point-comment').value.trim();
            
            if (!name) {
                showCustomAlert('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
                return;
            }
            
            if (!pendingPointCoords) {
                showCustomAlert('–û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã');
                return;
            }
            
            const newFeature = {
                type: "Feature",
                geometry: {
                    type: "Point",
                    coordinates: pendingPointCoords
                },
                properties: {
                    name: name,
                    comment: comment,
                    created: new Date().toISOString()
                }
            };
            
            userPointsData.features.push(newFeature);
            saveUserPoints();
            
            if (userPointsLayerVisible) {
                displayUserPoints();
            }
            
            showCustomAlert(`–ú–µ—Ç–∫–∞ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`);
            hideAddPointPopup();
            
            // –û–°–¢–ê–í–õ–Ø–ï–ú –†–ï–ñ–ò–ú –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ú–ï–¢–û–ö –ê–ö–¢–ò–í–ù–´–ú
            document.getElementById('status').textContent = '–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π –º–µ—Ç–∫–∏ (–∫—É—Ä—Å–æ—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∏–µ)';
        }
        
        function updateUserPoint() {
            if (selectedPointIndex === null) return;
            
            const name = document.getElementById('edit-point-name').value.trim();
            const comment = document.getElementById('edit-point-comment').value.trim();
            
            if (!name) {
                showCustomAlert('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
                return;
            }
            
            userPointsData.features[selectedPointIndex].properties.name = name;
            userPointsData.features[selectedPointIndex].properties.comment = comment;
            userPointsData.features[selectedPointIndex].properties.updated = new Date().toISOString();
            
            saveUserPoints();
            
            if (userPointsLayerVisible) {
                displayUserPoints();
            }
            
            showCustomAlert(`–ú–µ—Ç–∫–∞ "${name}" –æ–±–Ω–æ–≤–ª–µ–Ω–∞`);
            hideEditPointPopup();
            
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
            if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                userPointMarkers[selectedPointIndex].getElement().classList.remove('selected');
            }
            selectedPointIndex = null;
            document.getElementById('delete-point-btn').style.display = 'none';
        }
        
        function deleteUserPoint() {
            if (selectedPointIndex === null) return;
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–µ—Ç–∫—É?')) {
                return;
            }
            
            const pointName = userPointsData.features[selectedPointIndex].properties?.name || '–ú–µ—Ç–∫–∞';
            userPointsData.features.splice(selectedPointIndex, 1);
            saveUserPoints();
            
            if (userPointsLayerVisible) {
                displayUserPoints();
            }
            
            showCustomAlert(`–ú–µ—Ç–∫–∞ "${pointName}" —É–¥–∞–ª–µ–Ω–∞`);
            hideEditPointPopup();
            
            selectedPointIndex = null;
            document.getElementById('delete-point-btn').style.display = 'none';
        }
        
        // ==================== –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –£–î–ê–õ–ï–ù–ò–Ø –í–°–ï–• –ú–ï–¢–û–ö ====================
        function deleteAllUserPoints() {
            if (userPointsData.features.length === 0) {
                showCustomAlert('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            
            // –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            const confirmed = confirm(
                '–í–ù–ò–ú–ê–ù–ò–ï!\n\n' +
                '–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–µ—Ç–∫–∏.\n\n' +
                '–ï—Å–ª–∏ –≤—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –º–µ—Ç–∫–∏ –≤ —Ñ–∞–π–ª, –æ–Ω–∏ –±—É–¥—É—Ç —É—Ç–µ—Ä—è–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.\n\n' +
                '–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–∫–∏ —á–µ—Ä–µ–∑ –º–µ–Ω—é "–ú–µ—Ç–∫–∏" -> "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å".\n\n' +
                '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –º–µ—Ç–æ–∫?'
            );
            
            if (!confirmed) {
                return;
            }
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–µ—Ç–∫–∏
            userPointsData.features = [];
            saveUserPoints();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (userPointsLayerVisible) {
                displayUserPoints();
            }
            
            showCustomAlert(`–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–µ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω—ã (${userPointsData.features.length} –º–µ—Ç–æ–∫)`);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –±—ã–ª–æ –∞–∫—Ç–∏–≤–Ω–æ
            if (isEditMode) {
                // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                isEditMode = false;
                const editBtn = document.getElementById('edit-points-btn');
                editBtn.classList.remove('active');
                document.getElementById('map').classList.remove('add-point-cursor');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                selectedPointIndex = null;
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–µ—Ç–∫–∏
                document.getElementById('delete-point-btn').style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
                updateMarkersForEditMode();
                
                document.getElementById('status').textContent = '–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.';
            }
        }
        
        function saveUserPointsToFile() {
            const bookmarkName = document.getElementById('bookmark-name').value.trim();
            if (!bookmarkName) {
                showCustomAlert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–æ–∫');
                return;
            }
            
            const dataStr = JSON.stringify(userPointsData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${bookmarkName.replace(/[^\w–∞-—è–ê-–Ø—ë–Å\s.-]/g, '_').replace(/\s+/g, '_')}.geojson`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showCustomAlert(`–ú–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª: ${link.download}`);
            document.getElementById('bookmark-name').value = '';
        }
        
        // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–ö–ù–ê –ü–†–û–°–ú–û–¢–†–ê –ú–ï–¢–û–ö ====================
        function updateUserPointsList() {
            const list = document.getElementById('user-points-list');
            const stats = document.querySelector('.user-points-stats .count');
            
            if (!list) return;
            
            const points = userPointsData.features;
            stats.textContent = points.length;
            
            if (points.length === 0) {
                list.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫</div>';
                return;
            }
            
            list.innerHTML = points.map((point, index) => `
                <div class="user-point-list-item" data-index="${index}">
                    <div class="point-info">
                        <span class="point-index">${index + 1}</span>
                        <div>
                            <div class="point-name">${point.properties?.name || `–ú–µ—Ç–∫–∞ ${index + 1}`}</div>
                            ${point.properties?.comment ? `<div class="point-comment">${point.properties.comment}</div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞
            document.querySelectorAll('.user-point-list-item').forEach((item, index) => {
                item.addEventListener('click', () => {
                    const point = userPointsData.features[index];
                    if (!point || !point.geometry || !point.geometry.coordinates) return;
                    
                    const coords = point.geometry.coordinates;
                    let latlng;
                    
                    if (currentMapType === 'google-satellite') {
                        latlng = epsg3857ToWgs84(coords[0], coords[1]);
                    } else {
                        latlng = [coords[1], coords[0]];
                    }
                    
                    // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Google –∫–∞—Ä—Ç —Å –∑—É–º–æ–º 20
                    let targetZoom;
                    if (currentMapType === 'google-satellite') {
                        targetZoom = 20; // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –∑—É–º –¥–ª—è Google –∫–∞—Ä—Ç
                    } else {
                        targetZoom = 3; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑—É–º –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç
                    }
                    
                    // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–æ—á–∫–µ
                    map.flyTo(latlng, targetZoom, {
                        duration: 1.5,
                        easeLinearity: 0.25
                    });
                });
            });
        }
        
        // ==================== –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–û–ò–°–ö –¢–û–ß–ï–ö ====================
        function performSearch(query) {
            const resultsContainer = document.getElementById('search-results-panel');
            resultsContainer.innerHTML = '';
            
            if (query.trim()) {
                lastSearchQuery = query.trim();
                localStorage.setItem('lastSearchQuery', lastSearchQuery);
            }
            
            if (!query.trim() || !allPointsGeoJson) {
                resultsContainer.style.display = 'none';
                return;
            }

            const q = query.trim().toLowerCase();
            const matches = [];

            allPointsGeoJson.features.forEach(feature => {
                if (feature.geometry.type !== "Point") return;
                const name = feature.properties?.Name;
                const coords = feature.geometry.coordinates;
                if (!name || !coords || coords.length < 2) return;
                
                const nameLower = name.toLowerCase();
                if (nameLower.includes(q)) {
                    let priority = 2;
                    if (nameLower === q) priority = 0;
                    else if (nameLower.startsWith(q)) priority = 1;
                    matches.push({ name, coords, priority });
                }
            });

            if (matches.length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }

            matches.sort((a, b) => {
                if (a.priority !== b.priority) return a.priority - b.priority;
                return a.name.localeCompare(b.name, 'ru');
            });

            matches.slice(0, 20).forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-result-item-panel';
                div.textContent = item.name;
                div.setAttribute('data-lng', item.coords[0]);
                div.setAttribute('data-lat', item.coords[1]);
                div.addEventListener('click', (e) => {
                    const lng = parseFloat(e.target.getAttribute('data-lng'));
                    const lat = parseFloat(e.target.getAttribute('data-lat'));
                    if (!isNaN(lng) && !isNaN(lat)) {
                        let targetLat, targetLng;
                        if (currentMapType === 'google-satellite') {
                            const wgs84Coords = epsg3857ToWgs84(lng, lat);
                            targetLat = wgs84Coords[0];
                            targetLng = wgs84Coords[1];
                        } else {
                            targetLat = lat;
                            targetLng = lng;
                        }
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
                        const currentCenter = map.getCenter();
                        const currentZoom = map.getZoom();
                        const targetZoom = currentMapType === 'google-satellite' ? 20 : 2; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑—É–º 20 –¥–ª—è Google –∫–∞—Ä—Ç
                        
                        // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–æ—á–∫–µ —Å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º
                        map.flyTo([targetLat, targetLng], targetZoom, {
                            duration: 2.5,
                            easeLinearity: 0.25
                        });

                        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                        if (searchHighlightMarker) {
                            map.removeLayer(searchHighlightMarker);
                            searchHighlightMarker = null;
                        }
                        if (searchHaloMarker) {
                            map.removeLayer(searchHaloMarker);
                            searchHaloMarker = null;
                        }
                        
                        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–ª–µ—Ç–∞
                        setTimeout(() => {
                            // –°–æ–∑–¥–∞–µ–º –æ—Ä–µ–æ–ª –≤–æ–∫—Ä—É–≥ —Ç–æ—á–∫–∏
                            searchHaloMarker = L.circleMarker([targetLat, targetLng], {
                                radius: 20,
                                color: '#0066cc',
                                fillColor: 'rgba(0, 102, 204, 0.2)',
                                weight: 1,
                                fillOpacity: 0.5,
                                className: 'search-halo'
                            }).addTo(map);
                            
                            // –°–æ–∑–¥–∞–µ–º —Å–∏–Ω–∏–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏
                            searchHighlightMarker = L.marker([targetLat, targetLng], {
                                icon: L.divIcon({
                                    className: 'search-highlight-marker',
                                    html: '<div style="background-color: #0066cc; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(0, 102, 204, 0.8);"></div>',
                                    iconSize: [24, 24],
                                    iconAnchor: [12, 12]
                                }),
                                zIndexOffset: 10000
                            }).bindPopup(`<b>${item.name}</b>`).openPopup().addTo(map);

                            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                            setTimeout(() => {
                                if (searchHighlightMarker) {
                                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º popup –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
                                    searchHighlightMarker.closePopup();
                                    map.removeLayer(searchHighlightMarker);
                                    searchHighlightMarker = null;
                                }
                                if (searchHaloMarker) {
                                    map.removeLayer(searchHaloMarker);
                                    searchHaloMarker = null;
                                }
                            }, 10000);
                        }, 2500);

                        toggleSearchPanel();
                    }
                });
                resultsContainer.appendChild(div);
            });

            resultsContainer.style.display = 'block';
        }
        
        function toggleSearchPanel() {
            const searchPanel = document.getElementById('search-panel');
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results-panel');

            if (!searchPanelVisible) {
                if (!allPointsGeoJson) {
                    showCustomAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞");
                    return;
                }

                searchPanel.style.display = 'block';
                searchPanelVisible = true;
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';

                lastSearchQuery = localStorage.getItem('lastSearchQuery') || '';
                searchInput.value = lastSearchQuery;

                setTimeout(() => {
                    searchInput.focus();
                    setTimeout(() => {
                        if (lastSearchQuery) {
                            searchInput.setSelectionRange(0, lastSearchQuery.length);
                        }
                    }, 10);
                }, 50);

                if (lastSearchQuery) {
                    performSearch(lastSearchQuery);
                }
            } else {
                searchPanel.style.display = 'none';
                searchPanelVisible = false;
                searchInput.value = '';
                searchResults.style.display = 'none';
            }
        }

        function showSearchPointsPopup() {
            toggleSearchPanel();
        }

        function goToPoint(point) {
            if (!point) return;
            
            const [x, y] = point.coords;
            let latlng;
            
            if (currentMapType === 'google-satellite') {
                latlng = epsg3857ToWgs84(x, y);
            } else {
                latlng = [y, x];
            }
            
            // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Google –∫–∞—Ä—Ç
            let targetZoom;
            if (currentMapType === 'google-satellite') {
                targetZoom = 20; // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –∑—É–º –¥–ª—è Google –∫–∞—Ä—Ç
            } else {
                targetZoom = 0;
            }
            
            // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–æ—á–∫–µ
            map.flyTo(latlng, targetZoom, {
                duration: 2.5,
                easeLinearity: 0.25
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç–æ—á–∫–∏
            const marker = L.marker(latlng).addTo(map)
                .bindPopup(`<b>${point.name}</b>`)
                .openPopup();
            
            // –£–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                map.removeLayer(marker);
            }, 5000);
            
            document.getElementById('status').textContent = `–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–æ—á–∫–µ: ${point.name}`;
        }
        
        // ==================== –°–û–•–†–ê–ù–ï–ù–ò–ï/–ó–ê–ì–†–£–ó–ö–ê ====================
        function saveRoute() {
            const routeName = document.getElementById('route-name').value.trim();
            if (!routeName) {
                showCustomAlert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –º–∞—Ä—à—Ä—É—Ç–∞');
                return;
            }
            
            if (selectedPoints.length < 2) {
                showCustomAlert('–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏');
                return;
            }
            
            const routeData = {
                name: routeName,
                points: selectedPoints,
                date: new Date().toISOString(),
                distance: calculateTotalDistance()
            };
            
            let savedRoutes = JSON.parse(localStorage.getItem('userRoutes') || '[]');
            savedRoutes.push(routeData);
            localStorage.setItem('userRoutes', JSON.stringify(savedRoutes));
            
            const dataStr = JSON.stringify(routeData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${routeName.replace(/[^\w–∞-—è–ê-–Ø—ë–Å\s.-]/g, '_').replace(/\s+/g, '_')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showCustomAlert(`–ú–∞—Ä—à—Ä—É—Ç "${routeName}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω`);
            document.getElementById('route-name').value = '';
        }
        
        function calculateTotalDistance() {
            let total = 0;
            for (let i = 0; i < selectedPoints.length - 1; i++) {
                total += calculateRealDistance(selectedPoints[i], selectedPoints[i + 1]);
            }
            return total;
        }
        
        function loadRouteFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.points || !Array.isArray(data.points)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    
                    clearRoute();
                    selectedPoints = data.points.map(pt => [...pt]);
                    
                    selectedPoints.forEach((pt, idx) => {
                        const fillColor = idx === 0 ? 'green' : idx === selectedPoints.length - 1 ? 'blue' : 'red';
                        const marker = L.circle([pt[1], pt[0]], {
                            radius: 3,
                            color: 'white',
                            fillColor: fillColor,
                            weight: 2,
                            fillOpacity: 1,
                            className: 'route-point-marker route-point-marker-enlarged'
                        }).addTo(map);
                        pointMarkers.push(marker);
                    });
                    
                    buildFullRoute();
                    showCustomAlert(`–ú–∞—Ä—à—Ä—É—Ç "${data.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}" –∑–∞–≥—Ä—É–∂–µ–Ω`);
                } catch (error) {
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function loadUserPointsFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.type !== 'FeatureCollection') throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç GeoJSON');
                    
                    userPointsData = data;
                    saveUserPoints();
                    
                    if (userPointsLayerVisible) displayUserPoints();
                    showCustomAlert('–ú–µ—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                } catch (error) {
                    showCustomAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // ==================== –í–ò–ó–£–ê–õ–¨–ù–ê–Ø –û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨ –ü–†–ò –ù–ê–í–ï–î–ï–ù–ò–ò –ù–ê –°–ï–ì–ú–ï–ù–¢ ====================
        function setupRouteSegmentHover() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ –ø–æ –∫–∞—Ä—Ç–µ
            map.on('mousemove', function(e) {
                if (currentMapType === 'google-satellite' || routeLocked || isUserPointsMode || isEditMode) {
                    // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                    if (hoverSegmentLine) {
                        map.removeLayer(hoverSegmentLine);
                        hoverSegmentLine = null;
                        document.getElementById('map').style.cursor = '';
                    }
                    return;
                }
                
                const click = [e.latlng.lng, e.latlng.lat];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–∞–¥ —Å–µ–≥–º–µ–Ω—Ç–æ–º –º–∞—Ä—à—Ä—É—Ç–∞
                if (fullRoutePath.length > 1) {
                    const nearestSegment = findNearestRouteSegment(click, 8);
                    
                    if (nearestSegment && nearestSegment.distance <= 8) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–µ–≥–º–µ–Ω—Ç–∞
                        if (!hoverSegmentLine) {
                            hoverSegmentLine = L.polyline([
                                [nearestSegment.start[1], nearestSegment.start[0]],
                                [nearestSegment.end[1], nearestSegment.end[0]]
                            ], {
                                color: '#FFFF00',
                                weight: 8,
                                opacity: 0.5,
                                dashArray: '5, 5',
                                className: 'route-segment-hover',
                                interactive: false
                            }).addTo(map);
                            
                            // –ú–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä
                            document.getElementById('map').style.cursor = 'pointer';
                        } else {
                            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                            hoverSegmentLine.setLatLngs([
                                [nearestSegment.start[1], nearestSegment.start[0]],
                                [nearestSegment.end[1], nearestSegment.end[0]]
                            ]);
                        }
                        return;
                    }
                }
                
                // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
                if (hoverSegmentLine) {
                    map.removeLayer(hoverSegmentLine);
                    hoverSegmentLine = null;
                    document.getElementById('map').style.cursor = '';
                    
                    // –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –°–û–û–ë–©–ï–ù–ò–ï –í –°–¢–ê–¢–£–°–ï –¢–û–õ–¨–ö–û –ï–°–õ–ò –ï–°–¢–¨ –¢–û–ß–ö–ò
                    if (selectedPoints.length === 0) {
                        document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å—Ö–µ–º—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ—á–µ–∫.';
                    } else if (selectedPoints.length === 1) {
                        document.getElementById('status').textContent = '–í—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ç–æ—Ä—É—é.';
                    } else {
                        document.getElementById('status').textContent = '–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω. –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç.';
                    }
                }
            });
            
            // –û—á–∏—â–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø—Ä–∏ —É—Ö–æ–¥–µ –º—ã—à–∏ —Å –∫–∞—Ä—Ç—ã
            document.getElementById('map').addEventListener('mouseleave', function() {
                if (hoverSegmentLine) {
                    map.removeLayer(hoverSegmentLine);
                    hoverSegmentLine = null;
                    document.getElementById('map').style.cursor = '';
                }
            });
        }
        
        // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –ö–ê–†–¢ ====================
        function setupMapClickHandler() {
            map.off('click', handleMapClick); // –°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–∞–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            
            if (currentMapType !== 'google-satellite' && !routeLocked) {
                map.on('click', handleMapClick);
            }
        }
        
        function rebuildRouteAfterMapSwitch() {
            if (selectedPoints.length < 2) return;
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            clearAllRouteMarkers();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã —Ç–æ—á–µ–∫
            selectedPoints.forEach((pt, idx) => {
                const fillColor = idx === 0 ? 'green' : idx === selectedPoints.length - 1 ? 'blue' : 'red';
                const marker = L.circle([pt[1], pt[0]], {
                    radius: 3,
                    color: 'white',
                    fillColor: fillColor,
                    weight: 2,
                    fillOpacity: 1,
                    className: 'route-point-marker route-point-marker-enlarged'
                }).addTo(map);
                pointMarkers.push(marker);
            });
            
            // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
            buildFullRoute();
        }
        
        function switchMapLayer(mapType) {
            if (currentMapType === mapType) return;
            currentMapType = mapType;

            showLoadingOverlay("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã...");
            
            const wasKpVisible = kpLayerVisible;
            const wasUserPointsVisible = userPointsLayerVisible;
            const wasAllEdgesVisible = allEdgesLayerVisible;
            const wasDangerVisible = dangerLayerVisible;
            const wasEditMode = isEditMode;
            const wasAddMode = isUserPointsMode;
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
            const savedSelectedPoints = [...selectedPoints]; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
            const savedPointMarkers = [...pointMarkers]; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä—ã
            const savedFullRoutePath = [...fullRoutePath]; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å –º–∞—Ä—à—Ä—É—Ç–∞
            
            if (entranceMarker) map.removeLayer(entranceMarker);
            if (currentImageOverlay) map.removeLayer(currentImageOverlay);
            if (googleSatelliteLayer) map.removeLayer(googleSatelliteLayer);
            if (kpLayer) map.removeLayer(kpLayer);
            if (userPointsLayer) map.removeLayer(userPointsLayer);
            if (allEdgesLayer) map.removeLayer(allEdgesLayer);
            if (dangerLayer) map.removeLayer(dangerLayer);
            if (routeLayer) map.removeLayer(routeLayer);
            
            // –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É –¥–ª–∏–Ω—ã –º–∞—Ä—à—Ä—É—Ç–∞
            if (routeLengthLabelMarker) {
                map.removeLayer(routeLengthLabelMarker);
                routeLengthLabelMarker = null;
            }
            
            entranceMarker = currentImageOverlay = googleSatelliteLayer = null;

            if (mapType === 'google-satellite') {
                map.options.crs = L.CRS.EPSG3857;
                map.options.minZoom = 10;
                map.options.maxZoom = 21;

                googleSatelliteLayer = L.tileLayer('https://mt{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                    maxZoom: 21,
                    minZoom: 10,
                    subdomains: ['0','1','2','3'],
                    attribution: false
                }).addTo(map);

                setTimeout(() => {
                    addEntranceMarker();
                    const [x, y] = ENTRANCE_COORDS_EPSG3857;
                    const [lat, lng] = epsg3857ToWgs84(x, y);
                    map.setView([lat, lng], 17);

                    updateControlsVisibility();
                    
                    if (wasKpVisible) toggleKPLayer();
                    if (wasUserPointsVisible && userPointsData.features.length > 0) displayUserPoints();
                    if (wasAllEdgesVisible) toggleAllEdgesLayer();
                    if (wasDangerVisible) toggleDangerLayer();
                    if (wasAddMode) {
                        isUserPointsMode = true;
                        document.getElementById('add-point-btn').classList.add('active');
                        document.getElementById('map').classList.add('add-point-cursor');
                    }
                    if (wasEditMode) {
                        isEditMode = true;
                        document.getElementById('edit-points-btn').classList.add('active');
                        document.getElementById('map').classList.add('add-point-cursor');
                    }
                    
                    // –°–Ω–∏–º–∞–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –¥–ª—è Google –∫–∞—Ä—Ç
                    map.off('click', handleMapClick);
                    // –ù–∞ Google –∫–∞—Ä—Ç–∞—Ö –Ω–µ —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç—ã
                    document.getElementById('lock-btn-google').disabled = true;
                    document.getElementById('lock-btn').disabled = true;
                    
                    setTimeout(() => updateMarkersVisibilityForCurrentMap(), 100);
                    hideLoadingOverlay();
                }, 100);
            } else {
                map.options.crs = L.CRS.Simple;
                map.options.minZoom = -2;
                map.options.maxZoom = 4;
                
                updateControlsVisibility();
                
                if (!mapBounds) mapBounds = [[0, 0], [1000, 1000]];
                currentImageOverlay = L.imageOverlay(mapType, mapBounds, { opacity: 1 }).addTo(map);

                setTimeout(() => {
                    addEntranceMarker();
                    const centerX = (mapBounds[0][1] + mapBounds[1][1]) / 2;
                    const centerY = (mapBounds[0][0] + mapBounds[1][0]) / 2;
                    map.setView([centerY, centerX], -1);

                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç –µ—Å–ª–∏ –æ–Ω –±—ã–ª
                    selectedPoints = [...savedSelectedPoints];
                    pointMarkers = [...savedPointMarkers];
                    fullRoutePath = [...savedFullRoutePath];
                    
                    if (selectedPoints.length > 1) {
                        // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
                        rebuildRouteAfterMapSwitch();
                    }
                    
                    if (wasKpVisible) toggleKPLayer();
                    if (wasUserPointsVisible && userPointsData.features.length > 0) displayUserPoints();
                    if (wasAllEdgesVisible) toggleAllEdgesLayer();
                    if (wasDangerVisible) toggleDangerLayer();
                    
                    if (wasEditMode && wasUserPointsVisible) {
                        isEditMode = true;
                        document.getElementById('edit-points-btn').classList.add('active');
                        document.getElementById('map').classList.add('add-point-cursor');
                    }
                    if (wasAddMode) {
                        isUserPointsMode = true;
                        document.getElementById('add-point-btn').classList.add('active');
                        document.getElementById('map').classList.add('add-point-cursor');
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ä—Ç –µ—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
                    setupMapClickHandler();
                    document.getElementById('lock-btn').disabled = false;
                    
                    setTimeout(() => updateMarkersVisibilityForCurrentMap(), 100);
                    hideLoadingOverlay();
                }, 100);
            }
        }
        
        // ==================== –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í ====================
        function checkMobileDevice() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–±–∏–ª—å–Ω—ã–º
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
            if ((isMobile || isTouchDevice) && !mobileWarningShown) {
                const warningElement = document.getElementById('mobile-warning');
                const timerElement = document.getElementById('timer-count');
                const closeButton = document.getElementById('mobile-warning-close');
                
                warningElement.style.display = 'flex';
                mobileWarningShown = true;
                
                // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
                let secondsLeft = 10;
                const timerInterval = setInterval(() => {
                    secondsLeft--;
                    timerElement.textContent = secondsLeft;
                    
                    if (secondsLeft <= 0) {
                        clearInterval(timerInterval);
                        warningElement.style.display = 'none';
                    }
                }, 1000);
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ
                closeButton.addEventListener('click', () => {
                    clearInterval(timerInterval);
                    warningElement.style.display = 'none';
                });
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
                warningElement.addEventListener('click', (e) => {
                    if (e.target.id === 'mobile-warning') {
                        clearInterval(timerInterval);
                        warningElement.style.display = 'none';
                    }
                });
            }
        }
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        async function initializeMap() {
            document.getElementById('status').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã...';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
            checkMobileDevice();
            
            try {
                const fileChecks = await Promise.allSettled(
                    REQUIRED_FILES.map(file => fetch(file))
                );
                
                const missingFiles = [];
                fileChecks.forEach((result, index) => {
                    if (result.status === 'rejected') missingFiles.push(REQUIRED_FILES[index]);
                });
                
                if (missingFiles.length > 0) {
                    console.warn('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ñ–∞–π–ª—ã:', missingFiles);
                    showCustomAlert(`–í–Ω–∏–º–∞–Ω–∏–µ: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã: ${missingFiles.join(', ')}`);
                }
                
                await loadTunnelsData();
                allPointsGeoJson = await loadGeoJsonFile('points_json.geojson');
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é –¥–ª–∏–Ω—É —à—Ç—Ä–µ–∫–æ–≤
                calculateTotalTunnelLength();
                
                if (segments.length === 0) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç—É–Ω–Ω–µ–ª–µ–π');
                
                currentImageOverlay = L.imageOverlay('byaki.png', mapBounds, { opacity: 1 }).addTo(map);
                addEntranceMarker();
                
                const centerX = (mapBounds[0][1] + mapBounds[1][1]) / 2;
                const centerY = (mapBounds[0][0] + mapBounds[1][0]) / 2;
                map.setView([centerY, centerX], -1);
                
                loadUserPoints();
                updateControlsVisibility();
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º hover –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –º–∞—Ä—à—Ä—É—Ç–∞
                setupRouteSegmentHover();
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤
                setupMapClickHandler();
                
                document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å—Ö–µ–º—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ—á–µ–∫.';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã';
                showCustomAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã: ${error.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ.`);
                
                mapBounds = [[0, 0], [1000, 1000]];
                currentImageOverlay = L.imageOverlay('byaki.png', mapBounds, { opacity: 0.5 }).addTo(map);
            }
        }
        
        // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ====================
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('dropdown-menu');
                const menuBtn = document.getElementById('menu-button');
                const searchPanel = document.getElementById('search-panel');
                const userPointsPanel = document.getElementById('user-points-panel');
                const pointsControlsContainer = document.getElementById('points-controls-container');
                
                if (menuOpen && !dropdown.contains(e.target) && !menuBtn.contains(e.target)) {
                    menuOpen = false;
                    dropdown.classList.remove('active');
                }
                
                if (searchPanelVisible && !searchPanel.contains(e.target) && e.target.id !== 'search-points-btn') {
                    toggleSearchPanel();
                }
                
                // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê: –æ–∫–Ω–æ –º–µ—Ç–æ–∫ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ó–∞–∫—Ä—ã—Ç—å" –∏–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞
                // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ, –µ—Å–ª–∏ —Ä–µ–∂–∏–º –º–µ—Ç–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω
                // –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏ —Å–¥–≤–∏–≥–µ –∫–∞—Ä—Ç—ã
                if (userPointsPanel && userPointsPanel.style.display === 'block' && 
                    userPointsPanel.contains(e.target) && e.target.id === 'close-points-panel') {
                    toggleUserPointsLayer(); // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ó–∞–∫—Ä—ã—Ç—å"
                }
            });
            
            document.getElementById('menu-button').addEventListener('click', (e) => {
                e.stopPropagation();
                menuOpen = !menuOpen;
                document.getElementById('dropdown-menu').classList.toggle('active', menuOpen);
            });
            
            document.getElementById('zoom-in').addEventListener('click', () => map.getZoom() < map.getMaxZoom() && map.zoomIn());
            document.getElementById('zoom-out').addEventListener('click', () => map.getZoom() > map.getMinZoom() && map.zoomOut());
            map.on('zoomend', onZoomEnd);
            
            // –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –í–´–ë–û–†–ê –ö–ê–†–¢–´ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–µ–Ω—é)
            document.getElementById('background-select').addEventListener('change', (e) => {
                switchMapLayer(e.target.value);
                menuOpen = false;
                document.getElementById('dropdown-menu').classList.remove('active');
            });
            
            const setupButton = (id, handler) => document.getElementById(id).addEventListener('click', (e) => {
                e.stopPropagation();
                handler();
            });
            
            setupButton('save-route', saveRoute);
            setupButton('load-route', () => document.getElementById('route-file-input').click());
            setupButton('save-bookmark', saveUserPointsToFile);
            setupButton('load-bookmark', () => document.getElementById('bookmark-file-input').click());
            setupButton('clear-route-btn', clearRoute);
            setupButton('show-route-points-btn', toggleRoutePointsPopup);
            setupButton('undo-btn', undoLastPoint);
            setupButton('undo-btn-google', undoLastPoint);
            setupButton('kp-layer-btn', toggleKPLayer);
            setupButton('kp-layer-btn-google', toggleKPLayer);
            setupButton('danger-layer-btn', toggleDangerLayer);
            setupButton('danger-layer-btn-google', toggleDangerLayer);
            setupButton('points-layer-btn', toggleUserPointsLayer);
            setupButton('all-edges-btn', toggleAllEdgesLayer);
            setupButton('add-point-btn', startAddPointMode);
            setupButton('edit-points-btn', startEditMode);
            setupButton('delete-point-btn', deleteUserPoint);
            setupButton('delete-all-points-btn', deleteAllUserPoints);
            setupButton('add-point-cancel', () => {
                hideAddPointPopup();
                // –ù–ï –°–ë–†–ê–°–´–í–ê–ï–ú –†–ï–ñ–ò–ú - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ –º–µ—Ç–∫–∏
                if (isUserPointsMode) {
                    document.getElementById('status').textContent = '–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π –º–µ—Ç–∫–∏ (–∫—É—Ä—Å–æ—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∏–µ)';
                }
            });
            setupButton('add-point-save', addUserPoint);
            setupButton('edit-point-cancel', () => {
                hideEditPointPopup();
                if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                    userPointMarkers[selectedPointIndex].getElement().classList.remove('selected');
                }
                selectedPointIndex = null;
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–µ—Ç–∫–∏
                document.getElementById('delete-point-btn').style.display = 'none';
            });
            setupButton('edit-point-delete', deleteUserPoint);
            setupButton('edit-point-save', updateUserPoint);
            setupButton('show-disclaimer', () => document.getElementById('disclaimer-overlay').style.display = 'flex');
            setupButton('close-disclaimer', () => document.getElementById('disclaimer-overlay').style.display = 'none');
            setupButton('search-points-btn', showSearchPointsPopup);
            setupButton('close-points-panel', () => {
                document.getElementById('user-points-panel').style.display = 'none';
                toggleUserPointsLayer();
            });
            
            const toggleLock = () => {
                routeLocked = !routeLocked;
                const lockBtn = document.getElementById('lock-btn');
                const lockBtnGoogle = document.getElementById('lock-btn-google');
                lockBtn.textContent = routeLocked ? 'üîí' : 'üîì';
                
                if (routeLocked) {
                    map.off('click', handleMapClick);
                    if (currentMapType === 'google-satellite') {
                        document.getElementById('status').textContent = '–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ—è–º–∏.';
                    } else {
                        document.getElementById('status').textContent = '–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ';
                    }
                } else {
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã
                    setupMapClickHandler();
                    if (currentMapType !== 'google-satellite') {
                        document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞';
                    }
                }
            };
            
            document.getElementById('lock-btn').addEventListener('click', toggleLock);
            document.getElementById('lock-btn-google').addEventListener('click', toggleLock);
            
            document.getElementById('add-point-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'add-point-overlay') {
                    hideAddPointPopup();
                    // –ù–ï –°–ë–†–ê–°–´–í–ê–ï–ú –†–ï–ñ–ò–ú - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ –º–µ—Ç–∫–∏
                    if (isUserPointsMode) {
                        document.getElementById('status').textContent = '–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π –º–µ—Ç–∫–∏ (–∫—É—Ä—Å–æ—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∏–µ)';
                    }
                }
            });
            
            document.getElementById('edit-point-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'edit-point-overlay') {
                    hideEditPointPopup();
                    if (selectedPointIndex !== null && userPointMarkers[selectedPointIndex]) {
                        userPointMarkers[selectedPointIndex].getElement().classList.remove('selected');
                    }
                    selectedPointIndex = null;
                    document.getElementById('delete-point-btn').style.display = 'none';
                }
            });
            
            document.getElementById('disclaimer-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'disclaimer-overlay') {
                    document.getElementById('disclaimer-overlay').style.display = 'none';
                }
            });
            
            document.getElementById('route-file-input').addEventListener('change', (e) => {
                if (e.target.files.length > 0) loadRouteFromFile(e.target.files[0]);
            });
            
            document.getElementById('bookmark-file-input').addEventListener('change', (e) => {
                if (e.target.files.length > 0) loadUserPointsFromFile(e.target.files[0]);
            });
            
            document.getElementById('search-input').addEventListener('input', (e) => performSearch(e.target.value));
            document.getElementById('search-input').addEventListener('keypress', (e) => e.key === 'Enter' && performSearch(e.target.value));
            document.getElementById('search-input').addEventListener('keydown', (e) => e.key === 'Escape' && toggleSearchPanel());
        });
    </script>
</body>
</html>
